<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link
      rel="stylesheet"
      href="/docs__simple-course__devops__02.Docker入门.md.chunk.css"
    />
    <script>
      window.routerBase = "/";
    </script>
    <script>
      //! umi version: 3.5.40
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>慕课 - Docker入门 - Wuxiao.io's Blog</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/simple-course/devops/02" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" href="/">Wuxiao.io&#x27;s Blog</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a aria-current="page" class="active" href="/simple-course">Draft</a></span><span><a href="/sets">Sets</a></span><span><a href="/poc">Poc</a></span><span><a href="/deep-learn">Deep Learn</a></span><span><a href="/tech-product">Tech Product</a></span><span><a href="/solution">Solution</a></span><span><a href="/best">Practice</a></span><span><a href="/awesome">Awesome</a></span><span><a href="/efficiency">Efficiency</a></span><span><a href="/wiki">Wiki</a></span><span><a href="/backlog">Backlog</a></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" href="/"></a><h1>Wuxiao.io&#x27;s Blog</h1><p>架构|思路|效率</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a aria-current="page" class="active" href="/simple-course">Draft</a></li><li><a href="/sets">Sets</a></li><li><a href="/poc">Poc</a></li><li><a href="/deep-learn">Deep Learn</a></li><li><a href="/tech-product">Tech Product</a></li><li><a href="/solution">Solution</a></li><li><a href="/best">Practice</a></li><li><a href="/awesome">Awesome</a></li><li><a href="/efficiency">Efficiency</a></li><li><a href="/wiki">Wiki</a></li><li><a href="/backlog">Backlog</a></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/simple-course">Draft</a></li><li><a aria-current="page" class="active" href="/simple-course/devops">Devops</a><ul><li><a href="/simple-course/devops/01"><span>Docker</span></a></li><li><a aria-current="page" class="active" href="/simple-course/devops/02"><span>慕课 - Docker入门</span></a></li></ul></li><li><a href="/simple-course/fe">Fe</a><ul><li><a href="/simple-course/fe/01"><span>React18</span></a></li><li><a href="/simple-course/fe/02"><span>PostgreSQL</span></a></li><li><a href="/simple-course/fe/03"><span>Sequelize</span></a></li><li><a href="/simple-course/fe/04"><span>Lerna</span></a></li><li><a href="/simple-course/fe/05"><span>vite</span></a></li><li><a href="/simple-course/fe/06"><span>CSS Skill</span></a></li><li><a href="/simple-course/fe/07"><span>React Fiber</span></a></li><li><a href="/simple-course/fe/08"><span>RxJS</span></a></li><li><a href="/simple-course/fe/10"><span>前端监控系统</span></a></li><li><a href="/simple-course/fe/11"><span>微前端（v0.0.1）</span></a></li><li><a href="/simple-course/fe/12"><span>yargs(WIP)</span></a></li><li><a href="/simple-course/fe/13"><span>chalk</span></a></li><li><a href="/simple-course/fe/14"><span>Inquirer.js</span></a></li><li><a href="/simple-course/fe/15"><span>Lerna</span></a></li><li><a href="/simple-course/fe/16"><span>Gatsby</span></a></li><li><a href="/simple-course/fe/17"><span>cpx</span></a></li><li><a href="/simple-course/fe/18"><span>core-js</span></a></li><li><a href="/simple-course/fe/19"><span>esbuild</span></a></li><li><a href="/simple-course/fe/21"><span>Babel</span></a></li><li><a href="/simple-course/fe/25"><span>AST</span></a></li><li><a href="/simple-course/fe/27"><span>React</span></a></li><li><a href="/simple-course/fe/28"><span>TCP</span></a></li><li><a href="/simple-course/fe/30"><span>TypeScript类型体操</span></a></li><li><a href="/simple-course/fe/31"><span>NX</span></a></li><li><a href="/simple-course/fe/32"><span>Systemjs</span></a></li><li><a href="/simple-course/fe/33"><span>English Grammer</span></a></li><li><a href="/simple-course/fe/34"><span>Type Challenge</span></a></li><li><a href="/simple-course/fe/36"><span>Web3.0 Roadmap</span></a></li><li><a href="/simple-course/fe/37"><span>6个新的JavaScript新特性</span></a></li><li><a href="/simple-course/fe/38"><span>FE tools need to know</span></a></li><li><a href="/simple-course/fe/39.bun"><span>Bun</span></a></li><li><a href="/simple-course/fe/41"><span>React</span></a></li></ul></li><li><a href="/simple-course/java">Java</a><ul><li><a href="/simple-course/java/01"><span>Maven</span></a></li><li><a href="/simple-course/java/02"><span>Redis</span></a></li><li><a href="/simple-course/java/03"><span>Zookeeper</span></a></li><li><a href="/simple-course/java/04"><span>Spring Boot</span></a></li></ul></li><li><a href="/simple-course/note">Note</a><ul><li><a href="/simple-course/note/01"><span>Udemy - Rust</span></a></li><li><a href="/simple-course/note/02"><span>Udemy - Master English Phrasal Verbs</span></a></li></ul></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="1.1 容器技术介绍" data-depth="2"><a href="/simple-course/devops/02#11-容器技术介绍"><span>1.1 容器技术介绍</span></a></li><li title="什么是Container(容器)?" data-depth="3"><a href="/simple-course/devops/02#什么是container容器"><span>什么是Container(容器)?</span></a></li><li title="容器的快速发展和普及" data-depth="3"><a href="/simple-course/devops/02#容器的快速发展和普及"><span>容器的快速发展和普及</span></a></li><li title="容器的标准化" data-depth="3"><a href="/simple-course/devops/02#容器的标准化"><span>容器的标准化</span></a></li><li title="容器是关乎速度" data-depth="3"><a href="/simple-course/devops/02#容器是关乎速度"><span>容器是关乎速度</span></a></li><li title="2.1. Docker CLI 命令行介绍" data-depth="2"><a href="/simple-course/devops/02#21-docker-cli-命令行介绍"><span>2.1. Docker CLI 命令行介绍</span></a></li><li title="2.2 Image vs Container 镜像 vs 容器" data-depth="2"><a href="/simple-course/devops/02#22-image-vs-container-镜像-vs-容器"><span>2.2 Image vs Container 镜像 vs 容器</span></a></li><li title="image 镜像" data-depth="3"><a href="/simple-course/devops/02#image-镜像"><span>image 镜像</span></a></li><li title="container容器" data-depth="3"><a href="/simple-course/devops/02#container容器"><span>container容器</span></a></li><li title="docker image的获取" data-depth="3"><a href="/simple-course/devops/02#docker-image的获取"><span>docker image的获取</span></a></li><li title="2.3 容器的基本操作" data-depth="2"><a href="/simple-course/devops/02#23-容器的基本操作"><span>2.3 容器的基本操作</span></a></li><li title="2.4 docker container 命令小技巧" data-depth="2"><a href="/simple-course/devops/02#24-docker-container-命令小技巧"><span>2.4 docker container 命令小技巧</span></a></li><li title="批量停止" data-depth="3"><a href="/simple-course/devops/02#批量停止"><span>批量停止</span></a></li><li title="批量删除" data-depth="3"><a href="/simple-course/devops/02#批量删除"><span>批量删除</span></a></li><li title="2.5 连接容器的 shell" data-depth="2"><a href="/simple-course/devops/02#25-连接容器的-shell"><span>2.5 连接容器的 shell</span></a></li><li title="2.6 容器和虚拟机 Container vs VM" data-depth="2"><a href="/simple-course/devops/02#26-容器和虚拟机-container-vs-vm"><span>2.6 容器和虚拟机 Container vs VM</span></a></li><li title="容器不是Mini虚拟机" data-depth="3"><a href="/simple-course/devops/02#容器不是mini虚拟机"><span>容器不是Mini虚拟机</span></a></li><li title="容器的进程process" data-depth="3"><a href="/simple-course/devops/02#容器的进程process"><span>容器的进程process</span></a></li><li title="2.7 docker container run 背后发生了什么？" data-depth="2"><a href="/simple-course/devops/02#27-docker-container-run-背后发生了什么"><span>2.7 docker container run 背后发生了什么？</span></a></li><li title="3.1. 镜像的获取" data-depth="2"><a href="/simple-course/devops/02#31-镜像的获取"><span>3.1. 镜像的获取</span></a></li><li title="3.2 镜像的基本操作" data-depth="2"><a href="/simple-course/devops/02#32-镜像的基本操作"><span>3.2 镜像的基本操作</span></a></li><li title="镜像的拉取 Pull Image" data-depth="3"><a href="/simple-course/devops/02#镜像的拉取-pull-image"><span>镜像的拉取 Pull Image</span></a></li><li title="镜像查看" data-depth="3"><a href="/simple-course/devops/02#镜像查看"><span>镜像查看</span></a></li><li title="镜像的删除" data-depth="3"><a href="/simple-course/devops/02#镜像的删除"><span>镜像的删除</span></a></li><li title="3.3 关于 scratch 镜像" data-depth="2"><a href="/simple-course/devops/02#33-关于-scratch-镜像"><span>3.3 关于 scratch 镜像</span></a></li><li title="4.1 基础镜像的选择（FROM）" data-depth="2"><a href="/simple-course/devops/02#41-基础镜像的选择from"><span>4.1 基础镜像的选择（FROM）</span></a></li><li title="基本原则" data-depth="3"><a href="/simple-course/devops/02#基本原则"><span>基本原则</span></a></li><li title="Build一个Nginx镜像" data-depth="3"><a href="/simple-course/devops/02#build一个nginx镜像"><span>Build一个Nginx镜像</span></a></li><li title="4.2 通过 RUN 执行指令" data-depth="2"><a href="/simple-course/devops/02#42-通过-run-执行指令"><span>4.2 通过 RUN 执行指令</span></a></li><li title="Dockerfile" data-depth="3"><a href="/simple-course/devops/02#dockerfile"><span>Dockerfile</span></a></li><li title="改进版Dockerfile" data-depth="3"><a href="/simple-course/devops/02#改进版dockerfile"><span>改进版Dockerfile</span></a></li><li title="4.3 文件复制和目录操作 (ADD,COPY,WORKDIR)" data-depth="2"><a href="/simple-course/devops/02#43-文件复制和目录操作-addcopyworkdir"><span>4.3 文件复制和目录操作 (ADD,COPY,WORKDIR)</span></a></li><li title="复制普通文件" data-depth="3"><a href="/simple-course/devops/02#复制普通文件"><span>复制普通文件</span></a></li><li title="复制压缩文件" data-depth="3"><a href="/simple-course/devops/02#复制压缩文件"><span>复制压缩文件</span></a></li><li title="如何选择" data-depth="3"><a href="/simple-course/devops/02#如何选择"><span>如何选择</span></a></li><li title="4.4 构建参数和环境变量 (ARG vs ENV)" data-depth="2"><a href="/simple-course/devops/02#44-构建参数和环境变量-arg-vs-env"><span>4.4 构建参数和环境变量 (ARG vs ENV)</span></a></li><li title="ENV" data-depth="3"><a href="/simple-course/devops/02#env"><span>ENV</span></a></li><li title="ARG" data-depth="3"><a href="/simple-course/devops/02#arg"><span>ARG</span></a></li><li title="区别" data-depth="3"><a href="/simple-course/devops/02#区别"><span>区别</span></a></li><li title="4.5 容器启动命令 CMD" data-depth="2"><a href="/simple-course/devops/02#45-容器启动命令-cmd"><span>4.5 容器启动命令 CMD</span></a></li><li title="4.6 容器启动命令 ENTRYPOINT" data-depth="2"><a href="/simple-course/devops/02#46-容器启动命令-entrypoint"><span>4.6 容器启动命令 ENTRYPOINT</span></a></li><li title="4.7 Shell 格式和 Exec 格式" data-depth="2"><a href="/simple-course/devops/02#47-shell-格式和-exec-格式"><span>4.7 Shell 格式和 Exec 格式</span></a></li><li title="Shell格式" data-depth="3"><a href="/simple-course/devops/02#shell格式"><span>Shell格式</span></a></li><li title="Exec格式" data-depth="3"><a href="/simple-course/devops/02#exec格式"><span>Exec格式</span></a></li><li title="4.8 一起构建一个 Python Flask 镜像" data-depth="2"><a href="/simple-course/devops/02#48-一起构建一个-python-flask-镜像"><span>4.8 一起构建一个 Python Flask 镜像</span></a></li><li title="4.9 Dockerfile 技巧——合理使用 .dockerignore" data-depth="2"><a href="/simple-course/devops/02#49-dockerfile-技巧合理使用-dockerignore"><span>4.9 Dockerfile 技巧——合理使用 .dockerignore</span></a></li><li title="什么是Docker build context" data-depth="3"><a href="/simple-course/devops/02#什么是docker-build-context"><span>什么是Docker build context</span></a></li><li title=".dockerignore 文件" data-depth="3"><a href="/simple-course/devops/02#dockerignore-文件"><span>.dockerignore 文件</span></a></li><li title="4.10 Dockerfile 技巧——镜像的多阶段构建" data-depth="2"><a href="/simple-course/devops/02#410-dockerfile-技巧镜像的多阶段构建"><span>4.10 Dockerfile 技巧——镜像的多阶段构建</span></a></li><li title="C语言例子" data-depth="3"><a href="/simple-course/devops/02#c语言例子"><span>C语言例子</span></a></li><li title="4.11 Dockerfile 技巧——尽量使用非root用户" data-depth="2"><a href="/simple-course/devops/02#411-dockerfile-技巧尽量使用非root用户"><span>4.11 Dockerfile 技巧——尽量使用非root用户</span></a></li><li title="Root的危险性" data-depth="3"><a href="/simple-course/devops/02#root的危险性"><span>Root的危险性</span></a></li><li title="如何使用非root用户" data-depth="3"><a href="/simple-course/devops/02#如何使用非root用户"><span>如何使用非root用户</span></a></li><li title="5.1 介绍" data-depth="2"><a href="/simple-course/devops/02#51-介绍"><span>5.1 介绍</span></a></li><li title="5.2 Data Volume" data-depth="2"><a href="/simple-course/devops/02#52-data-volume"><span>5.2 Data Volume</span></a></li><li title="环境准备" data-depth="3"><a href="/simple-course/devops/02#环境准备"><span>环境准备</span></a></li><li title="构建镜像" data-depth="3"><a href="/simple-course/devops/02#构建镜像"><span>构建镜像</span></a></li><li title="创建容器(不指定-v参数)" data-depth="3"><a href="/simple-course/devops/02#创建容器不指定-v参数"><span>创建容器(不指定-v参数)</span></a></li><li title="创建容器(指定-v参数)" data-depth="3"><a href="/simple-course/devops/02#创建容器指定-v参数"><span>创建容器(指定-v参数)</span></a></li><li title="环境清理" data-depth="3"><a href="/simple-course/devops/02#环境清理"><span>环境清理</span></a></li><li title="5.3 Data Volume 练习 MySQL" data-depth="2"><a href="/simple-course/devops/02#53-data-volume-练习-mysql"><span>5.3 Data Volume 练习 MySQL</span></a></li><li title="准备镜像" data-depth="3"><a href="/simple-course/devops/02#准备镜像"><span>准备镜像</span></a></li><li title="创建容器" data-depth="3"><a href="/simple-course/devops/02#创建容器"><span>创建容器</span></a></li><li title="数据库写入数据" data-depth="3"><a href="/simple-course/devops/02#数据库写入数据"><span>数据库写入数据</span></a></li><li title="5.3  多个机器之间的容器共享数据" data-depth="2"><a href="/simple-course/devops/02#53--多个机器之间的容器共享数据"><span>5.3  多个机器之间的容器共享数据</span></a></li><li title="环境准备" data-depth="3"><a href="/simple-course/devops/02#环境准备-1"><span>环境准备</span></a></li><li title="安装plugin" data-depth="3"><a href="/simple-course/devops/02#安装plugin"><span>安装plugin</span></a></li><li title="创建volume" data-depth="3"><a href="/simple-course/devops/02#创建volume"><span>创建volume</span></a></li><li title="创建容器挂载Volume" data-depth="3"><a href="/simple-course/devops/02#创建容器挂载volume"><span>创建容器挂载Volume</span></a></li><li title="6.1 网络基础知识回顾" data-depth="2"><a href="/simple-course/devops/02#61-网络基础知识回顾"><span>6.1 网络基础知识回顾</span></a></li><li title="Internet如何工作的" data-depth="3"><a href="/simple-course/devops/02#internet如何工作的"><span>Internet如何工作的</span></a></li><li title="6.2 网络常用命令" data-depth="2"><a href="/simple-course/devops/02#62-网络常用命令"><span>6.2 网络常用命令</span></a></li><li title="IP地址的查看" data-depth="3"><a href="/simple-course/devops/02#ip地址的查看"><span>IP地址的查看</span></a></li><li title="网络连通性测试" data-depth="3"><a href="/simple-course/devops/02#网络连通性测试"><span>网络连通性测试</span></a></li><li title="6.3 Docker Bridge 网络" data-depth="2"><a href="/simple-course/devops/02#63-docker-bridge-网络"><span>6.3 Docker Bridge 网络</span></a></li><li title="创建两个容器" data-depth="3"><a href="/simple-course/devops/02#创建两个容器"><span>创建两个容器</span></a></li><li title="容器间通信" data-depth="3"><a href="/simple-course/devops/02#容器间通信"><span>容器间通信</span></a></li><li title="容器对外通信" data-depth="3"><a href="/simple-course/devops/02#容器对外通信"><span>容器对外通信</span></a></li><li title="端口转发" data-depth="3"><a href="/simple-course/devops/02#端口转发"><span>端口转发</span></a></li><li title="7.1 介绍" data-depth="2"><a href="/simple-course/devops/02#71-介绍"><span>7.1 介绍</span></a></li><li title="7.2 docker compose 的安装" data-depth="2"><a href="/simple-course/devops/02#72-docker-compose-的安装"><span>7.2 docker compose 的安装</span></a></li><li title="7.3 compose 文件的结构和版本" data-depth="2"><a href="/simple-course/devops/02#73-compose-文件的结构和版本"><span>7.3 compose 文件的结构和版本</span></a></li><li title="compose 文件的结构和版本" data-depth="3"><a href="/simple-course/devops/02#compose-文件的结构和版本"><span>compose 文件的结构和版本</span></a></li><li title="基本语法结构" data-depth="3"><a href="/simple-course/devops/02#基本语法结构"><span>基本语法结构</span></a></li><li title="docker-compose 语法版本" data-depth="3"><a href="/simple-course/devops/02#docker-compose-语法版本"><span>docker-compose 语法版本</span></a></li><li title="7.4 docker compose 水平扩展" data-depth="2"><a href="/simple-course/devops/02#74-docker-compose-水平扩展"><span>7.4 docker compose 水平扩展</span></a></li><li title="环境清理" data-depth="3"><a href="/simple-course/devops/02#环境清理-1"><span>环境清理</span></a></li><li title="启动" data-depth="3"><a href="/simple-course/devops/02#启动"><span>启动</span></a></li><li title="水平扩展 scale" data-depth="3"><a href="/simple-course/devops/02#水平扩展-scale"><span>水平扩展 scale</span></a></li><li title="7.5 docker compose 环境变量" data-depth="2"><a href="/simple-course/devops/02#75-docker-compose-环境变量"><span>7.5 docker compose 环境变量</span></a></li><li title="7.6 docker compose 服务依赖和健康检查" data-depth="2"><a href="/simple-course/devops/02#76-docker-compose-服务依赖和健康检查"><span>7.6 docker compose 服务依赖和健康检查</span></a></li><li title="容器的健康检查" data-depth="3"><a href="/simple-course/devops/02#容器的健康检查"><span>容器的健康检查</span></a></li><li title="示例源码" data-depth="3"><a href="/simple-course/devops/02#示例源码"><span>示例源码</span></a></li><li title="构建镜像和创建容器" data-depth="3"><a href="/simple-course/devops/02#构建镜像和创建容器"><span>构建镜像和创建容器</span></a></li><li title="启动redis服务器" data-depth="3"><a href="/simple-course/devops/02#启动redis服务器"><span>启动redis服务器</span></a></li><li title="docker-compose 健康检查" data-depth="3"><a href="/simple-course/devops/02#docker-compose-健康检查"><span>docker-compose 健康检查</span></a></li><li title="8.1 Docker Swarm 介绍" data-depth="2"><a href="/simple-course/devops/02#81-docker-swarm-介绍"><span>8.1 Docker Swarm 介绍</span></a></li><li title="为什么不建议在生产环境中使用 docker-compose" data-depth="3"><a href="/simple-course/devops/02#为什么不建议在生产环境中使用-docker-compose"><span>为什么不建议在生产环境中使用 docker-compose</span></a></li><li title="容器编排 swarm" data-depth="3"><a href="/simple-course/devops/02#容器编排-swarm"><span>容器编排 swarm</span></a></li><li title="docker swarm vs kubernetes" data-depth="3"><a href="/simple-course/devops/02#docker-swarm-vs-kubernetes"><span>docker swarm vs kubernetes</span></a></li><li title="8.2 Swarm 单节点快速上手" data-depth="2"><a href="/simple-course/devops/02#82-swarm-单节点快速上手"><span>8.2 Swarm 单节点快速上手</span></a></li><li title="初始化" data-depth="3"><a href="/simple-course/devops/02#初始化"><span>初始化</span></a></li><li title="docker swarm init 背后发生了什么" data-depth="3"><a href="/simple-course/devops/02#docker-swarm-init-背后发生了什么"><span>docker swarm init 背后发生了什么</span></a></li><li title="8.3 Swarm 三节点集群搭建" data-depth="2"><a href="/simple-course/devops/02#83-swarm-三节点集群搭建"><span>8.3 Swarm 三节点集群搭建</span></a></li><li title="8.4 Swarm 的 overlay 网络详解" data-depth="2"><a href="/simple-course/devops/02#84-swarm-的-overlay-网络详解"><span>8.4 Swarm 的 overlay 网络详解</span></a></li><li title="创建 overlay 网络" data-depth="3"><a href="/simple-course/devops/02#创建-overlay-网络"><span>创建 overlay 网络</span></a></li><li title="创建服务" data-depth="3"><a href="/simple-course/devops/02#创建服务"><span>创建服务</span></a></li><li title="网络查看" data-depth="3"><a href="/simple-course/devops/02#网络查看"><span>网络查看</span></a></li><li title="8.5 Swarm 的 ingress网络" data-depth="2"><a href="/simple-course/devops/02#85-swarm-的-ingress网络"><span>8.5 Swarm 的 ingress网络</span></a></li><li title="service创建" data-depth="3"><a href="/simple-course/devops/02#service创建"><span>service创建</span></a></li><li title="service的访问" data-depth="3"><a href="/simple-course/devops/02#service的访问"><span>service的访问</span></a></li><li title="ingress 数据包的走向" data-depth="3"><a href="/simple-course/devops/02#ingress-数据包的走向"><span>ingress 数据包的走向</span></a></li><li title="8.6 内部负载均衡和 VIP" data-depth="2"><a href="/simple-course/devops/02#86-内部负载均衡和-vip"><span>8.6 内部负载均衡和 VIP</span></a></li><li title="8.7 部署多 service 应用" data-depth="2"><a href="/simple-course/devops/02#87-部署多-service-应用"><span>8.7 部署多 service 应用</span></a></li><li title="8.8 swarm stack 部署多 service 应用" data-depth="2"><a href="/simple-course/devops/02#88-swarm-stack-部署多-service-应用"><span>8.8 swarm stack 部署多 service 应用</span></a></li><li title="8.9 在 swarm 中使用 secret" data-depth="2"><a href="/simple-course/devops/02#89-在-swarm-中使用-secret"><span>8.9 在 swarm 中使用 secret</span></a></li><li title="创建secret" data-depth="3"><a href="/simple-course/devops/02#创建secret"><span>创建secret</span></a></li><li title="secret 的使用" data-depth="3"><a href="/simple-course/devops/02#secret-的使用"><span>secret 的使用</span></a></li><li title="8.10 swarm 使用 local volume" data-depth="2"><a href="/simple-course/devops/02#810-swarm-使用-local-volume"><span>8.10 swarm 使用 local volume</span></a></li><li title="9.1 Podman 介绍" data-depth="2"><a href="/simple-course/devops/02#91-podman-介绍"><span>9.1 Podman 介绍</span></a></li><li title="What is Podman?" data-depth="3"><a href="/simple-course/devops/02#what-is-podman"><span>What is Podman?</span></a></li><li title="9.2 和 docker 的区别" data-depth="2"><a href="/simple-course/devops/02#92-和-docker-的区别"><span>9.2 和 docker 的区别</span></a></li><li title="9.2 Podman 安装" data-depth="2"><a href="/simple-course/devops/02#92-podman-安装"><span>9.2 Podman 安装</span></a></li><li title="9.3 Podman 创建 Pod" data-depth="2"><a href="/simple-course/devops/02#93-podman-创建-pod"><span>9.3 Podman 创建 Pod</span></a></li><li title="9.4 Docker 的非 root 模式" data-depth="2"><a href="/simple-course/devops/02#94-docker-的非-root-模式"><span>9.4 Docker 的非 root 模式</span></a></li><li title="10.1 Docker的多架构支持" data-depth="2"><a href="/simple-course/devops/02#101-docker的多架构支持"><span>10.1 Docker的多架构支持</span></a></li><li title="10.2 使用 buildx 构建多架构镜像" data-depth="2"><a href="/simple-course/devops/02#102-使用-buildx-构建多架构镜像"><span>10.2 使用 buildx 构建多架构镜像</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="慕课---docker入门"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#慕课---docker入门"><span class="icon icon-link"></span></a>慕课 - Docker入门</h1><h2 id="11-容器技术介绍"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#11-容器技术介绍"><span class="icon icon-link"></span></a>1.1 容器技术介绍</h2><blockquote><p>Note:</p><p>注意我们这里所说的容器 container 是指的一种技术，而 Docker 只是个容器技术的实现，或者说让容器技术普及开来的最成功的实现</p></blockquote><h3 id="什么是container容器"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#什么是container容器"><span class="icon icon-link"></span></a>什么是Container(容器)?</h3><p>容器是一种快速的打包技术</p><p>Package Software into Standardized Units for  Development, Shipment and Deployment</p><ul><li>标准化</li><li>轻量级</li><li>易移植</li></ul><p>Linux Container 容器技术的生（2008 年）就解决了 IT 世界里&quot;集装箱运输&quot;的题。Linux Container（简称 LXC）它是一种内核轻量级的操作系统层虚拟化技术。Linux Container 主要由 Namespace 和 Cgroups 两大机制来保证实现</p><ul><li><p>Namespace 命名空间主要用于资源的隔离</p></li><li><p>Cgroup就负责资源管理控制作用, 比如进程组使用 CPU/MEM的限制,进程组的优先级控制，进程组的挂起和恢复等。</p></li></ul><h3 id="容器的快速发展和普及"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#容器的快速发展和普及"><span class="icon icon-link"></span></a>容器的快速发展和普及</h3><h3 id="容器的标准化"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#容器的标准化"><span class="icon icon-link"></span></a>容器的标准化</h3><p><code>docker != container</code></p><p>在 2015 年，由 Google, Docker、红帽等厂商联合发起了OCI (Open Container Initiative）组织，致力于容器技术的标准化</p><h4 id="容器运行时标准runtime-spec"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#容器运行时标准runtime-spec"><span class="icon icon-link"></span></a>容器运行时标准（runtime spec)</h4><p>简单来讲就是规定了容器的基本操作规范，比如如何下載镜像，创建容器工启动容器等。##</p><h4 id="容器镜像标准image-spec"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#容器镜像标准image-spec"><span class="icon icon-link"></span></a>容器镜像标准（Image spec)</h4><p>主要定义镜像的基本格式。</p><h3 id="容器是关乎速度"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#容器是关乎速度"><span class="icon icon-link"></span></a>容器是关乎速度</h3><ul><li>容器会加速你的软件开发</li><li>容器会加速你的程序编译和构建</li><li>容器会加速你的测试</li><li>容器会速度你的部署</li><li>容器会加速你的更新</li><li>容器会速度你的故障恢复</li></ul><h1 id="2-容器快速上手"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#2-容器快速上手"><span class="icon icon-link"></span></a>2. 容器快速上手</h1><h2 id="21-docker-cli-命令行介绍"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#21-docker-cli-命令行介绍"><span class="icon icon-link"></span></a>2.1. Docker CLI 命令行介绍</h2><ul><li>docker version - 查看docker的版本号</li></ul><p>docker + 管理的对象（比如容器，镜像） + 具体操作（比如创建，启动，停止，删除）</p><ul><li><code>docker image pull nginx</code> 拉取一个叫 nginx 的 docker image 镜像</li><li><code>docker container stop web</code> 停止一个叫web的docker container容器</li></ul><h2 id="22-image-vs-container-镜像-vs-容器"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#22-image-vs-container-镜像-vs-容器"><span class="icon icon-link"></span></a>2.2 Image vs Container 镜像 vs 容器</h2><h3 id="image-镜像"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#image-镜像"><span class="icon icon-link"></span></a>image 镜像</h3><ul><li>Docker image是一个 <code>read-only</code> 文件</li><li>这个文件包含文件系统，源码，库文件，依赖，工具等一些运行application所需要的文件</li><li>可以理解成一个模板</li><li>docker image具有分层的概念</li></ul><h3 id="container容器"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#container容器"><span class="icon icon-link"></span></a>container容器</h3><ul><li>“一个运行中的docker image”</li><li>实质是复制image并在image最上层加上一层 <code>read-write</code> 的层 （称之为 <code>container layer</code> ,容器层）</li><li>基于同一个image可以创建多个container</li></ul><p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2021-11-13-133509.png" alt="docker-image-vs-container"/></p><h3 id="docker-image的获取"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#docker-image的获取"><span class="icon icon-link"></span></a>docker image的获取</h3><ul><li>自己制作</li><li>从registry拉取（比如docker hub）</li></ul><h2 id="23-容器的基本操作"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#23-容器的基本操作"><span class="icon icon-link"></span></a>2.3 容器的基本操作</h2><div class="__dumi-default-table"><div class="__dumi-default-table-content"><table><thead><tr><th>操作</th><th>命令(全)</th><th>命令(简)</th></tr></thead><tbody><tr><td>容器的创建</td><td>docker container run <code>&lt;image name&gt;</code></td><td>docker run <code>&lt;image name&gt;</code></td></tr><tr><td>容器的列出(up)</td><td>docker container ls</td><td>docker ps</td></tr><tr><td>容器的列出(up和exit)</td><td>docker container ls -a</td><td>docker ps -a</td></tr><tr><td>容器的停止</td><td>docker container stop <code>&lt;name or ID&gt;</code></td><td>docker stop <code>&lt;container name or ID&gt;</code></td></tr><tr><td>容器的删除</td><td>docker container rm <code>&lt;name or ID&gt;</code></td><td>docker rm <code>&lt;container name or ID&gt;</code></td></tr></tbody></table></div></div><h2 id="24-docker-container-命令小技巧"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#24-docker-container-命令小技巧"><span class="icon icon-link"></span></a>2.4 docker container 命令小技巧</h2><h3 id="批量停止"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#批量停止"><span class="icon icon-link"></span></a>批量停止</h3><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container </span><span class="token function">ps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES</span></div><div class="token-line"><span class="token plain">cd3a825fedeb   nginx     </span><span class="token string">&quot;/docker-entrypoint.…&quot;</span><span class="token plain">   </span><span class="token number">7</span><span class="token plain"> seconds ago    Up </span><span class="token number">6</span><span class="token plain"> seconds    </span><span class="token number">80</span><span class="token plain">/tcp    mystifying_leakey</span></div><div class="token-line"><span class="token plain">269494fe89fa   nginx     </span><span class="token string">&quot;/docker-entrypoint.…&quot;</span><span class="token plain">   </span><span class="token number">9</span><span class="token plain"> seconds ago    Up </span><span class="token number">8</span><span class="token plain"> seconds    </span><span class="token number">80</span><span class="token plain">/tcp    funny_gauss</span></div><div class="token-line"><span class="token plain">34b68af9deef   nginx     </span><span class="token string">&quot;/docker-entrypoint.…&quot;</span><span class="token plain">   </span><span class="token number">12</span><span class="token plain"> seconds ago   Up </span><span class="token number">10</span><span class="token plain"> seconds   </span><span class="token number">80</span><span class="token plain">/tcp    interesting_mahavira</span></div><div class="token-line"><span class="token plain">7513949674fc   nginx     </span><span class="token string">&quot;/docker-entrypoint.…&quot;</span><span class="token plain">   </span><span class="token number">13</span><span class="token plain"> seconds ago   Up </span><span class="token number">12</span><span class="token plain"> seconds   </span><span class="token number">80</span><span class="token plain">/tcp    kind_nobel</span></div></pre></div><p>方法1</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container </span><span class="token function">rm</span><span class="token plain"> cd3 </span><span class="token number">269</span><span class="token plain"> 34b </span><span class="token number">751</span></div></pre></div><p>方法2</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container stop </span><span class="token variable">$(</span><span class="token variable function">docker</span><span class="token variable"> container </span><span class="token variable function">ps</span><span class="token variable"> -q</span><span class="token variable">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">cd3a825fedeb</span></div><div class="token-line"><span class="token plain">269494fe89fa</span></div><div class="token-line"><span class="token plain">34b68af9deef</span></div><div class="token-line"><span class="token plain">7513949674fc</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container </span><span class="token function">ps</span><span class="token plain"> -a</span></div><div class="token-line"><span class="token plain">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS                     PORTS     NAMES</span></div><div class="token-line"><span class="token plain">cd3a825fedeb   nginx     </span><span class="token string">&quot;/docker-entrypoint.…&quot;</span><span class="token plain">   </span><span class="token number">30</span><span class="token plain"> seconds ago   Exited </span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"> seconds ago             mystifying_leakey</span></div><div class="token-line"><span class="token plain">269494fe89fa   nginx     </span><span class="token string">&quot;/docker-entrypoint.…&quot;</span><span class="token plain">   </span><span class="token number">32</span><span class="token plain"> seconds ago   Exited </span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"> seconds ago             funny_gauss</span></div><div class="token-line"><span class="token plain">34b68af9deef   nginx     </span><span class="token string">&quot;/docker-entrypoint.…&quot;</span><span class="token plain">   </span><span class="token number">35</span><span class="token plain"> seconds ago   Exited </span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"> seconds ago             interesting_mahavira</span></div><div class="token-line"><span class="token plain">7513949674fc   nginx     </span><span class="token string">&quot;/docker-entrypoint.…&quot;</span><span class="token plain">   </span><span class="token number">36</span><span class="token plain"> seconds ago   Exited </span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"> seconds ago             kind_nobel</span></div><div class="token-line"><span class="token plain">$</span></div></pre></div><h3 id="批量删除"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#批量删除"><span class="icon icon-link"></span></a>批量删除</h3><p>和批量停止类似，可以使用 <code>docker container rm $(docker container ps -aq)</code></p><blockquote><p>Note</p><p><code>docker system prune -a -f</code> 可以快速对系统进行清理，删除停止的容器，不用的image，等等</p></blockquote><h2 id="25-连接容器的-shell"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#25-连接容器的-shell"><span class="icon icon-link"></span></a>2.5 连接容器的 shell</h2><p><code>docker container run -it</code> 创建一个容器并进入交互式模式</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">➜  ~ </span><span class="token function">docker</span><span class="token plain"> container run -it busybox </span><span class="token function">sh</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">/ </span><span class="token comment">#</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">/ </span><span class="token comment">#</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">/ </span><span class="token comment"># ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">bin   dev   etc   home  proc  root  sys   tmp   usr   var</span></div><div class="token-line"><span class="token plain">/ </span><span class="token comment"># ps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">PID   </span><span class="token environment constant">USER</span><span class="token plain">     TIME  COMMAND</span></div><div class="token-line"><span class="token plain">    </span><span class="token number">1</span><span class="token plain"> root      </span><span class="token number">0</span><span class="token plain">:00 </span><span class="token function">sh</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token number">8</span><span class="token plain"> root      </span><span class="token number">0</span><span class="token plain">:00 </span><span class="token function">ps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">/ </span><span class="token comment"># exit</span></div></pre></div><p><code>docker container exec -it</code> 在一个已经运行的容器里执行一个额外的command</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">➜  ~ </span><span class="token function">docker</span><span class="token plain"> container run -d nginx</span></div><div class="token-line"><span class="token plain">33d2ee50cfc46b5ee0b290f6ad75d724551be50217f691e68d15722328f11ef6</span></div><div class="token-line"><span class="token plain">➜  ~</span></div><div class="token-line"><span class="token plain">➜  ~ </span><span class="token function">docker</span><span class="token plain"> container </span><span class="token builtin class-name">exec</span><span class="token plain"> -it 33d </span><span class="token function">sh</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">#</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">#</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">bin  boot  dev  docker-entrypoint.d  docker-entrypoint.sh  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">#</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># exit</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">➜  ~</span></div></pre></div><h2 id="26-容器和虚拟机-container-vs-vm"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#26-容器和虚拟机-container-vs-vm"><span class="icon icon-link"></span></a>2.6 容器和虚拟机 Container vs VM</h2><p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2021-11-13-134724.jpg" alt="docker-vs-vm"/></p><h3 id="容器不是mini虚拟机"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#容器不是mini虚拟机"><span class="icon icon-link"></span></a>容器不是Mini虚拟机</h3><ul><li>容器其实是进程Containers are just processes</li><li>容器中的进程被限制了对CPU内存等资源的访问</li><li>当进程停止后，容器就退出了</li></ul><h3 id="容器的进程process"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#容器的进程process"><span class="icon icon-link"></span></a>容器的进程process</h3><h2 id="27-docker-container-run-背后发生了什么"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#27-docker-container-run-背后发生了什么"><span class="icon icon-link"></span></a>2.7 docker container run 背后发生了什么？</h2><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container run -d --publish </span><span class="token number">80</span><span class="token plain">:80 --name webhost nginx</span></div></pre></div><ol><li>在本地查找是否有nginx这个image镜像，但是没有发现</li><li>去远程的image registry查找nginx镜像（默认的registry是Docker Hub)</li><li>下载最新版本的nginx镜像 （nginx:latest 默认)</li><li>基于nginx镜像来创建一个新的容器，并且准备运行</li><li>docker engine分配给这个容器一个虚拟IP地址</li><li>在宿主机上打开80端口并把容器的80端口转发到宿主机上</li><li>启动容器，运行指定的命令（这里是一个shell脚本去启动nginx）</li></ol><h1 id="3-镜像的创建管理和发布"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#3-镜像的创建管理和发布"><span class="icon icon-link"></span></a>3. 镜像的创建管理和发布</h1><h2 id="31-镜像的获取"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#31-镜像的获取"><span class="icon icon-link"></span></a>3.1. 镜像的获取</h2><ul><li>pull from <code>registry</code> (online) 从registry拉取<ul><li>public（公有）</li><li>private（私有）</li></ul></li><li>build from <code>Dockerfile</code> (online) 从Dockerfile构建</li><li>load from <code>file</code> (offline) 文件导入 （离线）</li></ul><p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2021-11-13-135640.png" alt="docker-image"/></p><h2 id="32-镜像的基本操作"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#32-镜像的基本操作"><span class="icon icon-link"></span></a>3.2 镜像的基本操作</h2><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Usage:  </span><span class="token function">docker</span><span class="token plain"> image COMMAND</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Manage images</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Commands:</span></div><div class="token-line"><span class="token plain">build       Build an image from a Dockerfile</span></div><div class="token-line"><span class="token plain"></span><span class="token function">history</span><span class="token plain">     Show the </span><span class="token function">history</span><span class="token plain"> of an image</span></div><div class="token-line"><span class="token plain"></span><span class="token function">import</span><span class="token plain">      Import the contents from a tarball to create a filesystem image</span></div><div class="token-line"><span class="token plain">inspect     Display detailed information on one or </span><span class="token function">more</span><span class="token plain"> images</span></div><div class="token-line"><span class="token plain">load        Load an image from a </span><span class="token function">tar</span><span class="token plain"> archive or STDIN</span></div><div class="token-line"><span class="token plain"></span><span class="token function">ls</span><span class="token plain">          List images</span></div><div class="token-line"><span class="token plain">prune       Remove unused images</span></div><div class="token-line"><span class="token plain">pull        Pull an image or a repository from a registry</span></div><div class="token-line"><span class="token plain">push        Push an image or a repository to a registry</span></div><div class="token-line"><span class="token plain"></span><span class="token function">rm</span><span class="token plain">          Remove one or </span><span class="token function">more</span><span class="token plain"> images</span></div><div class="token-line"><span class="token plain">save        Save one or </span><span class="token function">more</span><span class="token plain"> images to a </span><span class="token function">tar</span><span class="token plain"> archive </span><span class="token punctuation">(</span><span class="token plain">streamed to STDOUT by default</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">tag         Create a tag TARGET_IMAGE that refers to SOURCE_IMAGE</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Run </span><span class="token string">&#x27;docker image COMMAND --help&#x27;</span><span class="token plain"> </span><span class="token keyword">for</span><span class="token plain"> </span><span class="token function">more</span><span class="token plain"> information on a command.</span></div></pre></div><h3 id="镜像的拉取-pull-image"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#镜像的拉取-pull-image"><span class="icon icon-link"></span></a>镜像的拉取 Pull Image</h3><p>默认从Docker Hub拉取，如果不指定版本，会拉取最新版</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> pull nginx</span></div><div class="token-line"><span class="token plain">Using default tag: latest</span></div><div class="token-line"><span class="token plain">latest: Pulling from library/nginx</span></div><div class="token-line"><span class="token plain">69692152171a: Pull complete</span></div><div class="token-line"><span class="token plain">49f7d34d62c1: Pull complete</span></div><div class="token-line"><span class="token plain">5f97dc5d71ab: Pull complete</span></div><div class="token-line"><span class="token plain">cfcd0711b93a: Pull complete</span></div><div class="token-line"><span class="token plain">be6172d7651b: Pull complete</span></div><div class="token-line"><span class="token plain">de9813870342: Pull complete</span></div><div class="token-line"><span class="token plain">Digest: sha256:df13abe416e37eb3db4722840dd479b00ba193ac6606e7902331dcea50f4f1f2</span></div><div class="token-line"><span class="token plain">Status: Downloaded newer image </span><span class="token keyword">for</span><span class="token plain"> nginx:latest</span></div><div class="token-line"><span class="token plain">docker.io/library/nginx:latest</span></div></pre></div><p>指定版本</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> pull nginx:1.20.0</span></div><div class="token-line"><span class="token plain"></span><span class="token number">1.20</span><span class="token plain">.0: Pulling from library/nginx</span></div><div class="token-line"><span class="token plain">69692152171a: Already exists</span></div><div class="token-line"><span class="token plain">965615a5cec8: Pull complete</span></div><div class="token-line"><span class="token plain">b141b026b9ce: Pull complete</span></div><div class="token-line"><span class="token plain">8d70dc384fb3: Pull complete</span></div><div class="token-line"><span class="token plain">525e372d6dee: Pull complete</span></div><div class="token-line"><span class="token plain">Digest: sha256:ea4560b87ff03479670d15df426f7d02e30cb6340dcd3004cdfc048d6a1d54b4</span></div><div class="token-line"><span class="token plain">Status: Downloaded newer image </span><span class="token keyword">for</span><span class="token plain"> nginx:1.20.0</span></div><div class="token-line"><span class="token plain">docker.io/library/nginx:1.20.0</span></div></pre></div><p>从Quay上拉取镜像</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> pull quay.io/bitnami/nginx</span></div><div class="token-line"><span class="token plain">Using default tag: latest</span></div><div class="token-line"><span class="token plain">latest: Pulling from bitnami/nginx</span></div><div class="token-line"><span class="token plain">2e6370f1e2d3: Pull complete</span></div><div class="token-line"><span class="token plain">2d464c695e97: Pull complete</span></div><div class="token-line"><span class="token plain">83eb3b1671f4: Pull complete</span></div><div class="token-line"><span class="token plain">364c139450f9: Pull complete</span></div><div class="token-line"><span class="token plain">dc453d5ae92e: Pull complete</span></div><div class="token-line"><span class="token plain">09bd59934b83: Pull complete</span></div><div class="token-line"><span class="token plain">8d2bd62eedfb: Pull complete</span></div><div class="token-line"><span class="token plain">8ac060ae1ede: Pull complete</span></div><div class="token-line"><span class="token plain">c7c9bc2f4f9d: Pull complete</span></div><div class="token-line"><span class="token plain">6dd7098b85fa: Pull complete</span></div><div class="token-line"><span class="token plain">894a70299d18: Pull complete</span></div><div class="token-line"><span class="token plain">Digest: sha256:d143befa04e503472603190da62db157383797d281fb04e6a72c85b48e0b3239</span></div><div class="token-line"><span class="token plain">Status: Downloaded newer image </span><span class="token keyword">for</span><span class="token plain"> quay.io/bitnami/nginx:latest</span></div><div class="token-line"><span class="token plain">quay.io/bitnami/nginx:latest</span></div></pre></div><h3 id="镜像查看"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#镜像查看"><span class="icon icon-link"></span></a>镜像查看</h3><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">REPOSITORY              TAG       IMAGE ID       CREATED       SIZE</span></div><div class="token-line"><span class="token plain">quay.io/bitnami/nginx   latest    0922eabe1625   </span><span class="token number">6</span><span class="token plain"> hours ago   </span><span class="token number">89</span><span class="token plain">.3MB</span></div><div class="token-line"><span class="token plain">nginx                   </span><span class="token number">1.20</span><span class="token plain">.0    7ab27dbbfbdf   </span><span class="token number">10</span><span class="token plain"> days ago   133MB</span></div><div class="token-line"><span class="token plain">nginx                   latest    f0b8a9a54136   </span><span class="token number">10</span><span class="token plain"> days ago   133MB</span></div></pre></div><h3 id="镜像的删除"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#镜像的删除"><span class="icon icon-link"></span></a>镜像的删除</h3><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image </span><span class="token function">rm</span><span class="token plain"> 0922eabe1625</span></div><div class="token-line"><span class="token plain">Untagged: quay.io/bitnami/nginx:latest</span></div><div class="token-line"><span class="token plain">Untagged:quay.io/bitnami/nginx@sha256:d143befa04e503472603190da62db157383797d281fb04e6a72c85b48e0b3239</span></div><div class="token-line"><span class="token plain">Deleted: sha256:0922eabe16250e2f4711146e31b7aac0e547f52daa6cf01c9d00cf64d49c68c8</span></div><div class="token-line"><span class="token plain">Deleted: sha256:5eee4ed0f6b242e2c6e4f4066c7aca26bf9b3b021b511b56a0dadd52610606bd</span></div><div class="token-line"><span class="token plain">Deleted: sha256:472a75325eda417558f9100ff8b4a97f4a5e8586a14eb9c8fc12f944b26a21f8</span></div><div class="token-line"><span class="token plain">Deleted: sha256:cdcb5872f8a64a0b5839711fcd2a87ba05795e5bf6a70ba9510b8066cdd25e76</span></div><div class="token-line"><span class="token plain">Deleted: sha256:e0f1b7345a521469bbeb7ec53ef98227bd38c87efa19855c5ba0db0ac25c8e83</span></div><div class="token-line"><span class="token plain">Deleted: sha256:11b9c2261cfc687fba8d300b83434854cc01e91a2f8b1c21dadd937e59290c99</span></div><div class="token-line"><span class="token plain">Deleted: sha256:4819311ec2867ad82d017253500be1148fc335ad13b6c1eb6875154da582fcf2</span></div><div class="token-line"><span class="token plain">Deleted: sha256:784480add553b8e8d5ee1bbd229ed8be92099e5fb61009ed7398b93d5705a560</span></div><div class="token-line"><span class="token plain">Deleted: sha256:e0c520d1a43832d5d2b1028e3f57047f9d9f71078c0187f4bb05e6a6a572993d</span></div><div class="token-line"><span class="token plain">Deleted: sha256:94d5b1d6c9e31de42ce58b8ce51eb6fb5292ec889a6d95763ad2905330b92762</span></div><div class="token-line"><span class="token plain">Deleted: sha256:95deba55c490bbb8de44551d3e6a89704758c93ba8503a593cb7c07dfbae0058</span></div><div class="token-line"><span class="token plain">Deleted: sha256:1ad1d903ef1def850cd44e2010b46542196e5f91e53317dbdb2c1eedfc2d770c</span></div></pre></div><h2 id="33-关于-scratch-镜像"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#33-关于-scratch-镜像"><span class="icon icon-link"></span></a>3.3 关于 scratch 镜像</h2><p>Scratch是一个空的Docker镜像。</p><p>通过scratch来构建一个基础镜像。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">hello.c</span></div><div class="token-line"><span class="token plain">#include &lt;stdio.h&gt;</span></div><div class="token-line"><span class="token plain">int main()</span></div><div class="token-line"><span class="token plain">{</span></div><div class="token-line"><span class="token plain">    printf(&quot;hello docker\n&quot;);</span></div><div class="token-line"><span class="token plain">}</span></div></pre></div><p>编译成一个二进制文件</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ gcc --static -o hello hello.c</span></div><div class="token-line"><span class="token plain">$ ./hello</span></div><div class="token-line"><span class="token plain">hello </span><span class="token function">docker</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">Dockerfile</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">FROM scratch</span></div><div class="token-line"><span class="token plain">ADD hello /</span></div><div class="token-line"><span class="token plain">CMD </span><span class="token punctuation">[</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">]</span></div></pre></div><p>构建</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> build -t hello </span><span class="token builtin class-name">.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span></div><div class="token-line"><span class="token plain">hello        latest    2936e77a9daa   </span><span class="token number">40</span><span class="token plain"> minutes ago   872kB</span></div></pre></div><p>运行</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container run -it hello</span></div><div class="token-line"><span class="token plain">hello </span><span class="token function">docker</span></div></pre></div><h1 id="4-dockerfile完全指南"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#4-dockerfile完全指南"><span class="icon icon-link"></span></a>4. Dockerfile完全指南</h1><h2 id="41-基础镜像的选择from"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#41-基础镜像的选择from"><span class="icon icon-link"></span></a>4.1 基础镜像的选择（FROM）</h2><h3 id="基本原则"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#基本原则"><span class="icon icon-link"></span></a>基本原则</h3><ul><li>官方镜像优于非官方的镜像，如果没有官方镜像，则尽量选择Dockerfile开源的</li><li>固定版本tag而不是每次都使用latest</li><li>尽量选择体积小的镜像</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">REPOSITORY      TAG             IMAGE ID       CREATED          SIZE</span></div><div class="token-line"><span class="token plain">bitnami/nginx   </span><span class="token number">1.18</span><span class="token plain">.0          dfe237636dde   </span><span class="token number">28</span><span class="token plain"> minutes ago   </span><span class="token number">89</span><span class="token plain">.3MB</span></div><div class="token-line"><span class="token plain">nginx           </span><span class="token number">1.21</span><span class="token plain">.0-alpine   a6eb2a334a9f   </span><span class="token number">2</span><span class="token plain"> days ago       </span><span class="token number">22</span><span class="token plain">.6MB</span></div><div class="token-line"><span class="token plain">nginx           </span><span class="token number">1.21</span><span class="token plain">.0          d1a364dc548d   </span><span class="token number">2</span><span class="token plain"> days ago       133MB</span></div></pre></div><h3 id="build一个nginx镜像"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#build一个nginx镜像"><span class="icon icon-link"></span></a>Build一个Nginx镜像</h3><p>假如我们有一个 <code>index.html</code> 文件</p><div class="__dumi-default-code-block"><pre class="prism-code language-html"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token tag punctuation">&lt;</span><span class="token tag">h1</span><span class="token tag punctuation">&gt;</span><span class="token plain">Hello Docker</span><span class="token tag punctuation">&lt;/</span><span class="token tag">h1</span><span class="token tag punctuation">&gt;</span></div></pre></div><p>准备一个Dockerfile</p><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">FROM nginx:1.21.0-alpine</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">ADD index.html /usr/share/nginx/html/index.html</span></div></pre></div><h2 id="42-通过-run-执行指令"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#42-通过-run-执行指令"><span class="icon icon-link"></span></a>4.2 通过 RUN 执行指令</h2><p><code>RUN</code> 主要用于在Image里执行指令，比如安装软件，下载文件等。</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">apt-get</span><span class="token plain"> update</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">apt-get</span><span class="token plain"> </span><span class="token function">install</span><span class="token plain"> </span><span class="token function">wget</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">wget</span><span class="token plain"> https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">tar</span><span class="token plain"> zxf ipinfo_2.0.1_linux_amd64.tar.gz</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">mv</span><span class="token plain"> ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">rm</span><span class="token plain"> -rf ipinfo_2.0.1_linux_amd64.tar.gz</span></div></pre></div><h3 id="dockerfile"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#dockerfile"><span class="icon icon-link"></span></a>Dockerfile</h3><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">FROM ubuntu:21.04</span></div><div class="token-line"><span class="token plain">RUN apt-get update</span></div><div class="token-line"><span class="token plain">RUN apt-get install -y wget</span></div><div class="token-line"><span class="token plain">RUN wget https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz</span></div><div class="token-line"><span class="token plain">RUN tar zxf ipinfo_2.0.1_linux_amd64.tar.gz</span></div><div class="token-line"><span class="token plain">RUN mv ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo</span></div><div class="token-line"><span class="token plain">RUN rm -rf ipinfo_2.0.1_linux_amd64.tar.gz</span></div></pre></div><p>镜像的大小和分层</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span></div><div class="token-line"><span class="token plain">ipinfo       latest    97bb429363fb   </span><span class="token number">4</span><span class="token plain"> minutes ago   138MB</span></div><div class="token-line"><span class="token plain">ubuntu       </span><span class="token number">21.04</span><span class="token plain">     478aa0080b60   </span><span class="token number">4</span><span class="token plain"> days ago      </span><span class="token number">74</span><span class="token plain">.1MB</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image </span><span class="token function">history</span><span class="token plain"> 97b</span></div><div class="token-line"><span class="token plain">IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT</span></div><div class="token-line"><span class="token plain">97bb429363fb   </span><span class="token number">4</span><span class="token plain"> minutes ago   RUN /bin/sh -c </span><span class="token function">rm</span><span class="token plain"> -rf ipinfo_2.0.1_linux_amd…   0B        buildkit.dockerfile.v0</span></div><div class="token-line"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token plain">missing</span><span class="token operator">&gt;</span><span class="token plain">      </span><span class="token number">4</span><span class="token plain"> minutes ago   RUN /bin/sh -c </span><span class="token function">mv</span><span class="token plain"> ipinfo_2.0.1_linux_amd64 /…   </span><span class="token number">9</span><span class="token plain">.36MB    buildkit.dockerfile.v0</span></div><div class="token-line"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token plain">missing</span><span class="token operator">&gt;</span><span class="token plain">      </span><span class="token number">4</span><span class="token plain"> minutes ago   RUN /bin/sh -c </span><span class="token function">tar</span><span class="token plain"> zxf ipinfo_2.0.1_linux_am…   </span><span class="token number">9</span><span class="token plain">.36MB    buildkit.dockerfile.v0</span></div><div class="token-line"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token plain">missing</span><span class="token operator">&gt;</span><span class="token plain">      </span><span class="token number">4</span><span class="token plain"> minutes ago   RUN /bin/sh -c </span><span class="token function">wget</span><span class="token plain"> https://github.com/ipinf…   </span><span class="token number">4</span><span class="token plain">.85MB    buildkit.dockerfile.v0</span></div><div class="token-line"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token plain">missing</span><span class="token operator">&gt;</span><span class="token plain">      </span><span class="token number">4</span><span class="token plain"> minutes ago   RUN /bin/sh -c </span><span class="token function">apt-get</span><span class="token plain"> </span><span class="token function">install</span><span class="token plain"> -y </span><span class="token function">wget</span><span class="token plain"> </span><span class="token comment"># bui…   7.58MB    buildkit.dockerfile.v0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token plain">missing</span><span class="token operator">&gt;</span><span class="token plain">      </span><span class="token number">4</span><span class="token plain"> minutes ago   RUN /bin/sh -c </span><span class="token function">apt-get</span><span class="token plain"> update </span><span class="token comment"># buildkit        33MB      buildkit.dockerfile.v0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token plain">missing</span><span class="token operator">&gt;</span><span class="token plain">      </span><span class="token number">4</span><span class="token plain"> days ago      /bin/sh -c </span><span class="token comment">#(nop)  CMD [&quot;/bin/bash&quot;]            0B</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token plain">missing</span><span class="token operator">&gt;</span><span class="token plain">      </span><span class="token number">4</span><span class="token plain"> days ago      /bin/sh -c </span><span class="token function">mkdir</span><span class="token plain"> -p /run/systemd </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string">&#x27;do…   7B</span></div><div class="token-line"><span class="token string">&lt;missing&gt;      4 days ago      /bin/sh -c [ -z &quot;$(apt-get indextargets)&quot; ]     0B</span></div><div class="token-line"><span class="token string">&lt;missing&gt;      4 days ago      /bin/sh -c set -xe   &amp;&amp; echo &#x27;</span><span class="token comment">#!/bin/sh&#x27; &gt; /…   811B</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token plain">missing</span><span class="token operator">&gt;</span><span class="token plain">      </span><span class="token number">4</span><span class="token plain"> days ago      /bin/sh -c </span><span class="token comment">#(nop) ADD file:d6b6ba642344138dc…   74.1MB</span></div></pre></div><p>每一行的RUN命令都会产生一层image layer, 导致镜像的臃肿。</p><h3 id="改进版dockerfile"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#改进版dockerfile"><span class="icon icon-link"></span></a>改进版Dockerfile</h3><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">FROM ubuntu:21.04</span></div><div class="token-line"><span class="token plain">RUN apt-get update &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    apt-get install -y wget &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    wget https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    tar zxf ipinfo_2.0.1_linux_amd64.tar.gz &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    mv ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    rm -rf ipinfo_2.0.1_linux_amd64.tar.gz</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span></div><div class="token-line"><span class="token plain">ipinfo-new   latest    fe551bc26b92   </span><span class="token number">5</span><span class="token plain"> seconds ago    124MB</span></div><div class="token-line"><span class="token plain">ipinfo       latest    97bb429363fb   </span><span class="token number">16</span><span class="token plain"> minutes ago   138MB</span></div><div class="token-line"><span class="token plain">ubuntu       </span><span class="token number">21.04</span><span class="token plain">     478aa0080b60   </span><span class="token number">4</span><span class="token plain"> days ago       </span><span class="token number">74</span><span class="token plain">.1MB</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image </span><span class="token function">history</span><span class="token plain"> fe5</span></div><div class="token-line"><span class="token plain">IMAGE          CREATED          CREATED BY                                      SIZE      COMMENT</span></div><div class="token-line"><span class="token plain">fe551bc26b92   </span><span class="token number">16</span><span class="token plain"> seconds ago   RUN /bin/sh -c </span><span class="token function">apt-get</span><span class="token plain"> update </span><span class="token operator">&amp;&amp;</span><span class="token plain">     apt-get…   </span><span class="token number">49</span><span class="token plain">.9MB    buildkit.dockerfile.v0</span></div><div class="token-line"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token plain">missing</span><span class="token operator">&gt;</span><span class="token plain">      </span><span class="token number">4</span><span class="token plain"> days ago       /bin/sh -c </span><span class="token comment">#(nop)  CMD [&quot;/bin/bash&quot;]            0B</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token plain">missing</span><span class="token operator">&gt;</span><span class="token plain">      </span><span class="token number">4</span><span class="token plain"> days ago       /bin/sh -c </span><span class="token function">mkdir</span><span class="token plain"> -p /run/systemd </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string">&#x27;do…   7B</span></div><div class="token-line"><span class="token string">&lt;missing&gt;      4 days ago       /bin/sh -c [ -z &quot;$(apt-get indextargets)&quot; ]     0B</span></div><div class="token-line"><span class="token string">&lt;missing&gt;      4 days ago       /bin/sh -c set -xe   &amp;&amp; echo &#x27;</span><span class="token comment">#!/bin/sh&#x27; &gt; /…   811B</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token plain">missing</span><span class="token operator">&gt;</span><span class="token plain">      </span><span class="token number">4</span><span class="token plain"> days ago       /bin/sh -c </span><span class="token comment">#(nop) ADD file:d6b6ba642344138dc…   74.1MB</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$</span></div></pre></div><h2 id="43-文件复制和目录操作-addcopyworkdir"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#43-文件复制和目录操作-addcopyworkdir"><span class="icon icon-link"></span></a>4.3 文件复制和目录操作 (ADD,COPY,WORKDIR)</h2><p>往镜像里复制文件有两种方式，<code>COPY</code> 和 <code>ADD</code> , 我们来看一下两者的不同。</p><h3 id="复制普通文件"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#复制普通文件"><span class="icon icon-link"></span></a>复制普通文件</h3><p><code>COPY</code> 和 <code>ADD</code> 都可以把local的一个文件复制到镜像里，如果目标目录不存在，则会自动创建</p><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">FROM python:3.9.5-alpine3.13</span></div><div class="token-line"><span class="token plain">COPY hello.py /app/hello.py</span></div></pre></div><p>比如把本地的 hello.py 复制到 /app 目录下。 /app这个folder不存在，则会自动创建</p><h3 id="复制压缩文件"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#复制压缩文件"><span class="icon icon-link"></span></a>复制压缩文件</h3><p><code>ADD</code> 比 COPY高级一点的地方就是，如果复制的是一个gzip等压缩文件时，ADD会帮助我们自动去解压缩文件。</p><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">FROM python:3.9.5-alpine3.13</span></div><div class="token-line"><span class="token plain">ADD hello.tar.gz /app/</span></div></pre></div><h3 id="如何选择"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#如何选择"><span class="icon icon-link"></span></a>如何选择</h3><p>因此在 COPY 和 ADD 指令中选择的时候，可以遵循这样的原则，所有的文件复制均使用 COPY 指令，仅在需要自动解压缩的场合使用 ADD。</p><h2 id="44-构建参数和环境变量-arg-vs-env"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#44-构建参数和环境变量-arg-vs-env"><span class="icon icon-link"></span></a>4.4 构建参数和环境变量 (ARG vs ENV)</h2><p><code>ARG</code> 和 <code>ENV</code> 是经常容易被混淆的两个Dockerfile的语法，都可以用来设置一个“变量”。 但实际上两者有很多的不同。</p><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">FROM ubuntu:21.04</span></div><div class="token-line"><span class="token plain">RUN apt-get update &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    apt-get install -y wget &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    wget https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    tar zxf ipinfo_2.0.1_linux_amd64.tar.gz &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    mv ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    rm -rf ipinfo_2.0.1_linux_amd64.tar.gz</span></div></pre></div><h3 id="env"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#env"><span class="icon icon-link"></span></a>ENV</h3><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">FROM ubuntu:21.04</span></div><div class="token-line"><span class="token plain">ENV VERSION=2.0.1</span></div><div class="token-line"><span class="token plain">RUN apt-get update &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    apt-get install -y wget &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    wget https://github.com/ipinfo/cli/releases/download/ipinfo-${VERSION}/ipinfo_${VERSION}_linux_amd64.tar.gz &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    tar zxf ipinfo_${VERSION}_linux_amd64.tar.gz &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    mv ipinfo_${VERSION}_linux_amd64 /usr/bin/ipinfo &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    rm -rf ipinfo_${VERSION}_linux_amd64.tar.gz</span></div></pre></div><h3 id="arg"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#arg"><span class="icon icon-link"></span></a>ARG</h3><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">FROM ubuntu:21.04</span></div><div class="token-line"><span class="token plain">ARG VERSION=2.0.1</span></div><div class="token-line"><span class="token plain">RUN apt-get update &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    apt-get install -y wget &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    wget https://github.com/ipinfo/cli/releases/download/ipinfo-${VERSION}/ipinfo_${VERSION}_linux_amd64.tar.gz &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    tar zxf ipinfo_${VERSION}_linux_amd64.tar.gz &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    mv ipinfo_${VERSION}_linux_amd64 /usr/bin/ipinfo &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    rm -rf ipinfo_${VERSION}_linux_amd64.tar.gz</span></div></pre></div><h3 id="区别"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#区别"><span class="icon icon-link"></span></a>区别</h3><p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2021-11-14-022222.png" alt="docker-image"/></p><p>ARG 可以在镜像build的时候动态修改value, 通过 <code>--build-arg</code></p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image build -f .</span><span class="token punctuation">\</span><span class="token plain">Dockerfile-arg -t ipinfo-arg-2.0.0 --build-arg </span><span class="token assign-left variable">VERSION</span><span class="token operator">=</span><span class="token number">2.0</span><span class="token plain">.0 </span><span class="token builtin class-name">.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">REPOSITORY         TAG       IMAGE ID       CREATED          SIZE</span></div><div class="token-line"><span class="token plain">ipinfo-arg-2.0.0   latest    0d9c964947e2   </span><span class="token number">6</span><span class="token plain"> seconds ago    124MB</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container run -it ipinfo-arg-2.0.0</span></div><div class="token-line"><span class="token plain">root@b64285579756:/</span><span class="token comment">#</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">root@b64285579756:/</span><span class="token comment"># ipinfo version</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token number">2.0</span><span class="token plain">.0</span></div><div class="token-line"><span class="token plain">root@b64285579756:/</span><span class="token comment">#</span></div></pre></div><p>ENV 设置的变量可以在Image中保持，并在容器中的环境变量里</p><h2 id="45-容器启动命令-cmd"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#45-容器启动命令-cmd"><span class="icon icon-link"></span></a>4.5 容器启动命令 CMD</h2><p>CMD可以用来设置容器启动时默认会执行的命令。</p><ul><li>容器启动时默认执行的命令</li><li>如果docker container run启动容器时指定了其它命令，则CMD命令会被忽略</li><li>如果定义了多个CMD，只有最后一个会被执行。</li></ul><h2 id="46-容器启动命令-entrypoint"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#46-容器启动命令-entrypoint"><span class="icon icon-link"></span></a>4.6 容器启动命令 ENTRYPOINT</h2><p>ENTRYPOINT 也可以设置容器启动时要执行的命令，但是和CMD是有区别的。</p><ul><li><code>CMD</code> 设置的命令，可以在docker container run 时传入其它命令，覆盖掉 <code>CMD</code> 的命令，但是 <code>ENTRYPOINT</code> 所设置的命令是一定会被执行的。</li><li><code>ENTRYPOINT</code> 和 <code>CMD</code> 可以联合使用，<code>ENTRYPOINT</code> 设置执行的命令，CMD传递参数</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">FROM ubuntu:21.04</span></div><div class="token-line"><span class="token plain">CMD [&quot;echo&quot;, &quot;hello docker&quot;]</span></div></pre></div><p>把上面的Dockerfile build成一个叫 <code>demo-cmd</code> 的镜象</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">REPOSITORY        TAG       IMAGE ID       CREATED      SIZE</span></div><div class="token-line"><span class="token plain">demo-cmd          latest    5bb63bb9b365   </span><span class="token number">8</span><span class="token plain"> days ago   </span><span class="token number">74</span><span class="token plain">.1MB</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">FROM ubuntu:21.04</span></div><div class="token-line"><span class="token plain">ENTRYPOINT [&quot;echo&quot;, &quot;hello docker&quot;]</span></div></pre></div><p>build成一个叫 <code>demo-entrypoint</code> 的镜像</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">REPOSITORY        TAG       IMAGE ID       CREATED      SIZE</span></div><div class="token-line"><span class="token plain">demo-entrypoint   latest    b1693a62d67a   </span><span class="token number">8</span><span class="token plain"> days ago   </span><span class="token number">74</span><span class="token plain">.1MB</span></div></pre></div><p>CMD的镜像，如果执行创建容器，不指定运行时的命令，则会默认执行CMD所定义的命令，打印出hello docker</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container run -it --rm demo-cmd</span></div><div class="token-line"><span class="token plain">hello </span><span class="token function">docker</span></div></pre></div><p>但是如果我们docker container run的时候指定命令，则该命令会覆盖掉CMD的命令，如：</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container run -it --rm demo-cmd </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string">&quot;hello world&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">hello world</span></div></pre></div><p>但是ENTRYPOINT的容器里ENTRYPOINT所定义的命令则无法覆盖，一定会执行</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container run -it --rm demo-entrypoint</span></div><div class="token-line"><span class="token plain">hello </span><span class="token function">docker</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container run -it --rm demo-entrypoint </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string">&quot;hello world&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">hello </span><span class="token function">docker</span><span class="token plain"> </span><span class="token builtin class-name">echo</span><span class="token plain"> hello world</span></div><div class="token-line"><span class="token plain">$</span></div></pre></div><h2 id="47-shell-格式和-exec-格式"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#47-shell-格式和-exec-格式"><span class="icon icon-link"></span></a>4.7 Shell 格式和 Exec 格式</h2><p>CMD和ENTRYPOINT同时支持shell格式和Exec格式。</p><h3 id="shell格式"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#shell格式"><span class="icon icon-link"></span></a>Shell格式</h3><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">CMD echo &quot;hello docker&quot;</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">ENTRYPOINT echo &quot;hello docker&quot;</span></div></pre></div><h3 id="exec格式"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#exec格式"><span class="icon icon-link"></span></a>Exec格式</h3><p>以可执行命令的方式</p><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">ENTRYPOINT [&quot;echo&quot;, &quot;hello docker&quot;]</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">CMD [&quot;echo&quot;, &quot;hello docker&quot;]</span></div></pre></div><p>注意shell脚本的问题</p><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">FROM ubuntu:21.04</span></div><div class="token-line"><span class="token plain">ENV NAME=docker</span></div><div class="token-line"><span class="token plain">CMD echo &quot;hello $NAME&quot;</span></div></pre></div><p>假如我们要把上面的CMD改成Exec格式，下面这样改是不行的, 大家可以试试。</p><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">FROM ubuntu:21.04</span></div><div class="token-line"><span class="token plain">ENV NAME=docker</span></div><div class="token-line"><span class="token plain">CMD [&quot;echo&quot;, &quot;hello $NAME&quot;]</span></div></pre></div><p>它会打印出 <code>hello $NAME</code> , 而不是 <code>hello docker</code> ,那么需要怎么写呢？ 我们需要以shell脚本的方式去执行</p><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">FROM ubuntu:21.04</span></div><div class="token-line"><span class="token plain">ENV NAME=docker</span></div><div class="token-line"><span class="token plain">CMD [&quot;sh&quot;, &quot;-c&quot;, &quot;echo hello $NAME&quot;]</span></div></pre></div><h2 id="48-一起构建一个-python-flask-镜像"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#48-一起构建一个-python-flask-镜像"><span class="icon icon-link"></span></a>4.8 一起构建一个 Python Flask 镜像</h2><p>Python 程序</p><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">from flask import Flask</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">app = Flask(__name__)</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">@app.route(&#x27;/&#x27;)</span></div><div class="token-line"><span class="token plain">def hello_world():</span></div><div class="token-line"><span class="token plain">    return &#x27;Hello, World!&#x27;</span></div></pre></div><p>Dockerfile</p><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">FROM python:3.9.5-slim</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">COPY app.py /src/app.py</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">RUN pip install flask</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">WORKDIR /src</span></div><div class="token-line"><span class="token plain">ENV FLASK_APP=app.py</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">EXPOSE 5000</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">CMD [&quot;flask&quot;, &quot;run&quot;, &quot;-h&quot;, &quot;0.0.0.0&quot;]</span></div></pre></div><h2 id="49-dockerfile-技巧合理使用-dockerignore"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#49-dockerfile-技巧合理使用-dockerignore"><span class="icon icon-link"></span></a>4.9 Dockerfile 技巧——合理使用 .dockerignore</h2><h3 id="什么是docker-build-context"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#什么是docker-build-context"><span class="icon icon-link"></span></a>什么是Docker build context</h3><p>Docker是client-server架构，理论上Client和Server可以不在一台机器上。</p><p>在构建docker镜像的时候，需要把所需要的文件由CLI（client）发给Server，这些文件实际上就是build context</p><p>举例：</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ dockerfile-demo </span><span class="token function">more</span><span class="token plain"> Dockerfile</span></div><div class="token-line"><span class="token plain">FROM python:3.9.5-slim</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">RUN pip </span><span class="token function">install</span><span class="token plain"> flask</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">WORKDIR /src</span></div><div class="token-line"><span class="token plain">ENV </span><span class="token assign-left variable">FLASK_APP</span><span class="token operator">=</span><span class="token plain">app.py</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">COPY app.py /src/app.py</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">EXPOSE </span><span class="token number">5000</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">CMD </span><span class="token punctuation">[</span><span class="token string">&quot;flask&quot;</span><span class="token plain">, </span><span class="token string">&quot;run&quot;</span><span class="token plain">, </span><span class="token string">&quot;-h&quot;</span><span class="token plain">, </span><span class="token string">&quot;0.0.0.0&quot;</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ dockerfile-demo </span><span class="token function">more</span><span class="token plain"> app.py</span></div><div class="token-line"><span class="token plain">from flask </span><span class="token function">import</span><span class="token plain"> Flask</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">app </span><span class="token operator">=</span><span class="token plain"> Flask</span><span class="token punctuation">(</span><span class="token plain">__name__</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">@app.route</span><span class="token punctuation">(</span><span class="token string">&#x27;/&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">def hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain">:</span></div><div class="token-line"><span class="token plain">    </span><span class="token builtin class-name">return</span><span class="token plain"> </span><span class="token string">&#x27;Hello, world!&#x27;</span></div></pre></div><p>构建的时候，第一行输出就是发送build context。11.13MB （这里是Linux环境下的log）</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image build -t demo </span><span class="token builtin class-name">.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">Sending build context to Docker daemon  </span><span class="token number">11</span><span class="token plain">.13MB</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">1</span><span class="token plain">/7 </span><span class="token builtin class-name">:</span><span class="token plain"> FROM python:3.9.5-slim</span></div><div class="token-line"><span class="token plain"> ---</span><span class="token operator">&gt;</span><span class="token plain"> 609da079b03a</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">2</span><span class="token plain">/7 </span><span class="token builtin class-name">:</span><span class="token plain"> RUN pip </span><span class="token function">install</span><span class="token plain"> flask</span></div><div class="token-line"><span class="token plain"> ---</span><span class="token operator">&gt;</span><span class="token plain"> Using cache</span></div><div class="token-line"><span class="token plain"> ---</span><span class="token operator">&gt;</span><span class="token plain"> 955ce495635e</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">3</span><span class="token plain">/7 </span><span class="token builtin class-name">:</span><span class="token plain"> WORKDIR /src</span></div><div class="token-line"><span class="token plain"> ---</span><span class="token operator">&gt;</span><span class="token plain"> Using cache</span></div><div class="token-line"><span class="token plain"> ---</span><span class="token operator">&gt;</span><span class="token plain"> 1c2f968e9f9b</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">4</span><span class="token plain">/7 </span><span class="token builtin class-name">:</span><span class="token plain"> ENV </span><span class="token assign-left variable">FLASK_APP</span><span class="token operator">=</span><span class="token plain">app.py</span></div><div class="token-line"><span class="token plain"> ---</span><span class="token operator">&gt;</span><span class="token plain"> Using cache</span></div><div class="token-line"><span class="token plain"> ---</span><span class="token operator">&gt;</span><span class="token plain"> dceb15b338cf</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">5</span><span class="token plain">/7 </span><span class="token builtin class-name">:</span><span class="token plain"> COPY app.py /src/app.py</span></div><div class="token-line"><span class="token plain"> ---</span><span class="token operator">&gt;</span><span class="token plain"> Using cache</span></div><div class="token-line"><span class="token plain"> ---</span><span class="token operator">&gt;</span><span class="token plain"> 0d4dfef28b5f</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">6</span><span class="token plain">/7 </span><span class="token builtin class-name">:</span><span class="token plain"> EXPOSE </span><span class="token number">5000</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"> ---</span><span class="token operator">&gt;</span><span class="token plain"> Using cache</span></div><div class="token-line"><span class="token plain"> ---</span><span class="token operator">&gt;</span><span class="token plain"> 203e9865f0d9</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">7</span><span class="token plain">/7 </span><span class="token builtin class-name">:</span><span class="token plain"> CMD </span><span class="token punctuation">[</span><span class="token string">&quot;flask&quot;</span><span class="token plain">, </span><span class="token string">&quot;run&quot;</span><span class="token plain">, </span><span class="token string">&quot;-h&quot;</span><span class="token plain">, </span><span class="token string">&quot;0.0.0.0&quot;</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"> ---</span><span class="token operator">&gt;</span><span class="token plain"> Using cache</span></div><div class="token-line"><span class="token plain"> ---</span><span class="token operator">&gt;</span><span class="token plain"> 35b5efae1293</span></div><div class="token-line"><span class="token plain">Successfully built 35b5efae1293</span></div><div class="token-line"><span class="token plain">Successfully tagged demo:latest</span></div></pre></div><p><code>.</code> 这个参数就是代表了build context所指向的目录</p><h3 id="dockerignore-文件"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#dockerignore-文件"><span class="icon icon-link"></span></a>.dockerignore 文件</h3><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">.vscode/</span></div><div class="token-line"><span class="token plain">env/</span></div></pre></div><p>有了.dockerignore文件后，我们再build, build context就小了很多，4.096kB</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image build -t demo </span><span class="token builtin class-name">.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">Sending build context to Docker daemon  </span><span class="token number">4</span><span class="token plain">.096kB</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">1</span><span class="token plain">/7 </span><span class="token builtin class-name">:</span><span class="token plain"> FROM python:3.9.5-slim</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> 609da079b03a</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">2</span><span class="token plain">/7 </span><span class="token builtin class-name">:</span><span class="token plain"> RUN pip </span><span class="token function">install</span><span class="token plain"> flask</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> Using cache</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> 955ce495635e</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">3</span><span class="token plain">/7 </span><span class="token builtin class-name">:</span><span class="token plain"> WORKDIR /src</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> Using cache</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> 1c2f968e9f9b</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">4</span><span class="token plain">/7 </span><span class="token builtin class-name">:</span><span class="token plain"> ENV </span><span class="token assign-left variable">FLASK_APP</span><span class="token operator">=</span><span class="token plain">app.py</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> Using cache</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> dceb15b338cf</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">5</span><span class="token plain">/7 </span><span class="token builtin class-name">:</span><span class="token plain"> COPY </span><span class="token builtin class-name">.</span><span class="token plain"> /src/</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> a9a8f888fef3</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">6</span><span class="token plain">/7 </span><span class="token builtin class-name">:</span><span class="token plain"> EXPOSE </span><span class="token number">5000</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> Running </span><span class="token keyword">in</span><span class="token plain"> c71f34d32009</span></div><div class="token-line"><span class="token plain">Removing intermediate container c71f34d32009</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> fed6995d5a83</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">7</span><span class="token plain">/7 </span><span class="token builtin class-name">:</span><span class="token plain"> CMD </span><span class="token punctuation">[</span><span class="token string">&quot;flask&quot;</span><span class="token plain">, </span><span class="token string">&quot;run&quot;</span><span class="token plain">, </span><span class="token string">&quot;-h&quot;</span><span class="token plain">, </span><span class="token string">&quot;0.0.0.0&quot;</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> Running </span><span class="token keyword">in</span><span class="token plain"> 7ea669f59d5e</span></div><div class="token-line"><span class="token plain">Removing intermediate container 7ea669f59d5e</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> 079bae887a47</span></div><div class="token-line"><span class="token plain">Successfully built 079bae887a47</span></div><div class="token-line"><span class="token plain">Successfully tagged demo:latest</span></div></pre></div><h2 id="410-dockerfile-技巧镜像的多阶段构建"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#410-dockerfile-技巧镜像的多阶段构建"><span class="icon icon-link"></span></a>4.10 Dockerfile 技巧——镜像的多阶段构建</h2><p>这一节来聊聊多阶段构建，以及为什么要使用它。</p><h3 id="c语言例子"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#c语言例子"><span class="icon icon-link"></span></a>C语言例子</h3><p>假如有一个C的程序，我们想用Docker去做编译，然后执行可执行文件。</p><div class="__dumi-default-code-block"><pre class="prism-code language-c"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword">include</span><span class="token macro property"> </span><span class="token macro property string">&lt;stdio.h&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">void</span><span class="token plain"> </span><span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token plain"> argc</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">char</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain">argv</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;hello %s\n&quot;</span><span class="token punctuation">,</span><span class="token plain"> argv</span><span class="token punctuation">[</span><span class="token plain">argc </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>本地测试（如果你本地有C环境）</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ gcc --static -o hello hello.c</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">hello  hello.c</span></div><div class="token-line"><span class="token plain">$ ./hello </span><span class="token function">docker</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">hello </span><span class="token function">docker</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ ./hello world</span></div><div class="token-line"><span class="token plain">hello world</span></div><div class="token-line"><span class="token plain">$ ./hello friends</span></div><div class="token-line"><span class="token plain">hello friends</span></div><div class="token-line"><span class="token plain">$</span></div></pre></div><p>构建一个Docker镜像，因为要有C的环境，所以我们选择gcc这个image</p><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">FROM gcc:9.4</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">COPY hello.c /src/hello.c</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">WORKDIR /src</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">RUN gcc --static -o hello hello.c</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">ENTRYPOINT [ &quot;/src/hello&quot; ]</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">CMD []</span></div></pre></div><p>build和测试</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> build -t hello </span><span class="token builtin class-name">.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">Sending build context to Docker daemon   </span><span class="token number">5</span><span class="token plain">.12kB</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">1</span><span class="token plain">/6 </span><span class="token builtin class-name">:</span><span class="token plain"> FROM gcc:9.4</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> be1d0d9ce039</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">2</span><span class="token plain">/6 </span><span class="token builtin class-name">:</span><span class="token plain"> COPY hello.c /src/hello.c</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> Using cache</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> 70a624e3749b</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">3</span><span class="token plain">/6 </span><span class="token builtin class-name">:</span><span class="token plain"> WORKDIR /src</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> Using cache</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> 24e248c6b27c</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">4</span><span class="token plain">/6 </span><span class="token builtin class-name">:</span><span class="token plain"> RUN gcc --static -o hello hello.c</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> Using cache</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> db8ae7b42aff</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">5</span><span class="token plain">/6 </span><span class="token builtin class-name">:</span><span class="token plain"> ENTRYPOINT </span><span class="token punctuation">[</span><span class="token plain"> </span><span class="token string">&quot;/src/hello&quot;</span><span class="token plain"> </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> Using cache</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> 7f307354ee45</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">6</span><span class="token plain">/6 </span><span class="token builtin class-name">:</span><span class="token plain"> CMD </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> Using cache</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> 7cfa0cbe4e2a</span></div><div class="token-line"><span class="token plain">Successfully built 7cfa0cbe4e2a</span></div><div class="token-line"><span class="token plain">Successfully tagged hello:latest</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">REPOSITORY     TAG          IMAGE ID       CREATED       SIZE</span></div><div class="token-line"><span class="token plain">hello          latest       7cfa0cbe4e2a   </span><span class="token number">2</span><span class="token plain"> hours ago   </span><span class="token number">1</span><span class="token plain">.14GB</span></div><div class="token-line"><span class="token plain">gcc            </span><span class="token number">9.4</span><span class="token plain">          be1d0d9ce039   </span><span class="token number">9</span><span class="token plain"> days ago    </span><span class="token number">1</span><span class="token plain">.14GB</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> run --rm -it hello </span><span class="token function">docker</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">hello </span><span class="token function">docker</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> run --rm -it hello world</span></div><div class="token-line"><span class="token plain">hello world</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> run --rm -it hello friends</span></div><div class="token-line"><span class="token plain">hello friends</span></div><div class="token-line"><span class="token plain">$</span></div></pre></div><p>可以看到镜像非常的大，1.14GB</p><p>实际上当我们把hello.c编译完以后，并不需要这样一个大的GCC环境，一个小的alpine镜像就可以了。</p><p>这时候我们就可以使用多阶段构建了。</p><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">FROM gcc:9.4 AS builder</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">COPY hello.c /src/hello.c</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">WORKDIR /src</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">RUN gcc --static -o hello hello.c</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">FROM alpine:3.13.5</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">COPY --from=builder /src/hello /src/hello</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">ENTRYPOINT [ &quot;/src/hello&quot; ]</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">CMD []</span></div></pre></div><p>测试</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> build -t hello-apline -f Dockerfile-new </span><span class="token builtin class-name">.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">Sending build context to Docker daemon   </span><span class="token number">5</span><span class="token plain">.12kB</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">1</span><span class="token plain">/8 </span><span class="token builtin class-name">:</span><span class="token plain"> FROM gcc:9.4 AS builder</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> be1d0d9ce039</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">2</span><span class="token plain">/8 </span><span class="token builtin class-name">:</span><span class="token plain"> COPY hello.c /src/hello.c</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> Using cache</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> 70a624e3749b</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">3</span><span class="token plain">/8 </span><span class="token builtin class-name">:</span><span class="token plain"> WORKDIR /src</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> Using cache</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> 24e248c6b27c</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">4</span><span class="token plain">/8 </span><span class="token builtin class-name">:</span><span class="token plain"> RUN gcc --static -o hello hello.c</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> Using cache</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> db8ae7b42aff</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">5</span><span class="token plain">/8 </span><span class="token builtin class-name">:</span><span class="token plain"> FROM alpine:3.13.5</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> 6dbb9cc54074</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">6</span><span class="token plain">/8 </span><span class="token builtin class-name">:</span><span class="token plain"> COPY --from</span><span class="token operator">=</span><span class="token plain">builder /src/hello /src/hello</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> Using cache</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> 18c2bce629fb</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">7</span><span class="token plain">/8 </span><span class="token builtin class-name">:</span><span class="token plain"> ENTRYPOINT </span><span class="token punctuation">[</span><span class="token plain"> </span><span class="token string">&quot;/src/hello&quot;</span><span class="token plain"> </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> Using cache</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> 8dfb9d9d6010</span></div><div class="token-line"><span class="token plain">Step </span><span class="token number">8</span><span class="token plain">/8 </span><span class="token builtin class-name">:</span><span class="token plain"> CMD </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> Using cache</span></div><div class="token-line"><span class="token plain">---</span><span class="token operator">&gt;</span><span class="token plain"> 446baf852214</span></div><div class="token-line"><span class="token plain">Successfully built 446baf852214</span></div><div class="token-line"><span class="token plain">Successfully tagged hello-apline:latest</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">REPOSITORY     TAG          IMAGE ID       CREATED       SIZE</span></div><div class="token-line"><span class="token plain">hello-alpine   latest       446baf852214   </span><span class="token number">2</span><span class="token plain"> hours ago   </span><span class="token number">6</span><span class="token plain">.55MB</span></div><div class="token-line"><span class="token plain">hello          latest       7cfa0cbe4e2a   </span><span class="token number">2</span><span class="token plain"> hours ago   </span><span class="token number">1</span><span class="token plain">.14GB</span></div><div class="token-line"><span class="token plain">demo           latest       079bae887a47   </span><span class="token number">2</span><span class="token plain"> hours ago   125MB</span></div><div class="token-line"><span class="token plain">gcc            </span><span class="token number">9.4</span><span class="token plain">          be1d0d9ce039   </span><span class="token number">9</span><span class="token plain"> days ago    </span><span class="token number">1</span><span class="token plain">.14GB</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> run --rm -it hello-alpine </span><span class="token function">docker</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">hello </span><span class="token function">docker</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> run --rm -it hello-alpine world</span></div><div class="token-line"><span class="token plain">hello world</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> run --rm -it hello-alpine friends</span></div><div class="token-line"><span class="token plain">hello friends</span></div><div class="token-line"><span class="token plain">$</span></div></pre></div><p>可以看到这个镜像非常小，只有6.55MB</p><h2 id="411-dockerfile-技巧尽量使用非root用户"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#411-dockerfile-技巧尽量使用非root用户"><span class="icon icon-link"></span></a>4.11 Dockerfile 技巧——尽量使用非root用户</h2><h3 id="root的危险性"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#root的危险性"><span class="icon icon-link"></span></a>Root的危险性</h3><p>docker的root权限一直是其遭受诟病的地方，docker的root权限有那么危险么？我们举个例子。</p><p>假如我们有一个用户，叫demo，它本身不具有sudo的权限，所以就有很多文件无法进行读写操作，比如/root目录它是无法查看的。</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">[</span><span class="token plain">demo@docker-host ~</span><span class="token punctuation">]</span><span class="token plain">$ </span><span class="token function">sudo</span><span class="token plain"> </span><span class="token function">ls</span><span class="token plain"> /root</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">[</span><span class="token plain">sudo</span><span class="token punctuation">]</span><span class="token plain"> password </span><span class="token keyword">for</span><span class="token plain"> demo:</span></div><div class="token-line"><span class="token plain">demo is not </span><span class="token keyword">in</span><span class="token plain"> the sudoers file.  This incident will be reported.</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">[</span><span class="token plain">demo@docker-host ~</span><span class="token punctuation">]</span><span class="token plain">$</span></div></pre></div><p>但是这个用户有执行docker的权限，也就是它在docker这个group里。</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">[</span><span class="token plain">demo@docker-host ~</span><span class="token punctuation">]</span><span class="token plain">$ </span><span class="token function">groups</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">demo </span><span class="token function">docker</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">[</span><span class="token plain">demo@docker-host ~</span><span class="token punctuation">]</span><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">REPOSITORY   TAG       IMAGE ID       CREATED      SIZE</span></div><div class="token-line"><span class="token plain">busybox      latest    a9d583973f65   </span><span class="token number">2</span><span class="token plain"> days ago   </span><span class="token number">1</span><span class="token plain">.23MB</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">[</span><span class="token plain">demo@docker-host ~</span><span class="token punctuation">]</span><span class="token plain">$</span></div></pre></div><p>这时，我们就可以通过Docker做很多越权的事情了，比如，我们可以把这个无法查看的/root目录映射到docker container里，你就可以自由进行查看了。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">[demo@docker-host vagrant]$ docker run -it -v /root/:/root/tmp busybox sh</span></div><div class="token-line"><span class="token plain">/ # cd /root/tmp</span></div><div class="token-line"><span class="token plain">~/tmp # ls</span></div><div class="token-line"><span class="token plain">anaconda-ks.cfg  original-ks.cfg</span></div><div class="token-line"><span class="token plain">~/tmp # ls -l</span></div><div class="token-line"><span class="token plain">total 16</span></div><div class="token-line"><span class="token plain">-rw-------    1 root     root          5570 Apr 30  2020 anaconda-ks.cfg</span></div><div class="token-line"><span class="token plain">-rw-------    1 root     root          5300 Apr 30  2020 original-ks.cfg</span></div><div class="token-line"><span class="token plain">~/tmp #</span></div></pre></div><p>更甚至我们可以给我们自己加sudo权限。我们现在没有sudo权限</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">[</span><span class="token plain">demo@docker-host ~</span><span class="token punctuation">]</span><span class="token plain">$ </span><span class="token function">sudo</span><span class="token plain"> </span><span class="token function">vim</span><span class="token plain"> /etc/sudoers</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">[</span><span class="token plain">sudo</span><span class="token punctuation">]</span><span class="token plain"> password </span><span class="token keyword">for</span><span class="token plain"> demo:</span></div><div class="token-line"><span class="token plain">demo is not </span><span class="token keyword">in</span><span class="token plain"> the sudoers file.  This incident will be reported.</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">[</span><span class="token plain">demo@docker-host ~</span><span class="token punctuation">]</span><span class="token plain">$</span></div></pre></div><p>但是我可以给自己添加。</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">[</span><span class="token plain">demo@docker-host ~</span><span class="token punctuation">]</span><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> run -it -v /etc/sudoers:/root/sudoers busybox </span><span class="token function">sh</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">/ </span><span class="token comment"># echo &quot;demo    ALL=(ALL)       ALL&quot; &gt;&gt; /root/sudoers</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">/ </span><span class="token comment"># more /root/sudoers | grep demo</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">demo    </span><span class="token assign-left variable">ALL</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token plain">ALL</span><span class="token punctuation">)</span><span class="token plain">       ALL</span></div></pre></div><p>然后退出container，bingo，我们有sudo权限了。</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">[</span><span class="token plain">demo@docker-host ~</span><span class="token punctuation">]</span><span class="token plain">$ </span><span class="token function">sudo</span><span class="token plain"> </span><span class="token function">more</span><span class="token plain"> /etc/sudoers </span><span class="token operator">|</span><span class="token plain"> </span><span class="token function">grep</span><span class="token plain"> demo</span></div><div class="token-line"><span class="token plain">demo    </span><span class="token assign-left variable">ALL</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token plain">ALL</span><span class="token punctuation">)</span><span class="token plain">       ALL</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">[</span><span class="token plain">demo@docker-host ~</span><span class="token punctuation">]</span><span class="token plain">$</span></div></pre></div><h3 id="如何使用非root用户"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#如何使用非root用户"><span class="icon icon-link"></span></a>如何使用非root用户</h3><p>我们准备两个Dockerfile，第一个Dockerfile如下，其中app.py文件源码请参考 一起构建一个 Python Flask 镜像 ：</p><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">FROM python:3.9.5-slim</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">RUN pip install flask</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">COPY app.py /src/app.py</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">WORKDIR /src</span></div><div class="token-line"><span class="token plain">ENV FLASK_APP=app.py</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">EXPOSE 5000</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">CMD [&quot;flask&quot;, &quot;run&quot;, &quot;-h&quot;, &quot;0.0.0.0&quot;]</span></div></pre></div><p>假设构建的镜像名字为 <code>flask-demo</code></p><p>第二个Dockerfile，使用非root用户来构建这个镜像，名字叫 <code>flask-no-root</code> Dockerfile如下：</p><ul><li>通过groupadd和useradd创建一个flask的组和用户</li><li>通过USER指定后面的命令要以flask这个用户的身份运行</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-dockerfile"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">FROM python:3.9.5-slim</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">RUN pip install flask &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    groupadd -r flask &amp;&amp; useradd -r -g flask flask &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    mkdir /src &amp;&amp; \</span></div><div class="token-line"><span class="token plain">    chown -R flask:flask /src</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">USER flask</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">COPY app.py /src/app.py</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">WORKDIR /src</span></div><div class="token-line"><span class="token plain">ENV FLASK_APP=app.py</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">EXPOSE 5000</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">CMD [&quot;flask&quot;, &quot;run&quot;, &quot;-h&quot;, &quot;0.0.0.0&quot;]</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">REPOSITORY      TAG          IMAGE ID       CREATED          SIZE</span></div><div class="token-line"><span class="token plain">flask-no-root   latest       80996843356e   </span><span class="token number">41</span><span class="token plain"> minutes ago   126MB</span></div><div class="token-line"><span class="token plain">flask-demo      latest       2696c68b51ce   </span><span class="token number">49</span><span class="token plain"> minutes ago   125MB</span></div><div class="token-line"><span class="token plain">python          </span><span class="token number">3.9</span><span class="token plain">.5-slim   609da079b03a   </span><span class="token number">2</span><span class="token plain"> weeks ago      115MB</span></div></pre></div><p>分别使用这两个镜像创建两个容器</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> run -d --name flask-root flask-demo</span></div><div class="token-line"><span class="token plain">b31588bae216951e7981ce14290d74d377eef477f71e1506b17ee505d7994774</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> run -d --name flask-no-root flask-no-root</span></div><div class="token-line"><span class="token plain">83aaa4a116608ec98afff2a142392119b7efe53617db213e8c7276ab0ae0aaa0</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container </span><span class="token function">ps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">CONTAINER ID   IMAGE           COMMAND                  CREATED          STATUS          PORTS      NAMES</span></div><div class="token-line"><span class="token plain">83aaa4a11660   flask-no-root   </span><span class="token string">&quot;flask run -h 0.0.0.0&quot;</span><span class="token plain">   </span><span class="token number">4</span><span class="token plain"> seconds ago    Up </span><span class="token number">3</span><span class="token plain"> seconds    </span><span class="token number">5000</span><span class="token plain">/tcp   flask-no-root</span></div><div class="token-line"><span class="token plain">b31588bae216   flask-demo      </span><span class="token string">&quot;flask run -h 0.0.0.0&quot;</span><span class="token plain">   </span><span class="token number">16</span><span class="token plain"> seconds ago   Up </span><span class="token number">15</span><span class="token plain"> seconds   </span><span class="token number">5000</span><span class="token plain">/tcp   flask-root</span></div></pre></div><h1 id="5-docker的存储"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#5-docker的存储"><span class="icon icon-link"></span></a>5. Docker的存储</h1><h2 id="51-介绍"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#51-介绍"><span class="icon icon-link"></span></a>5.1 介绍</h2><p>默认情况下，在运行中的容器里创建的文件，被保存在一个可写的容器层：</p><ul><li>如果容器被删除了，则数据也没有了</li><li>这个可写的容器层是和特定的容器绑定的，也就是这些数据无法方便的和其它容器共享</li></ul><p>Docker主要提供了两种方式做数据的持久化</p><ul><li>Data Volume, 由Docker管理，(/var/lib/docker/volumes/ Linux), 持久化数据的最好方式</li><li>Bind Mount，由用户指定存储的数据具体mount在系统什么位置</li></ul><p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2021-11-14-025605.png" alt="docker-volume"/></p><h2 id="52-data-volume"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#52-data-volume"><span class="icon icon-link"></span></a>5.2 Data Volume</h2><p>如何进行数据的持久化。</p><h3 id="环境准备"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#环境准备"><span class="icon icon-link"></span></a>环境准备</h3><p>准备一个Dockerfile 和一个 my-cron的文件</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">Dockerfile  my-cron</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">more</span><span class="token plain"> Dockerfile</span></div><div class="token-line"><span class="token plain">FROM alpine:latest</span></div><div class="token-line"><span class="token plain">RUN apk update</span></div><div class="token-line"><span class="token plain">RUN apk --no-cache </span><span class="token function">add</span><span class="token plain"> </span><span class="token function">curl</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">ENV </span><span class="token assign-left variable">SUPERCRONIC_URL</span><span class="token operator">=</span><span class="token plain">https://github.com/aptible/supercronic/releases/download/v0.1.12/supercronic-linux-amd64 </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token assign-left variable">SUPERCRONIC</span><span class="token operator">=</span><span class="token plain">supercronic-linux-amd64 </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token assign-left variable">SUPERCRONIC_SHA1SUM</span><span class="token operator">=</span><span class="token plain">048b95b48b708983effb2e5c935a1ef8483d9e3e</span></div><div class="token-line"><span class="token plain">RUN </span><span class="token function">curl</span><span class="token plain"> -fsSLO </span><span class="token string">&quot;</span><span class="token string variable">$SUPERCRONIC_URL</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string">&quot;</span><span class="token string variable">${SUPERCRONIC_SHA1SUM}</span><span class="token string">  </span><span class="token string variable">${SUPERCRONIC}</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> sha1sum -c - </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token function">chmod</span><span class="token plain"> +x </span><span class="token string">&quot;</span><span class="token string variable">$SUPERCRONIC</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token function">mv</span><span class="token plain"> </span><span class="token string">&quot;</span><span class="token string variable">$SUPERCRONIC</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token string">&quot;/usr/local/bin/</span><span class="token string variable">${SUPERCRONIC}</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token function">ln</span><span class="token plain"> -s </span><span class="token string">&quot;/usr/local/bin/</span><span class="token string variable">${SUPERCRONIC}</span><span class="token string">&quot;</span><span class="token plain"> /usr/local/bin/supercronic</span></div><div class="token-line"><span class="token plain">COPY my-cron /app/my-cron</span></div><div class="token-line"><span class="token plain">WORKDIR /app</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">VOLUME </span><span class="token punctuation">[</span><span class="token string">&quot;/app&quot;</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># RUN cron job</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">CMD </span><span class="token punctuation">[</span><span class="token string">&quot;/usr/local/bin/supercronic&quot;</span><span class="token plain">, </span><span class="token string">&quot;/app/my-cron&quot;</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">more</span><span class="token plain"> my-cron</span></div><div class="token-line"><span class="token plain">*/1 * * * * </span><span class="token function">date</span><span class="token plain"> </span><span class="token operator">&gt;&gt;</span><span class="token plain"> /app/test.txt</span></div></pre></div><h3 id="构建镜像"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#构建镜像"><span class="icon icon-link"></span></a>构建镜像</h3><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image build -t my-cron </span><span class="token builtin class-name">.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span></div><div class="token-line"><span class="token plain">my-cron      latest    e9fbd9a562c9   </span><span class="token number">4</span><span class="token plain"> seconds ago   </span><span class="token number">24</span><span class="token plain">.7MB</span></div></pre></div><h3 id="创建容器不指定-v参数"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#创建容器不指定-v参数"><span class="icon icon-link"></span></a>创建容器(不指定-v参数)</h3><p>此时Docker会自动创建一个随机名字的volume，去存储我们在Dockerfile定义的volume <code>VOLUME [&quot;/app&quot;]</code></p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> run -d my-cron</span></div><div class="token-line"><span class="token plain">9a8fa93f03c42427a498b21ac520660752122e20bcdbf939661646f71d277f8f</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> volume </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">DRIVER    VOLUME NAME</span></div><div class="token-line"><span class="token plain"></span><span class="token builtin class-name">local</span><span class="token plain">     043a196c21202c484c69f2098b6b9ec22b9a9e4e4bb8d4f55a4c3dce13c15264</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> volume inspect 043a196c21202c484c69f2098b6b9ec22b9a9e4e4bb8d4f55a4c3dce13c15264</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;CreatedAt&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;2021-06-22T23:06:13+02:00&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Driver&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;local&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Labels&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> null,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Mountpoint&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;/var/lib/docker/volumes/043a196c21202c484c69f2098b6b9ec22b9a9e4e4bb8d4f55a4c3dce13c15264/_data&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Name&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;043a196c21202c484c69f2098b6b9ec22b9a9e4e4bb8d4f55a4c3dce13c15264&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Options&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> null,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Scope&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;local&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span></div></pre></div><p>在这个Volume的mountpoint可以发现容器创建的文件</p><h3 id="创建容器指定-v参数"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#创建容器指定-v参数"><span class="icon icon-link"></span></a>创建容器(指定-v参数)</h3><p>在创建容器的时候通过 <code>-v</code> 参数我们可以手动的指定需要创建Volume的名字，以及对应于容器内的路径，这个路径是可以任意的，不必需要在Dockerfile里通过VOLUME定义</p><p>比如我们把上面的Dockerfile里的VOLUME删除</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">FROM alpine:latest</span></div><div class="token-line"><span class="token plain">RUN apk update</span></div><div class="token-line"><span class="token plain">RUN apk --no-cache </span><span class="token function">add</span><span class="token plain"> </span><span class="token function">curl</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">ENV </span><span class="token assign-left variable">SUPERCRONIC_URL</span><span class="token operator">=</span><span class="token plain">https://github.com/aptible/supercronic/releases/download/v0.1.12/supercronic-linux-amd64 </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token assign-left variable">SUPERCRONIC</span><span class="token operator">=</span><span class="token plain">supercronic-linux-amd64 </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token assign-left variable">SUPERCRONIC_SHA1SUM</span><span class="token operator">=</span><span class="token plain">048b95b48b708983effb2e5c935a1ef8483d9e3e</span></div><div class="token-line"><span class="token plain">RUN </span><span class="token function">curl</span><span class="token plain"> -fsSLO </span><span class="token string">&quot;</span><span class="token string variable">$SUPERCRONIC_URL</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string">&quot;</span><span class="token string variable">${SUPERCRONIC_SHA1SUM}</span><span class="token string">  </span><span class="token string variable">${SUPERCRONIC}</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> sha1sum -c - </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token function">chmod</span><span class="token plain"> +x </span><span class="token string">&quot;</span><span class="token string variable">$SUPERCRONIC</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token function">mv</span><span class="token plain"> </span><span class="token string">&quot;</span><span class="token string variable">$SUPERCRONIC</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token string">&quot;/usr/local/bin/</span><span class="token string variable">${SUPERCRONIC}</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token function">ln</span><span class="token plain"> -s </span><span class="token string">&quot;/usr/local/bin/</span><span class="token string variable">${SUPERCRONIC}</span><span class="token string">&quot;</span><span class="token plain"> /usr/local/bin/supercronic</span></div><div class="token-line"><span class="token plain">COPY my-cron /app/my-cron</span></div><div class="token-line"><span class="token plain">WORKDIR /app</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># RUN cron job</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">CMD </span><span class="token punctuation">[</span><span class="token string">&quot;/usr/local/bin/supercronic&quot;</span><span class="token plain">, </span><span class="token string">&quot;/app/my-cron&quot;</span><span class="token punctuation">]</span></div></pre></div><p>重新build镜像，然后创建容器，加-v参数</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image build -t my-cron </span><span class="token builtin class-name">.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container run -d -v cron-data:/app my-cron</span></div><div class="token-line"><span class="token plain">43c6d0357b0893861092a752c61ab01bdfa62ea766d01d2fcb8b3ecb6c88b3de</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> volume </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">DRIVER    VOLUME NAME</span></div><div class="token-line"><span class="token plain"></span><span class="token builtin class-name">local</span><span class="token plain">     cron-data</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> volume inspect cron-data</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;CreatedAt&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;2021-06-22T23:25:02+02:00&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Driver&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;local&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Labels&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> null,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Mountpoint&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;/var/lib/docker/volumes/cron-data/_data&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Name&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;cron-data&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Options&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> null,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Scope&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;local&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">ls</span><span class="token plain"> /var/lib/docker/volumes/cron-data/_data</span></div><div class="token-line"><span class="token plain">my-cron</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">ls</span><span class="token plain"> /var/lib/docker/volumes/cron-data/_data</span></div><div class="token-line"><span class="token plain">my-cron  test.txt</span></div></pre></div><p>Volume也创建了。</p><h3 id="环境清理"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#环境清理"><span class="icon icon-link"></span></a>环境清理</h3><p>强制删除所有容器，系统清理和volume清理</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> </span><span class="token function">rm</span><span class="token plain"> -f </span><span class="token variable">$(</span><span class="token variable function">docker</span><span class="token variable"> container </span><span class="token variable function">ps</span><span class="token variable"> -aq</span><span class="token variable">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> system prune -f</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> volume prune -f</span></div></pre></div><h2 id="53-data-volume-练习-mysql"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#53-data-volume-练习-mysql"><span class="icon icon-link"></span></a>5.3 Data Volume 练习 MySQL</h2><p>使用MySQL官方镜像，tag版本5.7</p><p>Dockerfile可以在这里查看 <a target="_blank" rel="noopener noreferrer" href="https://github.com/docker-library/mysql/tree/master/5.7">https://github.com/docker-library/mysql/tree/master/5.7<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h3 id="准备镜像"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#准备镜像"><span class="icon icon-link"></span></a>准备镜像</h3><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> pull mysql:5.7</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> image </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">REPOSITORY   TAG       IMAGE ID       CREATED        SIZE</span></div><div class="token-line"><span class="token plain">mysql        </span><span class="token number">5.7</span><span class="token plain">       2c9028880e58   </span><span class="token number">5</span><span class="token plain"> weeks ago    447MB</span></div></pre></div><h3 id="创建容器"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#创建容器"><span class="icon icon-link"></span></a>创建容器</h3><p>关于MySQL的镜像使用，可以参考dockerhub <a target="_blank" rel="noopener noreferrer" href="https://hub.docker.com/_/mysql?tab=description&amp;page=1&amp;ordering=last_updated">https://hub.docker.com/_/mysql?tab=description&amp;page=1&amp;ordering=last_updated<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>关于Dockerfile Volume的定义，可以参考 <a target="_blank" rel="noopener noreferrer" href="https://github.com/docker-library/mysql/tree/master/5.7">https://github.com/docker-library/mysql/tree/master/5.7<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container run --name some-mysql -e </span><span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token plain">my-secret-pw -d -v mysql-data:/var/lib/mysql mysql:5.7</span></div><div class="token-line"><span class="token plain">02206eb369be08f660bf86b9d5be480e24bb6684c8a938627ebfbcfc0fd9e48e</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> volume </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">DRIVER    VOLUME NAME</span></div><div class="token-line"><span class="token plain"></span><span class="token builtin class-name">local</span><span class="token plain">     mysql-data</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> volume inspect mysql-data</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;CreatedAt&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;2021-06-21T23:55:23+02:00&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Driver&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;local&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Labels&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> null,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Mountpoint&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;/var/lib/docker/volumes/mysql-data/_data&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Name&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;mysql-data&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Options&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> null,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Scope&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;local&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$</span></div></pre></div><h3 id="数据库写入数据"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#数据库写入数据"><span class="icon icon-link"></span></a>数据库写入数据</h3><p>进入MySQL的shell，密码是 <code>my-secret-pw</code></p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container </span><span class="token builtin class-name">exec</span><span class="token plain"> -it 022 </span><span class="token function">sh</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># mysql -u root -p</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">Enter password:</span></div><div class="token-line"><span class="token plain">Welcome to the MySQL monitor.  Commands end with </span><span class="token punctuation">;</span><span class="token plain"> or </span><span class="token punctuation">\</span><span class="token plain">g.</span></div><div class="token-line"><span class="token plain">Your MySQL connection </span><span class="token function">id</span><span class="token plain"> is </span><span class="token number">2</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">Server version: </span><span class="token number">5.7</span><span class="token plain">.34 MySQL Community Server </span><span class="token punctuation">(</span><span class="token plain">GPL</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Copyright </span><span class="token punctuation">(</span><span class="token plain">c</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token number">2000</span><span class="token plain">, </span><span class="token number">2021</span><span class="token plain">, Oracle and/or its affiliates.</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Oracle is a registered trademark of Oracle Corporation and/or its</span></div><div class="token-line"><span class="token plain">affiliates. Other names may be trademarks of their respective</span></div><div class="token-line"><span class="token plain">owners.</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Type </span><span class="token string">&#x27;help;&#x27;</span><span class="token plain"> or </span><span class="token string">&#x27;\h&#x27;</span><span class="token plain"> </span><span class="token keyword">for</span><span class="token plain"> help. Type </span><span class="token string">&#x27;\c&#x27;</span><span class="token plain"> to </span><span class="token function">clear</span><span class="token plain"> the current input statement.</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">mysql</span><span class="token operator">&gt;</span><span class="token plain"> show databases</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">+--------------------+</span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain"> Database           </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">+--------------------+</span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain"> information_schema </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain"> mysql              </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain"> performance_schema </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain"> sys                </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">+--------------------+</span></div><div class="token-line"><span class="token plain"></span><span class="token number">4</span><span class="token plain"> rows </span><span class="token keyword">in</span><span class="token plain"> </span><span class="token builtin class-name">set</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token number">0.00</span><span class="token plain"> sec</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">mysql</span><span class="token operator">&gt;</span><span class="token plain"> create database demo</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">Query OK, </span><span class="token number">1</span><span class="token plain"> row affected </span><span class="token punctuation">(</span><span class="token number">0.00</span><span class="token plain"> sec</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">mysql</span><span class="token operator">&gt;</span><span class="token plain"> show databases</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">+--------------------+</span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain"> Database           </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">+--------------------+</span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain"> information_schema </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain"> demo               </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain"> mysql              </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain"> performance_schema </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain"> sys                </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">+--------------------+</span></div><div class="token-line"><span class="token plain"></span><span class="token number">5</span><span class="token plain"> rows </span><span class="token keyword">in</span><span class="token plain"> </span><span class="token builtin class-name">set</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token number">0.00</span><span class="token plain"> sec</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">mysql</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token builtin class-name">exit</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">Bye</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># exit</span></div></pre></div><p>创建了一个叫 demo的数据库</p><p>查看data volume</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> volume inspect mysql-data</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;CreatedAt&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;2021-06-22T00:01:34+02:00&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Driver&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;local&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Labels&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> null,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Mountpoint&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;/var/lib/docker/volumes/mysql-data/_data&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Name&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;mysql-data&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Options&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> null,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Scope&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;local&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">ls</span><span class="token plain">  /var/lib/docker/volumes/mysql-data/_data</span></div><div class="token-line"><span class="token plain">auto.cnf    client-cert.pem  ib_buffer_pool  ibdata1  performance_schema  server-cert.pem</span></div><div class="token-line"><span class="token plain">ca-key.pem  client-key.pem   ib_logfile0     ibtmp1   private_key.pem     server-key.pem</span></div><div class="token-line"><span class="token plain">ca.pem      demo             ib_logfile1     mysql    public_key.pem      sys</span></div><div class="token-line"><span class="token plain">$</span></div></pre></div><h2 id="53--多个机器之间的容器共享数据"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#53--多个机器之间的容器共享数据"><span class="icon icon-link"></span></a>5.3  多个机器之间的容器共享数据</h2><p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2021-11-14-031247.png" alt="multi-host-volume"/></p><p>官方参考链接 <a target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/storage/volumes/#share-data-among-machines">https://docs.docker.com/storage/volumes/#share-data-among-machines<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>Docker的volume支持多种driver。默认创建的volume driver都是local</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> volume inspect vscode</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;CreatedAt&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;2021-06-23T21:33:57Z&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Driver&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;local&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Labels&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> null,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Mountpoint&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;/var/lib/docker/volumes/vscode/_data&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Name&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;vscode&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Options&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> null,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Scope&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;local&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span></div></pre></div><p>这一节我们看看一个叫sshfs的driver，如何让docker使用不在同一台机器上的文件系统做volume</p><h3 id="环境准备-1"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#环境准备-1"><span class="icon icon-link"></span></a>环境准备</h3><p>准备三台Linux机器，之间可以通过SSH相互通信。</p><div class="__dumi-default-table"><div class="__dumi-default-table-content"><table><thead><tr><th>hostname</th><th>ip</th><th>ssh username</th><th>ssh password</th></tr></thead><tbody><tr><td>docker-host1</td><td>192.168.200.10</td><td>vagrant</td><td>vagrant</td></tr><tr><td>docker-host2</td><td>192.168.200.11</td><td>vagrant</td><td>vagrant</td></tr><tr><td>docker-host3</td><td>192.168.200.12</td><td>vagrant</td><td>vagrant</td></tr></tbody></table></div></div><h3 id="安装plugin"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#安装plugin"><span class="icon icon-link"></span></a>安装plugin</h3><p>在其中两台机器上安装一个plugin <code>vieux/sshfs</code></p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">[</span><span class="token plain">vagrant@docker-host1 ~</span><span class="token punctuation">]</span><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> plugin </span><span class="token function">install</span><span class="token plain"> --grant-all-permissions vieux/sshfs</span></div><div class="token-line"><span class="token plain">latest: Pulling from vieux/sshfs</span></div><div class="token-line"><span class="token plain">Digest: sha256:1d3c3e42c12138da5ef7873b97f7f32cf99fb6edde75fa4f0bcf9ed277855811</span></div><div class="token-line"><span class="token plain">52d435ada6a4: Complete</span></div><div class="token-line"><span class="token plain">Installed plugin vieux/sshfs</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">[</span><span class="token plain">vagrant@docker-host2 ~</span><span class="token punctuation">]</span><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> plugin </span><span class="token function">install</span><span class="token plain"> --grant-all-permissions vieux/sshfs</span></div><div class="token-line"><span class="token plain">latest: Pulling from vieux/sshfs</span></div><div class="token-line"><span class="token plain">Digest: sha256:1d3c3e42c12138da5ef7873b97f7f32cf99fb6edde75fa4f0bcf9ed277855811</span></div><div class="token-line"><span class="token plain">52d435ada6a4: Complete</span></div><div class="token-line"><span class="token plain">Installed plugin vieux/sshfs</span></div></pre></div><h3 id="创建volume"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#创建volume"><span class="icon icon-link"></span></a>创建volume</h3><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">[</span><span class="token plain">vagrant@docker-host1 ~</span><span class="token punctuation">]</span><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> volume create --driver vieux/sshfs </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                          -o </span><span class="token assign-left variable">sshcmd</span><span class="token operator">=</span><span class="token plain">vagrant@192.168.200.12:/home/vagrant </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                          -o </span><span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token plain">vagrant </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                          sshvolume</span></div></pre></div><p>查看</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">[</span><span class="token plain">vagrant@docker-host1 ~</span><span class="token punctuation">]</span><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> volume </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">DRIVER               VOLUME NAME</span></div><div class="token-line"><span class="token plain">vieux/sshfs:latest   sshvolume</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">[</span><span class="token plain">vagrant@docker-host1 ~</span><span class="token punctuation">]</span><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> volume inspect sshvolume</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;CreatedAt&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;0001-01-01T00:00:00Z&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Driver&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;vieux/sshfs:latest&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Labels&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Mountpoint&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;/mnt/volumes/f59e848643f73d73a21b881486d55b33&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Name&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;sshvolume&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Options&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token string">&quot;password&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;vagrant&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">            </span><span class="token string">&quot;sshcmd&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;vagrant@192.168.200.12:/home/vagrant&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Scope&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;local&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span></div></pre></div><h3 id="创建容器挂载volume"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#创建容器挂载volume"><span class="icon icon-link"></span></a>创建容器挂载Volume</h3><p>创建容器，挂载sshvolume到/app目录，然后进入容器的shell，在/app目录创建一个test.txt文件</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">[</span><span class="token plain">vagrant@docker-host1 ~</span><span class="token punctuation">]</span><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> run -it -v sshvolume:/app busybox </span><span class="token function">sh</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">Unable to </span><span class="token function">find</span><span class="token plain"> image </span><span class="token string">&#x27;busybox:latest&#x27;</span><span class="token plain"> locally</span></div><div class="token-line"><span class="token plain">latest: Pulling from library/busybox</span></div><div class="token-line"><span class="token plain">b71f96345d44: Pull complete</span></div><div class="token-line"><span class="token plain">Digest: sha256:930490f97e5b921535c153e0e7110d251134cc4b72bbb8133c6a5065cc68580d</span></div><div class="token-line"><span class="token plain">Status: Downloaded newer image </span><span class="token keyword">for</span><span class="token plain"> busybox:latest</span></div><div class="token-line"><span class="token plain">/ </span><span class="token comment">#</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">/ </span><span class="token comment"># ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">app   bin   dev   etc   home  proc  root  sys   tmp   usr   var</span></div><div class="token-line"><span class="token plain">/ </span><span class="token comment"># cd /app</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">/app </span><span class="token comment"># ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">/app </span><span class="token comment"># echo &quot;this is ssh volume&quot;&gt; test.txt</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">/app </span><span class="token comment"># ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">test.txt</span></div><div class="token-line"><span class="token plain">/app </span><span class="token comment"># more test.txt</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">this is </span><span class="token function">ssh</span><span class="token plain"> volume</span></div><div class="token-line"><span class="token plain">/app </span><span class="token comment">#</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">/app </span><span class="token comment">#</span></div></pre></div><p>这个文件我们可以在docker-host3上看到</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">[</span><span class="token plain">vagrant@docker-host3 ~</span><span class="token punctuation">]</span><span class="token plain">$ </span><span class="token builtin class-name">pwd</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">/home/vagrant</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">[</span><span class="token plain">vagrant@docker-host3 ~</span><span class="token punctuation">]</span><span class="token plain">$ </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">test.txt</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">[</span><span class="token plain">vagrant@docker-host3 ~</span><span class="token punctuation">]</span><span class="token plain">$ </span><span class="token function">more</span><span class="token plain"> test.txt</span></div><div class="token-line"><span class="token plain">this is </span><span class="token function">ssh</span><span class="token plain"> volume</span></div></pre></div><h1 id="6-docker的网络"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#6-docker的网络"><span class="icon icon-link"></span></a>6. Docker的网络</h1><h2 id="61-网络基础知识回顾"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#61-网络基础知识回顾"><span class="icon icon-link"></span></a>6.1 网络基础知识回顾</h2><p>IP、子网掩码、网关、DNS、端口号</p><p><a target="_blank" rel="noopener noreferrer" href="https://zhuanlan.zhihu.com/p/65226634">https://zhuanlan.zhihu.com/p/65226634<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><blockquote><p>面试常问的一个题目, 当你在浏览器中输入一个网址（比如www.baidu.com）并敲回车，这个过程后面都发生了什么</p></blockquote><h3 id="internet如何工作的"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#internet如何工作的"><span class="icon icon-link"></span></a>Internet如何工作的</h3><p><a target="_blank" rel="noopener noreferrer" href="https://www.hp.com/us-en/shop/tech-takes/how-does-the-internet-work">https://www.hp.com/us-en/shop/tech-takes/how-does-the-internet-work<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>从数据包的角度详细解析</p><p><a target="_blank" rel="noopener noreferrer" href="https://www.homenethowto.com/advanced-topics/traffic-example-the-full-picture/">https://www.homenethowto.com/advanced-topics/traffic-example-the-full-picture/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h2 id="62-网络常用命令"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#62-网络常用命令"><span class="icon icon-link"></span></a>6.2 网络常用命令</h2><h3 id="ip地址的查看"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#ip地址的查看"><span class="icon icon-link"></span></a>IP地址的查看</h3><p>Windows</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">ipconfig</span></div></pre></div><p>Linux</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">ifconfig</span></div></pre></div><p>或者</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">ip addr</span></div></pre></div><h3 id="网络连通性测试"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#网络连通性测试"><span class="icon icon-link"></span></a>网络连通性测试</h3><h4 id="ping命令"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#ping命令"><span class="icon icon-link"></span></a>ping命令</h4><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">PS C:\Users\Peng Xiao&gt; ping 192.168.178.1</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Pinging 192.168.178.1 with 32 bytes of data:</span></div><div class="token-line"><span class="token plain">Reply from 192.168.178.1: bytes=32 time=2ms TTL=64</span></div><div class="token-line"><span class="token plain">Reply from 192.168.178.1: bytes=32 time=3ms TTL=64</span></div><div class="token-line"><span class="token plain">Reply from 192.168.178.1: bytes=32 time=3ms TTL=64</span></div><div class="token-line"><span class="token plain">Reply from 192.168.178.1: bytes=32 time=3ms TTL=64</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Ping statistics for 192.168.178.1:</span></div><div class="token-line"><span class="token plain">    Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),</span></div><div class="token-line"><span class="token plain">Approximate round trip times in milli-seconds:</span></div><div class="token-line"><span class="token plain">    Minimum = 2ms, Maximum = 3ms, Average = 2ms</span></div><div class="token-line"><span class="token plain">PS C:\Users\Peng Xiao&gt;</span></div></pre></div><h4 id="telnet命令"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#telnet命令"><span class="icon icon-link"></span></a>telnet命令</h4><p>测试端口的连通性</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">➜  ~ telnet www.baidu.com </span><span class="token number">80</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">Trying </span><span class="token number">104.193</span><span class="token plain">.88.123</span><span class="token punctuation">..</span><span class="token plain">.</span></div><div class="token-line"><span class="token plain">Connected to www.wshifen.com.</span></div><div class="token-line"><span class="token plain">Escape character is </span><span class="token string">&#x27;^]&#x27;</span><span class="token builtin class-name">.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">HTTP/1.1 </span><span class="token number">400</span><span class="token plain"> Bad Request</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Connection closed by foreign host.</span></div><div class="token-line"><span class="token plain">➜  ~</span></div></pre></div><h4 id="traceroute"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#traceroute"><span class="icon icon-link"></span></a>traceroute</h4><p>路径探测跟踪</p><p>Linux下使用 <code>tracepath</code></p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">➜  ~ tracepath www.baidu.com</span></div><div class="token-line"><span class="token plain">1?: [LOCALHOST]                      pmtu 1500</span></div><div class="token-line"><span class="token plain">1:  DESKTOP-FQ0EO8J                                       0.430ms</span></div><div class="token-line"><span class="token plain">1:  DESKTOP-FQ0EO8J                                       0.188ms</span></div><div class="token-line"><span class="token plain">2:  192.168.178.1                                         3.371ms</span></div><div class="token-line"><span class="token plain">3:  no reply</span></div><div class="token-line"><span class="token plain">4:  gv-rc0052-cr102-et91-251.core.as33915.net            13.970ms</span></div><div class="token-line"><span class="token plain">5:  asd-tr0021-cr101-be156-10.core.as9143.net            19.190ms</span></div><div class="token-line"><span class="token plain">6:  nl-ams04a-ri3-ae51-0.core.as9143.net                213.589ms</span></div><div class="token-line"><span class="token plain">7:  63.218.65.33                                         16.887ms</span></div><div class="token-line"><span class="token plain">8:  HundredGE0-6-0-0.br04.sjo01.pccwbtn.net             176.099ms asymm 10</span></div><div class="token-line"><span class="token plain">9:  HundredGE0-6-0-0.br04.sjo01.pccwbtn.net             173.399ms asymm 10</span></div><div class="token-line"><span class="token plain">10:  63-219-23-98.static.pccwglobal.net                  177.337ms asymm 11</span></div><div class="token-line"><span class="token plain">11:  104.193.88.13                                       178.197ms asymm 12</span></div><div class="token-line"><span class="token plain">12:  no reply</span></div><div class="token-line"><span class="token plain">13:  no reply</span></div><div class="token-line"><span class="token plain">14:  no reply</span></div><div class="token-line"><span class="token plain">15:  no reply</span></div><div class="token-line"><span class="token plain">16:  no reply</span></div><div class="token-line"><span class="token plain">17:  no reply</span></div><div class="token-line"><span class="token plain">18:  no reply</span></div><div class="token-line"><span class="token plain">19:  no reply</span></div><div class="token-line"><span class="token plain">20:  no reply</span></div><div class="token-line"><span class="token plain">21:  no reply</span></div><div class="token-line"><span class="token plain">22:  no reply</span></div><div class="token-line"><span class="token plain">23:  no reply</span></div><div class="token-line"><span class="token plain">24:  no reply</span></div><div class="token-line"><span class="token plain">25:  no reply</span></div><div class="token-line"><span class="token plain">26:  no reply</span></div><div class="token-line"><span class="token plain">27:  no reply</span></div><div class="token-line"><span class="token plain">28:  no reply</span></div><div class="token-line"><span class="token plain">29:  no reply</span></div><div class="token-line"><span class="token plain">30:  no reply</span></div><div class="token-line"><span class="token plain">    Too many hops: pmtu 1500</span></div><div class="token-line"><span class="token plain">    Resume: pmtu 1500</span></div><div class="token-line"><span class="token plain">➜  ~</span></div></pre></div><p>Windows下使用 <code>TRACERT.EXE</code></p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">PS C:\Users\Peng Xiao&gt; TRACERT.EXE www.baidu.com</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Tracing route to www.wshifen.com [104.193.88.123]</span></div><div class="token-line"><span class="token plain">over a maximum of 30 hops:</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">1     4 ms     3 ms     3 ms  192.168.178.1</span></div><div class="token-line"><span class="token plain">2     *        *        *     Request timed out.</span></div><div class="token-line"><span class="token plain">3    21 ms    18 ms    19 ms  gv-rc0052-cr102-et91-251.core.as33915.net [213.51.197.37]</span></div><div class="token-line"><span class="token plain">4    14 ms    13 ms    12 ms  asd-tr0021-cr101-be156-10.core.as9143.net [213.51.158.2]</span></div><div class="token-line"><span class="token plain">5    23 ms    19 ms    14 ms  nl-ams04a-ri3-ae51-0.core.as9143.net [213.51.64.194]</span></div><div class="token-line"><span class="token plain">6    15 ms    14 ms    13 ms  63.218.65.33</span></div><div class="token-line"><span class="token plain">7   172 ms   169 ms   167 ms  HundredGE0-6-0-0.br04.sjo01.pccwbtn.net [63.223.60.58]</span></div><div class="token-line"><span class="token plain">8   167 ms   168 ms   168 ms  HundredGE0-6-0-0.br04.sjo01.pccwbtn.net [63.223.60.58]</span></div><div class="token-line"><span class="token plain">9   168 ms   173 ms   167 ms  63-219-23-98.static.pccwglobal.net [63.219.23.98]</span></div><div class="token-line"><span class="token plain">10   172 ms   170 ms   171 ms</span></div></pre></div><h4 id="curl命令"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#curl命令"><span class="icon icon-link"></span></a>curl命令</h4><p>请求web服务的</p><p><a target="_blank" rel="noopener noreferrer" href="http://www.ruanyifeng.com/blog/2019/09/curl-reference.html">http://www.ruanyifeng.com/blog/2019/09/curl-reference.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h2 id="63-docker-bridge-网络"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#63-docker-bridge-网络"><span class="icon icon-link"></span></a>6.3 Docker Bridge 网络</h2><p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2021-11-14-032225.png" alt="docker-volume"/></p><h3 id="创建两个容器"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#创建两个容器"><span class="icon icon-link"></span></a>创建两个容器</h3><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container run -d --rm --name box1 busybox /bin/sh -c </span><span class="token string">&quot;while true; do sleep 3600; done&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container run -d --rm --name box2 busybox /bin/sh -c </span><span class="token string">&quot;while true; do sleep 3600; done&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES</span></div><div class="token-line"><span class="token plain">4f3303c84e53   busybox   </span><span class="token string">&quot;/bin/sh -c &#x27;while t…&quot;</span><span class="token plain">   </span><span class="token number">49</span><span class="token plain"> minutes ago   Up </span><span class="token number">49</span><span class="token plain"> minutes             box2</span></div><div class="token-line"><span class="token plain">03494b034694   busybox   </span><span class="token string">&quot;/bin/sh -c &#x27;while t…&quot;</span><span class="token plain">   </span><span class="token number">49</span><span class="token plain"> minutes ago   Up </span><span class="token number">49</span><span class="token plain"> minutes             box1</span></div></pre></div><h3 id="容器间通信"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#容器间通信"><span class="icon icon-link"></span></a>容器间通信</h3><p>两个容器都连接到了一个叫 docker0 的Linux bridge上</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> network </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">NETWORK ID     NAME      DRIVER    SCOPE</span></div><div class="token-line"><span class="token plain">1847e179a316   bridge    bridge    </span><span class="token builtin class-name">local</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">a647a4ad0b4f   </span><span class="token function">host</span><span class="token plain">      </span><span class="token function">host</span><span class="token plain">      </span><span class="token builtin class-name">local</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">fbd81b56c009   none      null      </span><span class="token builtin class-name">local</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> network inspect bridge</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Name&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;bridge&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Id&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;1847e179a316ee5219c951c2c21cf2c787d431d1ffb3ef621b8f0d1edd197b24&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Created&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;2021-07-01T15:28:09.265408946Z&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Scope&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;local&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Driver&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;bridge&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;EnableIPv6&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> false,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;IPAM&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token string">&quot;Driver&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;default&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">            </span><span class="token string">&quot;Options&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> null,</span></div><div class="token-line"><span class="token plain">            </span><span class="token string">&quot;Config&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    </span><span class="token string">&quot;Subnet&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;172.17.0.0/16&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">                    </span><span class="token string">&quot;Gateway&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;172.17.0.1&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Internal&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> false,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Attachable&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> false,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Ingress&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> false,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;ConfigFrom&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token string">&quot;Network&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;ConfigOnly&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> false,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Containers&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token string">&quot;03494b034694982fa085cc4052b6c7b8b9c046f9d5f85f30e3a9e716fad20741&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token string">&quot;Name&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;box1&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">                </span><span class="token string">&quot;EndpointID&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;072160448becebb7c9c333dce9bbdf7601a92b1d3e7a5820b8b35976cf4fd6ff&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">                </span><span class="token string">&quot;MacAddress&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;02:42:ac:11:00:02&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">                </span><span class="token string">&quot;IPv4Address&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;172.17.0.2/16&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">                </span><span class="token string">&quot;IPv6Address&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">            </span><span class="token string">&quot;4f3303c84e5391ea37db664fd08683b01decdadae636aaa1bfd7bb9669cbd8de&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token string">&quot;Name&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;box2&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">                </span><span class="token string">&quot;EndpointID&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;4cf0f635d4273066acd3075ec775e6fa405034f94b88c1bcacdaae847612f2c5&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">                </span><span class="token string">&quot;MacAddress&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;02:42:ac:11:00:03&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">                </span><span class="token string">&quot;IPv4Address&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;172.17.0.3/16&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">                </span><span class="token string">&quot;IPv6Address&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Options&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token string">&quot;com.docker.network.bridge.default_bridge&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;true&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">            </span><span class="token string">&quot;com.docker.network.bridge.enable_icc&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;true&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">            </span><span class="token string">&quot;com.docker.network.bridge.enable_ip_masquerade&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;true&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">            </span><span class="token string">&quot;com.docker.network.bridge.host_binding_ipv4&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;0.0.0.0&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">            </span><span class="token string">&quot;com.docker.network.bridge.name&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;docker0&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">            </span><span class="token string">&quot;com.docker.network.driver.mtu&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;1500&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;Labels&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span></div></pre></div><blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">brctl` 使用前需要安装, 对于CentOS, 可以通过 `sudo yum install -y bridge-utils` 安装. 对于Ubuntu, 可以通过 `sudo apt-get install -y bridge-utils</span></div></pre></div></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ brctl show</span></div><div class="token-line"><span class="token plain">bridge name     bridge </span><span class="token function">id</span><span class="token plain">               STP enabled     interfaces</span></div><div class="token-line"><span class="token plain">docker0         </span><span class="token number">8000</span><span class="token plain">.0242759468cf       no              veth8c9bb82</span></div><div class="token-line"><span class="token plain">                                                        vethd8f9afb</span></div></pre></div><h3 id="容器对外通信"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#容器对外通信"><span class="icon icon-link"></span></a>容器对外通信</h3><p>查看路由</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">ip</span><span class="token plain"> route</span></div><div class="token-line"><span class="token plain">default via </span><span class="token number">10.0</span><span class="token plain">.2.2 dev eth0 proto dhcp metric </span><span class="token number">100</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token number">10.0</span><span class="token plain">.2.0/24 dev eth0 proto kernel scope </span><span class="token function">link</span><span class="token plain"> src </span><span class="token number">10.0</span><span class="token plain">.2.15 metric </span><span class="token number">100</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token number">172.17</span><span class="token plain">.0.0/16 dev docker0 proto kernel scope </span><span class="token function">link</span><span class="token plain"> src </span><span class="token number">172.17</span><span class="token plain">.0.1</span></div><div class="token-line"><span class="token plain"></span><span class="token number">192.168</span><span class="token plain">.200.0/24 dev eth1 proto kernel scope </span><span class="token function">link</span><span class="token plain"> src </span><span class="token number">192.168</span><span class="token plain">.200.10 metric </span><span class="token number">101</span></div></pre></div><p>iptable <a target="_blank" rel="noopener noreferrer" href="https://dockertips.readthedocs.io/en/latest/single-host-network/docker-bridge.html#f4">1<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 转发规则</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">sudo</span><span class="token plain"> iptables --list -t nat</span></div><div class="token-line"><span class="token plain">Chain PREROUTING </span><span class="token punctuation">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">target     prot opt </span><span class="token builtin class-name">source</span><span class="token plain">               destination</span></div><div class="token-line"><span class="token plain">DOCKER     all  --  anywhere             anywhere             ADDRTYPE match dst-type LOCAL</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain INPUT </span><span class="token punctuation">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">target     prot opt </span><span class="token builtin class-name">source</span><span class="token plain">               destination</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain OUTPUT </span><span class="token punctuation">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">target     prot opt </span><span class="token builtin class-name">source</span><span class="token plain">               destination</span></div><div class="token-line"><span class="token plain">DOCKER     all  --  anywhere            </span><span class="token operator">!</span><span class="token plain">loopback/8           ADDRTYPE match dst-type LOCAL</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain POSTROUTING </span><span class="token punctuation">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">target     prot opt </span><span class="token builtin class-name">source</span><span class="token plain">               destination</span></div><div class="token-line"><span class="token plain">MASQUERADE  all  --  </span><span class="token number">172.17</span><span class="token plain">.0.0/16        anywhere</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain DOCKER </span><span class="token punctuation">(</span><span class="token number">2</span><span class="token plain"> references</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">target     prot opt </span><span class="token builtin class-name">source</span><span class="token plain">               destination</span></div><div class="token-line"><span class="token plain">RETURN     all  --  anywhere             anywhere</span></div></pre></div><h3 id="端口转发"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#端口转发"><span class="icon icon-link"></span></a>端口转发</h3><p>创建容器</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container run -d --rm --name web -p </span><span class="token number">8080</span><span class="token plain">:80 nginx</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container inspect --format </span><span class="token string">&#x27;{{.NetworkSettings.IPAddress}}&#x27;</span><span class="token plain"> web</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container run -d --rm --name client busybox /bin/sh -c </span><span class="token string">&quot;while true; do sleep 3600; done&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container inspect --format </span><span class="token string">&#x27;{{.NetworkSettings.IPAddress}}&#x27;</span><span class="token plain"> client</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container </span><span class="token builtin class-name">exec</span><span class="token plain"> -it client </span><span class="token function">wget</span><span class="token plain"> http://172.17.0.2</span></div></pre></div><p>查看iptables的端口转发规则</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">[</span><span class="token plain">vagrant@docker-host1 ~</span><span class="token punctuation">]</span><span class="token plain">$ </span><span class="token function">sudo</span><span class="token plain"> iptables -t nat -nvxL</span></div><div class="token-line"><span class="token plain">Chain PREROUTING </span><span class="token punctuation">(</span><span class="token plain">policy ACCEPT </span><span class="token number">10</span><span class="token plain"> packets, </span><span class="token number">1961</span><span class="token plain"> bytes</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    pkts      bytes target     prot opt </span><span class="token keyword">in</span><span class="token plain">     out     </span><span class="token builtin class-name">source</span><span class="token plain">               destination</span></div><div class="token-line"><span class="token plain">    </span><span class="token number">1</span><span class="token plain">       </span><span class="token number">52</span><span class="token plain"> DOCKER     all  --  *      *       </span><span class="token number">0.0</span><span class="token plain">.0.0/0            </span><span class="token number">0.0</span><span class="token plain">.0.0/0            ADDRTYPE match dst-type LOCAL</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain INPUT </span><span class="token punctuation">(</span><span class="token plain">policy ACCEPT </span><span class="token number">9</span><span class="token plain"> packets, </span><span class="token number">1901</span><span class="token plain"> bytes</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    pkts      bytes target     prot opt </span><span class="token keyword">in</span><span class="token plain">     out     </span><span class="token builtin class-name">source</span><span class="token plain">               destination</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain OUTPUT </span><span class="token punctuation">(</span><span class="token plain">policy ACCEPT </span><span class="token number">2</span><span class="token plain"> packets, </span><span class="token number">120</span><span class="token plain"> bytes</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    pkts      bytes target     prot opt </span><span class="token keyword">in</span><span class="token plain">     out     </span><span class="token builtin class-name">source</span><span class="token plain">               destination</span></div><div class="token-line"><span class="token plain">    </span><span class="token number">0</span><span class="token plain">        </span><span class="token number">0</span><span class="token plain"> DOCKER     all  --  *      *       </span><span class="token number">0.0</span><span class="token plain">.0.0/0           </span><span class="token operator">!</span><span class="token number">127.0</span><span class="token plain">.0.0/8          ADDRTYPE match dst-type LOCAL</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain POSTROUTING </span><span class="token punctuation">(</span><span class="token plain">policy ACCEPT </span><span class="token number">4</span><span class="token plain"> packets, </span><span class="token number">232</span><span class="token plain"> bytes</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    pkts      bytes target     prot opt </span><span class="token keyword">in</span><span class="token plain">     out     </span><span class="token builtin class-name">source</span><span class="token plain">               destination</span></div><div class="token-line"><span class="token plain">    </span><span class="token number">3</span><span class="token plain">      </span><span class="token number">202</span><span class="token plain"> MASQUERADE  all  --  *      </span><span class="token operator">!</span><span class="token plain">docker0  </span><span class="token number">172.17</span><span class="token plain">.0.0/16        </span><span class="token number">0.0</span><span class="token plain">.0.0/0</span></div><div class="token-line"><span class="token plain">    </span><span class="token number">0</span><span class="token plain">        </span><span class="token number">0</span><span class="token plain"> MASQUERADE  tcp  --  *      *       </span><span class="token number">172.17</span><span class="token plain">.0.2           </span><span class="token number">172.17</span><span class="token plain">.0.2           tcp dpt:80</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain DOCKER </span><span class="token punctuation">(</span><span class="token number">2</span><span class="token plain"> references</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    pkts      bytes target     prot opt </span><span class="token keyword">in</span><span class="token plain">     out     </span><span class="token builtin class-name">source</span><span class="token plain">               destination</span></div><div class="token-line"><span class="token plain">    </span><span class="token number">0</span><span class="token plain">        </span><span class="token number">0</span><span class="token plain"> RETURN     all  --  docker0 *       </span><span class="token number">0.0</span><span class="token plain">.0.0/0            </span><span class="token number">0.0</span><span class="token plain">.0.0/0</span></div><div class="token-line"><span class="token plain">    </span><span class="token number">1</span><span class="token plain">       </span><span class="token number">52</span><span class="token plain"> DNAT       tcp  --  </span><span class="token operator">!</span><span class="token plain">docker0 *       </span><span class="token number">0.0</span><span class="token plain">.0.0/0            </span><span class="token number">0.0</span><span class="token plain">.0.0/0            tcp dpt:8080 to:172.17.0.2:80</span></div></pre></div><h1 id="7-docker-compose"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#7-docker-compose"><span class="icon icon-link"></span></a>7. Docker Compose</h1><h2 id="71-介绍"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#71-介绍"><span class="icon icon-link"></span></a>7.1 介绍</h2><p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2021-11-14-032816.png" alt="docker-compose-intro"/></p><h2 id="72-docker-compose-的安装"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#72-docker-compose-的安装"><span class="icon icon-link"></span></a>7.2 docker compose 的安装</h2><p>Windows和Mac在默认安装了docker desktop以后，docker-compose随之自动安装</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">PS C:</span><span class="token punctuation">\</span><span class="token plain">Users</span><span class="token punctuation">\</span><span class="token plain">Peng Xiao</span><span class="token punctuation">\</span><span class="token plain">docker.tips</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token function">docker-compose</span><span class="token plain"> --version</span></div><div class="token-line"><span class="token plain"></span><span class="token function">docker-compose</span><span class="token plain"> version </span><span class="token number">1.29</span><span class="token plain">.2, build 5becea4c</span></div></pre></div><p>Linux用户需要自行安装</p><p>最新版本号可以在这里查询 <a target="_blank" rel="noopener noreferrer" href="https://github.com/docker/compose/releases">https://github.com/docker/compose/releases<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">sudo</span><span class="token plain"> </span><span class="token function">curl</span><span class="token plain"> -L </span><span class="token string">&quot;https://github.com/docker/compose/releases/download/1.29.2/docker-compose-</span><span class="token string variable">$(</span><span class="token string variable function">uname</span><span class="token string variable"> -s</span><span class="token string variable">)</span><span class="token string">-</span><span class="token string variable">$(</span><span class="token string variable function">uname</span><span class="token string variable"> -m</span><span class="token string variable">)</span><span class="token string">&quot;</span><span class="token plain"> -o /usr/local/bin/docker-compose</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">sudo</span><span class="token plain"> </span><span class="token function">chmod</span><span class="token plain"> +x /usr/local/bin/docker-compose</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker-compose</span><span class="token plain"> --version</span></div><div class="token-line"><span class="token plain"></span><span class="token function">docker-compose</span><span class="token plain"> version </span><span class="token number">1.29</span><span class="token plain">.2, build 5becea4c</span></div></pre></div><p>熟悉python的朋友，可以使用pip去安装docker-Compose</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ pip </span><span class="token function">install</span><span class="token plain"> </span><span class="token function">docker-compose</span></div></pre></div><h2 id="73-compose-文件的结构和版本"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#73-compose-文件的结构和版本"><span class="icon icon-link"></span></a>7.3 compose 文件的结构和版本</h2><h3 id="compose-文件的结构和版本"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#compose-文件的结构和版本"><span class="icon icon-link"></span></a>compose 文件的结构和版本</h3><p>docker compose文件的语法说明 <a target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/compose/compose-file/">https://docs.docker.com/compose/compose-file/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h3 id="基本语法结构"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#基本语法结构"><span class="icon icon-link"></span></a>基本语法结构</h3><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token key atrule">version</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;3.8&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token comment"># 容器</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">servicename</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token comment"># 服务名字，这个名字也是内部 bridge网络可以使用的 DNS name</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token comment"># 镜像的名字</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token comment"># 可选，如果设置，则会覆盖默认镜像里的 CMD命令</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token comment"># 可选，相当于 docker run里的 --env</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token comment"># 可选，相当于docker run里的 -v</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">networks</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token comment"># 可选，相当于 docker run里的 --network</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token comment"># 可选，相当于 docker run里的 -p</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">servicename2</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">volumes</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token comment"># 可选，相当于 docker volume create</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">networks</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token comment"># 可选，相当于 docker network create</span></div></pre></div><p>以 Python Flask + Redis练习：为例子，改造成一个docker-compose文件</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">docker</span><span class="token plain"> image pull redis</span></div><div class="token-line"><span class="token plain"></span><span class="token function">docker</span><span class="token plain"> image build -t flask-demo </span><span class="token builtin class-name">.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># create network</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">docker</span><span class="token plain"> network create -d bridge demo-network</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># create container</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">docker</span><span class="token plain"> container run -d --name redis-server --network demo-network redis</span></div><div class="token-line"><span class="token plain"></span><span class="token function">docker</span><span class="token plain"> container run -d --network demo-network --name flask-demo --env </span><span class="token assign-left variable">REDIS_HOST</span><span class="token operator">=</span><span class="token plain">redis-server -p </span><span class="token number">5000</span><span class="token plain">:5000 flask-demo</span></div></pre></div><p>docker-compose.yml 文件如下</p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token key atrule">version</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;3.8&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">flask-demo</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation">:</span><span class="token plain"> flask</span><span class="token punctuation">-</span><span class="token plain">demo</span><span class="token punctuation">:</span><span class="token plain">latest</span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">-</span><span class="token plain"> REDIS_HOST=redis</span><span class="token punctuation">-</span><span class="token plain">server</span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">networks</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">-</span><span class="token plain"> demo</span><span class="token punctuation">-</span><span class="token plain">network</span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">-</span><span class="token plain"> 8080</span><span class="token punctuation">:</span><span class="token number">5000</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">redis-server</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation">:</span><span class="token plain"> redis</span><span class="token punctuation">:</span><span class="token plain">latest</span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">networks</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">     </span><span class="token punctuation">-</span><span class="token plain"> demo</span><span class="token punctuation">-</span><span class="token plain">network</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">networks</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  demo</span><span class="token punctuation">-</span><span class="token plain">network</span><span class="token punctuation">:</span></div></pre></div><h3 id="docker-compose-语法版本"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#docker-compose-语法版本"><span class="icon icon-link"></span></a>docker-compose 语法版本</h3><p>向后兼容</p><p><a target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/compose/compose-file/">https://docs.docker.com/compose/compose-file/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h2 id="74-docker-compose-水平扩展"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#74-docker-compose-水平扩展"><span class="icon icon-link"></span></a>7.4 docker compose 水平扩展</h2><h3 id="环境清理-1"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#环境清理-1"><span class="icon icon-link"></span></a>环境清理</h3><p>删除所有容器和镜像</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container </span><span class="token function">rm</span><span class="token plain"> -f </span><span class="token variable">$(</span><span class="token variable function">docker</span><span class="token variable"> container </span><span class="token variable function">ps</span><span class="token variable"> -aq</span><span class="token variable">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> system prune -a -f</span></div></pre></div><h3 id="启动"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#启动"><span class="icon icon-link"></span></a>启动</h3><p>下载源码，进入源码目录</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker-compose</span><span class="token plain"> pull</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker-compose</span><span class="token plain"> build</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker-compose</span><span class="token plain"> up -d</span></div><div class="token-line"><span class="token plain">Creating network </span><span class="token string">&quot;compose-scale-example_default&quot;</span><span class="token plain"> with the default driver</span></div><div class="token-line"><span class="token plain">Creating compose-scale-example_flask_1        </span><span class="token punctuation">..</span><span class="token plain">. </span><span class="token keyword">done</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">Creating compose-scale-example_client_1       </span><span class="token punctuation">..</span><span class="token plain">. </span><span class="token keyword">done</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">Creating compose-scale-example_redis-server_1 </span><span class="token punctuation">..</span><span class="token plain">. </span><span class="token keyword">done</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker-compose</span><span class="token plain"> </span><span class="token function">ps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                Name                              Command               State    Ports</span></div><div class="token-line"><span class="token plain">----------------------------------------------------------------------------------------</span></div><div class="token-line"><span class="token plain">compose-scale-example_client_1         </span><span class="token function">sh</span><span class="token plain"> -c </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token keyword">do</span><span class="token plain"> </span><span class="token function">sleep</span><span class="token plain"> </span><span class="token punctuation">..</span><span class="token plain">.   Up</span></div><div class="token-line"><span class="token plain">compose-scale-example_flask_1          flask run -h </span><span class="token number">0.0</span><span class="token plain">.0.0             Up      </span><span class="token number">5000</span><span class="token plain">/tcp</span></div><div class="token-line"><span class="token plain">compose-scale-example_redis-server_1   docker-entrypoint.sh redis </span><span class="token punctuation">..</span><span class="token plain">.   Up      </span><span class="token number">6379</span><span class="token plain">/tcp</span></div></pre></div><h3 id="水平扩展-scale"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#水平扩展-scale"><span class="icon icon-link"></span></a>水平扩展 scale</h3><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker-compose</span><span class="token plain"> up -d --scale </span><span class="token assign-left variable">flask</span><span class="token operator">=</span><span class="token number">3</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">compose-scale-example_client_1 is up-to-date</span></div><div class="token-line"><span class="token plain">compose-scale-example_redis-server_1 is up-to-date</span></div><div class="token-line"><span class="token plain">Creating compose-scale-example_flask_2 </span><span class="token punctuation">..</span><span class="token plain">. </span><span class="token keyword">done</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">Creating compose-scale-example_flask_3 </span><span class="token punctuation">..</span><span class="token plain">. </span><span class="token keyword">done</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">docker-compose</span><span class="token plain"> </span><span class="token function">ps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                Name                              Command               State    Ports</span></div><div class="token-line"><span class="token plain">----------------------------------------------------------------------------------------</span></div><div class="token-line"><span class="token plain">compose-scale-example_client_1         </span><span class="token function">sh</span><span class="token plain"> -c </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token keyword">do</span><span class="token plain"> </span><span class="token function">sleep</span><span class="token plain"> </span><span class="token punctuation">..</span><span class="token plain">.   Up</span></div><div class="token-line"><span class="token plain">compose-scale-example_flask_1          flask run -h </span><span class="token number">0.0</span><span class="token plain">.0.0             Up      </span><span class="token number">5000</span><span class="token plain">/tcp</span></div><div class="token-line"><span class="token plain">compose-scale-example_flask_2          flask run -h </span><span class="token number">0.0</span><span class="token plain">.0.0             Up      </span><span class="token number">5000</span><span class="token plain">/tcp</span></div><div class="token-line"><span class="token plain">compose-scale-example_flask_3          flask run -h </span><span class="token number">0.0</span><span class="token plain">.0.0             Up      </span><span class="token number">5000</span><span class="token plain">/tcp</span></div><div class="token-line"><span class="token plain">compose-scale-example_redis-server_1   docker-entrypoint.sh redis </span><span class="token punctuation">..</span><span class="token plain">.   Up      </span><span class="token number">6379</span><span class="token plain">/tcp</span></div></pre></div><h2 id="75-docker-compose-环境变量"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#75-docker-compose-环境变量"><span class="icon icon-link"></span></a>7.5 docker compose 环境变量</h2><p>参考文档：<a target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/compose/environment-variables/">https://docs.docker.com/compose/environment-variables/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h2 id="76-docker-compose-服务依赖和健康检查"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#76-docker-compose-服务依赖和健康检查"><span class="icon icon-link"></span></a>7.6 docker compose 服务依赖和健康检查</h2><p>Dockerfile healthcheck <a target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/engine/reference/builder/#healthcheck">https://docs.docker.com/engine/reference/builder/#healthcheck<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>docker compose <a target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/compose/compose-file/compose-file-v3/#healthcheck">https://docs.docker.com/compose/compose-file/compose-file-v3/#healthcheck<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>健康检查是容器运行状态的高级检查，主要是检查容器所运行的进程是否能正常的对外提供“服务”，比如一个数据库容器，我们不光 需要这个容器是up的状态，我们还要求这个容器的数据库进程能够正常对外提供服务，这就是所谓的健康检查。</p><h3 id="容器的健康检查"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#容器的健康检查"><span class="icon icon-link"></span></a>容器的健康检查</h3><p>容器本身有一个健康检查的功能，但是需要在Dockerfile里定义，或者在执行docker container run 的时候，通过下面的一些参数指定</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">--health-cmd string              Command to run to check health</span></div><div class="token-line"><span class="token plain">--health-interval duration       Time between running the check</span></div><div class="token-line"><span class="token plain">                                </span><span class="token punctuation">(</span><span class="token plain">ms</span><span class="token operator">|</span><span class="token plain">s</span><span class="token operator">|</span><span class="token plain">m</span><span class="token operator">|</span><span class="token plain">h</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">default 0s</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">--health-retries int             Consecutive failures needed to</span></div><div class="token-line"><span class="token plain">                                report unhealthy</span></div><div class="token-line"><span class="token plain">--health-start-period duration   Start period </span><span class="token keyword">for</span><span class="token plain"> the container to</span></div><div class="token-line"><span class="token plain">                                initialize before starting</span></div><div class="token-line"><span class="token plain">                                health-retries countdown</span></div><div class="token-line"><span class="token plain">                                </span><span class="token punctuation">(</span><span class="token plain">ms</span><span class="token operator">|</span><span class="token plain">s</span><span class="token operator">|</span><span class="token plain">m</span><span class="token operator">|</span><span class="token plain">h</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">default 0s</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">--health-timeout duration        Maximum </span><span class="token function">time</span><span class="token plain"> to allow one check to</span></div></pre></div><h3 id="示例源码"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#示例源码"><span class="icon icon-link"></span></a>示例源码</h3><p>我们以下面的这个flask容器为例，相关的代码如下</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">PS C:</span><span class="token punctuation">\</span><span class="token plain">Users</span><span class="token punctuation">\</span><span class="token plain">Peng Xiao</span><span class="token punctuation">\</span><span class="token plain">code-demo</span><span class="token punctuation">\</span><span class="token plain">compose-env</span><span class="token punctuation">\</span><span class="token plain">flask</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token function">dir</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    目录: C:</span><span class="token punctuation">\</span><span class="token plain">Users</span><span class="token punctuation">\</span><span class="token plain">Peng Xiao</span><span class="token punctuation">\</span><span class="token plain">code-demo</span><span class="token punctuation">\</span><span class="token plain">compose-env</span><span class="token punctuation">\</span><span class="token plain">flask</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Mode                 LastWriteTime         Length Name</span></div><div class="token-line"><span class="token plain">----                 -------------         ------ ----</span></div><div class="token-line"><span class="token plain">-a----         </span><span class="token number">2021</span><span class="token plain">/7/13     </span><span class="token number">15</span><span class="token plain">:52            </span><span class="token number">448</span><span class="token plain"> app.py</span></div><div class="token-line"><span class="token plain">-a----         </span><span class="token number">2021</span><span class="token plain">/7/14      </span><span class="token number">0</span><span class="token plain">:32            </span><span class="token number">471</span><span class="token plain"> Dockerfile</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">PS C:</span><span class="token punctuation">\</span><span class="token plain">Users</span><span class="token punctuation">\</span><span class="token plain">Peng Xiao</span><span class="token punctuation">\</span><span class="token plain">code-demo</span><span class="token punctuation">\</span><span class="token plain">compose-env</span><span class="token punctuation">\</span><span class="token plain">flask</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token function">more</span><span class="token plain"> .</span><span class="token punctuation">\</span><span class="token plain">app.py</span></div><div class="token-line"><span class="token plain">from flask </span><span class="token function">import</span><span class="token plain"> Flask</span></div><div class="token-line"><span class="token plain">from redis </span><span class="token function">import</span><span class="token plain"> StrictRedis</span></div><div class="token-line"><span class="token plain"></span><span class="token function">import</span><span class="token plain"> os</span></div><div class="token-line"><span class="token plain"></span><span class="token function">import</span><span class="token plain"> socket</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">app </span><span class="token operator">=</span><span class="token plain"> Flask</span><span class="token punctuation">(</span><span class="token plain">__name__</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">redis </span><span class="token operator">=</span><span class="token plain"> StrictRedis</span><span class="token punctuation">(</span><span class="token plain">host</span><span class="token operator">=</span><span class="token plain">os.environ.get</span><span class="token punctuation">(</span><span class="token string">&#x27;REDIS_HOST&#x27;</span><span class="token plain">, </span><span class="token string">&#x27;127.0.0.1&#x27;</span><span class="token punctuation">)</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">                    </span><span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">6379</span><span class="token plain">, </span><span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token plain">os.environ.get</span><span class="token punctuation">(</span><span class="token string">&#x27;REDIS_PASS&#x27;</span><span class="token punctuation">))</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">@app.route</span><span class="token punctuation">(</span><span class="token string">&#x27;/&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">def hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain">:</span></div><div class="token-line"><span class="token plain">    redis.incr</span><span class="token punctuation">(</span><span class="token string">&#x27;hits&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token builtin class-name">return</span><span class="token plain"> f</span><span class="token string">&quot;Hello Container World! I have been seen {redis.get(&#x27;hits&#x27;).decode(&#x27;utf-8&#x27;)} times and my hostname is {socket.gethostname()}.</span><span class="token string entity">\n</span><span class="token string">&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">PS C:</span><span class="token punctuation">\</span><span class="token plain">Users</span><span class="token punctuation">\</span><span class="token plain">Peng Xiao</span><span class="token punctuation">\</span><span class="token plain">code-demo</span><span class="token punctuation">\</span><span class="token plain">compose-env</span><span class="token punctuation">\</span><span class="token plain">flask</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token function">more</span><span class="token plain"> .</span><span class="token punctuation">\</span><span class="token plain">Dockerfile</span></div><div class="token-line"><span class="token plain">FROM python:3.9.5-slim</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">RUN pip </span><span class="token function">install</span><span class="token plain"> flask redis </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">apt-get</span><span class="token plain"> update </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">apt-get</span><span class="token plain"> </span><span class="token function">install</span><span class="token plain"> -y </span><span class="token function">curl</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">groupadd</span><span class="token plain"> -r flask </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token function">useradd</span><span class="token plain"> -r -g flask flask </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">mkdir</span><span class="token plain"> /src </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">chown</span><span class="token plain"> -R flask:flask /src</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token environment constant">USER</span><span class="token plain"> flask</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">COPY app.py /src/app.py</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">WORKDIR /src</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">ENV </span><span class="token assign-left variable">FLASK_APP</span><span class="token operator">=</span><span class="token plain">app.py </span><span class="token assign-left variable">REDIS_HOST</span><span class="token operator">=</span><span class="token plain">redis</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">EXPOSE </span><span class="token number">5000</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">HEALTHCHECK --interval</span><span class="token operator">=</span><span class="token plain">30s --timeout</span><span class="token operator">=</span><span class="token plain">3s </span><span class="token punctuation">\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    CMD </span><span class="token function">curl</span><span class="token plain"> -f http://localhost:5000/ </span><span class="token operator">||</span><span class="token plain"> </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">CMD </span><span class="token punctuation">[</span><span class="token string">&quot;flask&quot;</span><span class="token plain">, </span><span class="token string">&quot;run&quot;</span><span class="token plain">, </span><span class="token string">&quot;-h&quot;</span><span class="token plain">, </span><span class="token string">&quot;0.0.0.0&quot;</span><span class="token punctuation">]</span></div></pre></div><p>上面Dockerfili里的HEALTHCHECK 就是定义了一个健康检查。 会每隔30秒检查一次，如果失败就会退出，退出代码是1</p><h3 id="构建镜像和创建容器"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#构建镜像和创建容器"><span class="icon icon-link"></span></a>构建镜像和创建容器</h3><p>构建镜像，创建一个bridge网络，然后启动容器连到bridge网络</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ docker image build -t flask-demo .</span></div><div class="token-line"><span class="token plain">$ docker network create mybridge</span></div><div class="token-line"><span class="token plain">$ docker container run -d --network mybridge --env REDIS_PASS=abc123 flask-demo</span></div></pre></div><p>查看容器状态</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ docker container ls</span></div><div class="token-line"><span class="token plain">CONTAINER ID   IMAGE        COMMAND                  CREATED       STATUS                            PORTS      NAMES</span></div><div class="token-line"><span class="token plain">059c12486019   flask-demo   &quot;flask run -h 0.0.0.0&quot;   4 hours ago   Up 8 seconds (health: starting)   5000/tcp   dazzling_tereshkova</span></div></pre></div><p>也可以通过docker container inspect 059 查看详情， 其中有有关health的</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&quot;Health&quot;: {</span></div><div class="token-line"><span class="token plain">&quot;Status&quot;: &quot;starting&quot;,</span></div><div class="token-line"><span class="token plain">&quot;FailingStreak&quot;: 1,</span></div><div class="token-line"><span class="token plain">&quot;Log&quot;: [</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">        &quot;Start&quot;: &quot;2021-07-14T19:04:46.4054004Z&quot;,</span></div><div class="token-line"><span class="token plain">        &quot;End&quot;: &quot;2021-07-14T19:04:49.4055393Z&quot;,</span></div><div class="token-line"><span class="token plain">        &quot;ExitCode&quot;: -1,</span></div><div class="token-line"><span class="token plain">        &quot;Output&quot;: &quot;Health check exceeded timeout (3s)&quot;</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">]</span></div></pre></div><p>经过3次检查，一直是不通的，然后health的状态会从starting变为 unhealthy</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">docker container ls</span></div><div class="token-line"><span class="token plain">CONTAINER ID   IMAGE        COMMAND                  CREATED       STATUS                     PORTS      NAMES</span></div><div class="token-line"><span class="token plain">059c12486019   flask-demo   &quot;flask run -h 0.0.0.0&quot;   4 hours ago   Up 2 minutes (unhealthy)   5000/tcp   dazzling_tereshkova</span></div></pre></div><h3 id="启动redis服务器"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#启动redis服务器"><span class="icon icon-link"></span></a>启动redis服务器</h3><p>启动redis，连到mybridge上，name=redis， 注意密码</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ docker container run -d --network mybridge --name redis redis:latest redis-server --requirepass abc123</span></div></pre></div><p>经过几秒钟，我们的flask 变成了healthy</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">docker</span><span class="token plain"> container </span><span class="token function">ls</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS                   PORTS      NAMES</span></div><div class="token-line"><span class="token plain">bc4e826ee938   redis:latest   </span><span class="token string">&quot;docker-entrypoint.s…&quot;</span><span class="token plain">   </span><span class="token number">18</span><span class="token plain"> seconds ago   Up </span><span class="token number">16</span><span class="token plain"> seconds            </span><span class="token number">6379</span><span class="token plain">/tcp   redis</span></div><div class="token-line"><span class="token plain">059c12486019   flask-demo     </span><span class="token string">&quot;flask run -h 0.0.0.0&quot;</span><span class="token plain">   </span><span class="token number">4</span><span class="token plain"> hours ago      Up </span><span class="token number">6</span><span class="token plain"> minutes </span><span class="token punctuation">(</span><span class="token plain">healthy</span><span class="token punctuation">)</span><span class="token plain">   </span><span class="token number">5000</span><span class="token plain">/tcp   dazzling_tereshkova</span></div></pre></div><h3 id="docker-compose-健康检查"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#docker-compose-健康检查"><span class="icon icon-link"></span></a>docker-compose 健康检查</h3><p>示例代码下载(flask healthcheck) <a target="_blank" rel="noopener noreferrer" href="https://dockertips.readthedocs.io/en/latest/_downloads/df3430ebd5e1f962f0c10136565257e1/compose-healthcheck-flask.zip"><code>本节源码</code></a></p><p>示例代码下载(flask + redis healthcheck) <a target="_blank" rel="noopener noreferrer" href="https://dockertips.readthedocs.io/en/latest/_downloads/529c888c2faf46a0906548ed7510d12b/compose-healthcheck-redis.zip"><code>本节源码</code></a></p><p>一个healthcheck不错的例子 <a target="_blank" rel="noopener noreferrer" href="https://gist.github.com/phuysmans/4f67a7fa1b0c6809a86f014694ac6c3a">https://gist.github.com/phuysmans/4f67a7fa1b0c6809a86f014694ac6c3a<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h1 id="8-docker-swarm"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#8-docker-swarm"><span class="icon icon-link"></span></a>8. Docker Swarm</h1><h2 id="81-docker-swarm-介绍"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#81-docker-swarm-介绍"><span class="icon icon-link"></span></a>8.1 Docker Swarm 介绍</h2><h3 id="为什么不建议在生产环境中使用-docker-compose"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#为什么不建议在生产环境中使用-docker-compose"><span class="icon icon-link"></span></a>为什么不建议在生产环境中使用 docker-compose</h3><ul><li>多机器如何管理？</li><li>如果跨机器做scale横向扩展？</li><li>容器失败退出时如何新建容器确保服务正常运行？</li><li>如何确保零宕机时间？</li><li>如何管理密码，key等敏感数据？</li><li>其他</li></ul><h3 id="容器编排-swarm"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#容器编排-swarm"><span class="icon icon-link"></span></a>容器编排 swarm</h3><p><img src="http://wuxiao-tech-doc.oss-cn-hangzhou.aliyuncs.com/2021-12-26-023349.png" alt="docker-swarm-intro"/></p><p>Swarm的基本架构</p><p><img src="http://wuxiao-tech-doc.oss-cn-hangzhou.aliyuncs.com/2021-12-26-023522.png" alt="docker-swarm-arch"/></p><h3 id="docker-swarm-vs-kubernetes"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#docker-swarm-vs-kubernetes"><span class="icon icon-link"></span></a>docker swarm vs kubernetes</h3><p>k8s在容器编排领域处于绝对领先的地位</p><h2 id="82-swarm-单节点快速上手"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#82-swarm-单节点快速上手"><span class="icon icon-link"></span></a>8.2 Swarm 单节点快速上手</h2><h3 id="初始化"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#初始化"><span class="icon icon-link"></span></a>初始化</h3><p><code>docker info</code> 这个命令可以查看我们的docker engine有没有激活swarm模式， 默认是没有的，我们会看到</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">Swarm: inactive</span></div></pre></div><p>激活swarm，有两个方法：</p><ul><li>初始化一个swarm集群，自己成为manager</li><li>加入一个已经存在的swarm集群</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">PS C:\Users\Peng Xiao\code-demo&gt; docker swarm init</span></div><div class="token-line"><span class="token plain">Swarm initialized: current node (vjtstrkxntsacyjtvl18hcbe4) is now a manager.</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">To add a worker to this swarm, run the following command:</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    docker swarm join --token SWMTKN-1-33ci17l1n34fh6v4r1qq8qmocjo347saeuer2xrxflrn25jgjx-7vphgu8a0gsa4anof6ffrgwqb 192.168.65.3:2377</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">To add a manager to this swarm, run &#x27;docker swarm join-token manager&#x27; and follow the instructions.</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">PS C:\Users\Peng Xiao\code-demo&gt; docker node ls</span></div><div class="token-line"><span class="token plain">ID                            HOSTNAME         STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span></div><div class="token-line"><span class="token plain">vjtstrkxntsacyjtvl18hcbe4 *   docker-desktop   Ready     Active         Leader           20.10.7</span></div><div class="token-line"><span class="token plain">PS C:\Users\Peng Xiao\code-demo&gt;</span></div></pre></div><h3 id="docker-swarm-init-背后发生了什么"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#docker-swarm-init-背后发生了什么"><span class="icon icon-link"></span></a>docker swarm init 背后发生了什么</h3><p>主要是 PKI 和安全相关的自动化</p><ul><li>创建swarm集群的根证书</li><li>manager节点的证书</li><li>其它节点加入集群需要的 tokens</li></ul><p>创建Raft数据库用于存储证书，配置，密码等数据</p><p>RAFT相关资料</p><ul><li><a target="_blank" rel="noopener noreferrer" href="http://thesecretlivesofdata.com/raft/">http://thesecretlivesofdata.com/raft/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://raft.github.io/">https://raft.github.io/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/engine/swarm/raft/">https://docs.docker.com/engine/swarm/raft/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><p>看动画学会 Raft 算法</p><h2 id="83-swarm-三节点集群搭建"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#83-swarm-三节点集群搭建"><span class="icon icon-link"></span></a>8.3 Swarm 三节点集群搭建</h2><p>创建3节点swarm cluster的方法</p><ul><li><a target="_blank" rel="noopener noreferrer" href="https://labs.play-with-docker.com/">https://labs.play-with-docker.com/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> play with docker 网站， 优点是快速方便，缺点是环境不持久，4个小时后环境会被重置</li><li>在本地通过虚拟化软件搭建Linux虚拟机，优点是稳定，方便，缺点是占用系统资源，需要电脑内存最好8G及其以上</li><li>在云上使用云主机， 亚马逊，Google，微软Azure，阿里云，腾讯云等，缺点是需要消耗金钱（但是有些云服务，有免费试用）</li></ul><p>多节点的环境涉及到机器之间的通信需求，所以防火墙和网络安全策略组是大家一定要考虑的问题，特别是在云上使用云主机的情况，下面这些端口记得打开 <code>防火墙</code> 以及 <code>设置安全策略组</code></p><ul><li>TCP port <code>2376</code></li><li>TCP port <code>2377</code></li><li>TCP and UDP port <code>7946</code></li><li>UDP port <code>4789</code></li></ul><p>为了简化，以上所有端口都允许节点之间自由访问就行。</p><h2 id="84-swarm-的-overlay-网络详解"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#84-swarm-的-overlay-网络详解"><span class="icon icon-link"></span></a>8.4 Swarm 的 overlay 网络详解</h2><p>对于理解swarm的网络来讲，个人认为最重要的两个点：</p><ul><li>第一是外部如何访问部署运行在swarm集群内的服务，可以称之为 <code>入方向</code> 流量，在swarm里我们通过 <code>ingress</code> 来解决</li><li>第二是部署在swarm集群里的服务，如何对外进行访问，这部分又分为两块:<ul><li>第一，<code>东西向流量</code> ，也就是不同swarm节点上的容器之间如何通信，swarm通过 <code>overlay</code> 网络来解决；</li><li>第二，<code>南北向流量</code> ，也就是swarm集群里的容器如何对外访问，比如互联网，这个是 <code>Linux bridge + iptables NAT</code> 来解决的</li></ul></li></ul><h3 id="创建-overlay-网络"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#创建-overlay-网络"><span class="icon icon-link"></span></a>创建 overlay 网络</h3><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker network create -d overlay mynet</span></div></pre></div><p>这个网络会同步到所有的swarm节点上</p><h3 id="创建服务"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#创建服务"><span class="icon icon-link"></span></a>创建服务</h3><p>创建一个服务连接到这个 overlay网络， name 是 test ， replicas 是 2</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker service create --network mynet --name test --replicas 2 busybox ping 8.8.8.8</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker service ps test</span></div><div class="token-line"><span class="token plain">ID             NAME      IMAGE            NODE            DESIRED STATE   CURRENT STATE            ERROR     PORTS</span></div><div class="token-line"><span class="token plain">yf5uqm1kzx6d   test.1    busybox:latest   swarm-worker1   Running         Running 18 seconds ago</span></div><div class="token-line"><span class="token plain">3tmp4cdqfs8a   test.2    busybox:latest   swarm-worker2   Running         Running 18 seconds ago</span></div></pre></div><p>可以看到这两个容器分别被创建在worker1和worker2两个节点上</p><h3 id="网络查看"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#网络查看"><span class="icon icon-link"></span></a>网络查看</h3><p>到worker1和worker2上分别查看容器的网络连接情况</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-worker1:~$ docker container ls</span></div><div class="token-line"><span class="token plain">CONTAINER ID   IMAGE            COMMAND          CREATED      STATUS      PORTS     NAMES</span></div><div class="token-line"><span class="token plain">cac4be28ced7   busybox:latest   &quot;ping 8.8.8.8&quot;   2 days ago   Up 2 days             test.1.yf5uqm1kzx6dbt7n26e4akhsu</span></div><div class="token-line"><span class="token plain">vagrant@swarm-worker1:~$ docker container exec -it cac sh</span></div><div class="token-line"><span class="token plain">/ # ip a</span></div><div class="token-line"><span class="token plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000</span></div><div class="token-line"><span class="token plain">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></div><div class="token-line"><span class="token plain">    inet 127.0.0.1/8 scope host lo</span></div><div class="token-line"><span class="token plain">    valid_lft forever preferred_lft forever</span></div><div class="token-line"><span class="token plain">24: eth0@if25: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1450 qdisc noqueue</span></div><div class="token-line"><span class="token plain">    link/ether 02:42:0a:00:01:08 brd ff:ff:ff:ff:ff:ff</span></div><div class="token-line"><span class="token plain">    inet 10.0.1.8/24 brd 10.0.1.255 scope global eth0</span></div><div class="token-line"><span class="token plain">    valid_lft forever preferred_lft forever</span></div><div class="token-line"><span class="token plain">26: eth1@if27: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue</span></div><div class="token-line"><span class="token plain">    link/ether 02:42:ac:12:00:03 brd ff:ff:ff:ff:ff:ff</span></div><div class="token-line"><span class="token plain">    inet 172.18.0.3/16 brd 172.18.255.255 scope global eth1</span></div><div class="token-line"><span class="token plain">    valid_lft forever preferred_lft forever</span></div><div class="token-line"><span class="token plain">/ #</span></div></pre></div><p>这个容器有两个接口 eth0和eth1， 其中eth0是连到了mynet这个网络，eth1是连到docker_gwbridge这个网络</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-worker1:~$ docker network ls</span></div><div class="token-line"><span class="token plain">NETWORK ID     NAME              DRIVER    SCOPE</span></div><div class="token-line"><span class="token plain">a631a4e0b63c   bridge            bridge    local</span></div><div class="token-line"><span class="token plain">56945463a582   docker_gwbridge   bridge    local</span></div><div class="token-line"><span class="token plain">9bdfcae84f94   host              host      local</span></div><div class="token-line"><span class="token plain">14fy2l7a4mci   ingress           overlay   swarm</span></div><div class="token-line"><span class="token plain">lpirdge00y3j   mynet             overlay   swarm</span></div><div class="token-line"><span class="token plain">c1837f1284f8   none              null      local</span></div></pre></div><p>在这个容器里是可以直接ping通worker2上容器的IP 10.0.1.9的</p><p><img src="http://wuxiao-tech-doc.oss-cn-hangzhou.aliyuncs.com/2021-12-26-035633.png" alt="docker-swarm-overlay"/></p><h2 id="85-swarm-的-ingress网络"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#85-swarm-的-ingress网络"><span class="icon icon-link"></span></a>8.5 Swarm 的 ingress网络</h2><p>docker swarm的ingress网络又叫 <code>Ingress Routing Mesh</code></p><p>主要是为了实现把service的服务端口对外发布出去，让其能够被外部网络访问到。</p><p>ingress routing mesh是docker swarm网络里最复杂的一部分内容，包括多方面的内容：</p><ul><li>iptables的 Destination NAT流量转发</li><li>Linux bridge, network namespace</li><li>使用IPVS技术做负载均衡</li><li>包括容器间的通信（overlay）和入方向流量的端口转发</li></ul><h3 id="service创建"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#service创建"><span class="icon icon-link"></span></a>service创建</h3><p>创建一个service，指定网络是overlay的mynet， 通过-p把端口映射出来</p><p>我们使用的镜像 <code>containous/whoami</code> 是一个简单的web服务，能返回服务器的hostname，和基本的网络信息，比如IP地址</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker service create --name web --network mynet -p 8080:80 --replicas 2 containous/whoami</span></div><div class="token-line"><span class="token plain">a9cn3p0ovg5jcz30rzz89lyfz</span></div><div class="token-line"><span class="token plain">overall progress: 2 out of 2 tasks</span></div><div class="token-line"><span class="token plain">1/2: running   [==================================================&gt;]</span></div><div class="token-line"><span class="token plain">2/2: running   [==================================================&gt;]</span></div><div class="token-line"><span class="token plain">verify: Service converged</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker service ls</span></div><div class="token-line"><span class="token plain">ID             NAME      MODE         REPLICAS   IMAGE                      PORTS</span></div><div class="token-line"><span class="token plain">a9cn3p0ovg5j   web       replicated   2/2        containous/whoami:latest   *:8080-&gt;80/tcp</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker service ps web</span></div><div class="token-line"><span class="token plain">ID             NAME      IMAGE                      NODE            DESIRED STATE   CURRENT STATE            ERROR     PORTS</span></div><div class="token-line"><span class="token plain">udlzvsraha1x   web.1     containous/whoami:latest   swarm-worker1   Running         Running 16 seconds ago</span></div><div class="token-line"><span class="token plain">mms2c65e5ygt   web.2     containous/whoami:latest   swarm-manager   Running         Running 16 seconds ago</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$</span></div></pre></div><h3 id="service的访问"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#service的访问"><span class="icon icon-link"></span></a>service的访问</h3><p>8080这个端口到底映射到哪里了？尝试三个swarm节点的IP加端口8080</p><p>可以看到三个节点IP都可以访问，并且回应的容器是不同的（hostname），也就是有负载均衡的效果</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ curl 192.168.200.10:8080</span></div><div class="token-line"><span class="token plain">Hostname: fdf7c1354507</span></div><div class="token-line"><span class="token plain">IP: 127.0.0.1</span></div><div class="token-line"><span class="token plain">IP: 10.0.0.7</span></div><div class="token-line"><span class="token plain">IP: 172.18.0.3</span></div><div class="token-line"><span class="token plain">IP: 10.0.1.14</span></div><div class="token-line"><span class="token plain">RemoteAddr: 10.0.0.2:36828</span></div><div class="token-line"><span class="token plain">GET / HTTP/1.1</span></div><div class="token-line"><span class="token plain">Host: 192.168.200.10:8080</span></div><div class="token-line"><span class="token plain">User-Agent: curl/7.68.0</span></div><div class="token-line"><span class="token plain">Accept: */*</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ curl 192.168.200.11:8080</span></div><div class="token-line"><span class="token plain">Hostname: fdf7c1354507</span></div><div class="token-line"><span class="token plain">IP: 127.0.0.1</span></div><div class="token-line"><span class="token plain">IP: 10.0.0.7</span></div><div class="token-line"><span class="token plain">IP: 172.18.0.3</span></div><div class="token-line"><span class="token plain">IP: 10.0.1.14</span></div><div class="token-line"><span class="token plain">RemoteAddr: 10.0.0.3:54212</span></div><div class="token-line"><span class="token plain">GET / HTTP/1.1</span></div><div class="token-line"><span class="token plain">Host: 192.168.200.11:8080</span></div><div class="token-line"><span class="token plain">User-Agent: curl/7.68.0</span></div><div class="token-line"><span class="token plain">Accept: */*</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ curl 192.168.200.12:8080</span></div><div class="token-line"><span class="token plain">Hostname: c83ee052787a</span></div><div class="token-line"><span class="token plain">IP: 127.0.0.1</span></div><div class="token-line"><span class="token plain">IP: 10.0.0.6</span></div><div class="token-line"><span class="token plain">IP: 172.18.0.3</span></div><div class="token-line"><span class="token plain">IP: 10.0.1.13</span></div><div class="token-line"><span class="token plain">RemoteAddr: 10.0.0.4:49820</span></div><div class="token-line"><span class="token plain">GET / HTTP/1.1</span></div><div class="token-line"><span class="token plain">Host: 192.168.200.12:8080</span></div><div class="token-line"><span class="token plain">User-Agent: curl/7.68.0</span></div><div class="token-line"><span class="token plain">Accept: */*</span></div></pre></div><p><img src="http://wuxiao-tech-doc.oss-cn-hangzhou.aliyuncs.com/2021-12-26-041801.png" alt="docker-swarm-ingress-logic"/></p><h3 id="ingress-数据包的走向"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#ingress-数据包的走向"><span class="icon icon-link"></span></a>ingress 数据包的走向</h3><p>以manager节点为例，数据到底是如何达到service的container的</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ sudo iptables -nvL -t nat</span></div><div class="token-line"><span class="token plain">Chain PREROUTING (policy ACCEPT 388 packets, 35780 bytes)</span></div><div class="token-line"><span class="token plain">pkts bytes target     prot opt in     out     source               destination</span></div><div class="token-line"><span class="token plain">296 17960 DOCKER-INGRESS  all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL</span></div><div class="token-line"><span class="token plain">21365 1282K DOCKER     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain INPUT (policy ACCEPT 388 packets, 35780 bytes)</span></div><div class="token-line"><span class="token plain">pkts bytes target     prot opt in     out     source               destination</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain OUTPUT (policy ACCEPT 340 packets, 20930 bytes)</span></div><div class="token-line"><span class="token plain">pkts bytes target     prot opt in     out     source               destination</span></div><div class="token-line"><span class="token plain">    8   590 DOCKER-INGRESS  all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL</span></div><div class="token-line"><span class="token plain">    1    60 DOCKER     all  --  *      *       0.0.0.0/0           !127.0.0.0/8          ADDRTYPE match dst-type LOCAL</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain POSTROUTING (policy ACCEPT 340 packets, 20930 bytes)</span></div><div class="token-line"><span class="token plain">pkts bytes target     prot opt in     out     source               destination</span></div><div class="token-line"><span class="token plain">    2   120 MASQUERADE  all  --  *      docker_gwbridge  0.0.0.0/0            0.0.0.0/0            ADDRTYPE match src-type LOCAL</span></div><div class="token-line"><span class="token plain">    3   252 MASQUERADE  all  --  *      !docker0  172.17.0.0/16        0.0.0.0/0</span></div><div class="token-line"><span class="token plain">    0     0 MASQUERADE  all  --  *      !docker_gwbridge  172.18.0.0/16        0.0.0.0/0</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain DOCKER (2 references)</span></div><div class="token-line"><span class="token plain">pkts bytes target     prot opt in     out     source               destination</span></div><div class="token-line"><span class="token plain">    0     0 RETURN     all  --  docker0 *       0.0.0.0/0            0.0.0.0/0</span></div><div class="token-line"><span class="token plain">    0     0 RETURN     all  --  docker_gwbridge *       0.0.0.0/0            0.0.0.0/0</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain DOCKER-INGRESS (2 references)</span></div><div class="token-line"><span class="token plain">pkts bytes target     prot opt in     out     source               destination</span></div><div class="token-line"><span class="token plain">    2   120 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:8080 to:172.18.0.2:8080</span></div><div class="token-line"><span class="token plain">302 18430 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0</span></div></pre></div><p>通过iptables，可以看到一条DNAT的规则，所有访问本地8080端口的流量都被转发到 172.18.0.2:8080</p><p>那这个172.18.0.2 是什么？</p><p>首先　172.18.0.0/16　这个网段是 <code>docker_gwbridge</code> 的，所以这个地址肯定是连在了 <code>docker_gwbridge</code> 上。</p><p><code>docker network inspect docker_gwbridge</code> 可以看到这个网络连接了一个叫　<code>ingress-sbox</code>　的容器。它的地址就是　172.18.0.2/16</p><p>这个　<code>ingress-sbox</code>　其实并不是一个容器，而是一个网络的命名空间　network namespace,　我们可以通过下面的方式进入到这个命名空间</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$　docker run -it --rm -v /var/run/docker/netns:/netns --privileged=true nicolaka/netshoot nsenter --net=/netns/ingress_sbox sh</span></div><div class="token-line"><span class="token plain">~ # ip a</span></div><div class="token-line"><span class="token plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span></div><div class="token-line"><span class="token plain">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></div><div class="token-line"><span class="token plain">    inet 127.0.0.1/8 scope host lo</span></div><div class="token-line"><span class="token plain">       valid_lft forever preferred_lft forever</span></div><div class="token-line"><span class="token plain">8: eth0@if9: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP group default</span></div><div class="token-line"><span class="token plain">    link/ether 02:42:0a:00:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span></div><div class="token-line"><span class="token plain">    inet 10.0.0.2/24 brd 10.0.0.255 scope global eth0</span></div><div class="token-line"><span class="token plain">       valid_lft forever preferred_lft forever</span></div><div class="token-line"><span class="token plain">    inet 10.0.0.5/32 scope global eth0</span></div><div class="token-line"><span class="token plain">       valid_lft forever preferred_lft forever</span></div><div class="token-line"><span class="token plain">10: eth1@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span></div><div class="token-line"><span class="token plain">    link/ether 02:42:ac:12:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 1</span></div><div class="token-line"><span class="token plain">    inet 172.18.0.2/16 brd 172.18.255.255 scope global eth1</span></div><div class="token-line"><span class="token plain">       valid_lft forever preferred_lft forever</span></div></pre></div><p>通过查看地址，发现这个命名空间连接了两个网络，一个eth1是连接了　<code>docker_gwbridge</code>　，另外一个eth0连接了　<code>ingress</code> 这个网络。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">~ # ip route</span></div><div class="token-line"><span class="token plain">default via 172.18.0.1 dev eth1</span></div><div class="token-line"><span class="token plain">10.0.0.0/24 dev eth0 proto kernel scope link src 10.0.0.2</span></div><div class="token-line"><span class="token plain">172.18.0.0/16 dev eth1 proto kernel scope link src 172.18.0.2</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">~ # iptables -nvL -t mangle</span></div><div class="token-line"><span class="token plain">Chain PREROUTING (policy ACCEPT 22 packets, 2084 bytes)</span></div><div class="token-line"><span class="token plain"> pkts bytes target     prot opt in     out     source               destination</span></div><div class="token-line"><span class="token plain">   12   806 MARK       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:8080 MARK set 0x100</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain INPUT (policy ACCEPT 14 packets, 1038 bytes)</span></div><div class="token-line"><span class="token plain"> pkts bytes target     prot opt in     out     source               destination</span></div><div class="token-line"><span class="token plain">    0     0 MARK       all  --  *      *       0.0.0.0/0            10.0.0.5             MARK set 0x100</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain FORWARD (policy ACCEPT 8 packets, 1046 bytes)</span></div><div class="token-line"><span class="token plain"> pkts bytes target     prot opt in     out     source               destination</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain OUTPUT (policy ACCEPT 14 packets, 940 bytes)</span></div><div class="token-line"><span class="token plain"> pkts bytes target     prot opt in     out     source               destination</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain POSTROUTING (policy ACCEPT 22 packets, 1986 bytes)</span></div><div class="token-line"><span class="token plain"> pkts bytes target     prot opt in     out     source               destination</span></div><div class="token-line"><span class="token plain">~ # ipvsadm</span></div><div class="token-line"><span class="token plain">IP Virtual Server version 1.2.1 (size=4096)</span></div><div class="token-line"><span class="token plain">Prot LocalAddress:Port Scheduler Flags</span></div><div class="token-line"><span class="token plain">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></div><div class="token-line"><span class="token plain">FWM  256 rr</span></div><div class="token-line"><span class="token plain">  -&gt; 10.0.0.6:0                   Masq    1      0          0</span></div><div class="token-line"><span class="token plain">  -&gt; 10.0.0.7:0                   Masq    1      0          0</span></div><div class="token-line"><span class="token plain">~ #</span></div></pre></div><p>通过ipvs做了负载均衡</p><p><img src="http://wuxiao-tech-doc.oss-cn-hangzhou.aliyuncs.com/2021-12-26-041931.png" alt="docker-swarm-routing-mesh"/></p><p>关于这里的负载均衡</p><ul><li>这是一个stateless load balancing</li><li>这是三层的负载均衡，不是四层的 LB is at OSI Layer 3 (TCP), not Layer 4 (DNS)</li><li>以上两个限制可以通过Nginx或者HAProxy LB proxy解决 （<a target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/engine/swarm/ingress/%EF%BC%89">https://docs.docker.com/engine/swarm/ingress/）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><h2 id="86-内部负载均衡和-vip"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#86-内部负载均衡和-vip"><span class="icon icon-link"></span></a>8.6 内部负载均衡和 VIP</h2><p>创建一个mynet的overlay网络，创建一个service</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker network ls</span></div><div class="token-line"><span class="token plain">NETWORK ID     NAME              DRIVER    SCOPE</span></div><div class="token-line"><span class="token plain">afc8f54c1d07   bridge            bridge    local</span></div><div class="token-line"><span class="token plain">128fd1cb0fae   docker_gwbridge   bridge    local</span></div><div class="token-line"><span class="token plain">0ea68b0d28b9   host              host      local</span></div><div class="token-line"><span class="token plain">14fy2l7a4mci   ingress           overlay   swarm</span></div><div class="token-line"><span class="token plain">lpirdge00y3j   mynet             overlay   swarm</span></div><div class="token-line"><span class="token plain">a8edf1804fb6   none              null      local</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker service create --name web --network mynet --replicas 2 containous/whoami</span></div><div class="token-line"><span class="token plain">jozc1x1c1zpyjl9b5j5abzm0g</span></div><div class="token-line"><span class="token plain">overall progress: 2 out of 2 tasks</span></div><div class="token-line"><span class="token plain">1/2: running   [==================================================&gt;]</span></div><div class="token-line"><span class="token plain">2/2: running   [==================================================&gt;]</span></div><div class="token-line"><span class="token plain">verify: Service converged</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker service ls</span></div><div class="token-line"><span class="token plain">ID             NAME      MODE         REPLICAS   IMAGE                      PORTS</span></div><div class="token-line"><span class="token plain">jozc1x1c1zpy   web       replicated   2/2        containous/whoami:latest</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker service ps web</span></div><div class="token-line"><span class="token plain">ID             NAME      IMAGE                      NODE            DESIRED STATE   CURRENT STATE            ERROR     PORTS</span></div><div class="token-line"><span class="token plain">pwi87g86kbxd   web.1     containous/whoami:latest   swarm-worker1   Running         Running 47 seconds ago</span></div><div class="token-line"><span class="token plain">xbri2akxy2e8   web.2     containous/whoami:latest   swarm-worker2   Running         Running 44 seconds ago</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$</span></div></pre></div><p>创建一个client</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker service create --name client --network mynet xiaopeng163/net-box:latest ping 8.8.8.8</span></div><div class="token-line"><span class="token plain">skbcdfvgidwafbm4nciq82env</span></div><div class="token-line"><span class="token plain">overall progress: 1 out of 1 tasks</span></div><div class="token-line"><span class="token plain">1/1: running   [==================================================&gt;]</span></div><div class="token-line"><span class="token plain">verify: Service converged</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker service ls</span></div><div class="token-line"><span class="token plain">ID             NAME      MODE         REPLICAS   IMAGE                        PORTS</span></div><div class="token-line"><span class="token plain">skbcdfvgidwa   client    replicated   1/1        xiaopeng163/net-box:latest</span></div><div class="token-line"><span class="token plain">jozc1x1c1zpy   web       replicated   2/2        containous/whoami:latest</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker service ps client</span></div><div class="token-line"><span class="token plain">ID             NAME       IMAGE                        NODE            DESIRED STATE   CURRENT STATE            ERROR     PORTS</span></div><div class="token-line"><span class="token plain">sg9b3dqrgru4   client.1   xiaopeng163/net-box:latest   swarm-manager   Running         Running 28 seconds ago</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$</span></div></pre></div><p>尝试进入client这个容器，去ping web这个service name， 获取到的IP 10.0.1.30，称之为VIP（虚拟IP）</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker container ls</span></div><div class="token-line"><span class="token plain">CONTAINER ID   IMAGE                        COMMAND          CREATED          STATUS          PORTS     NAMES</span></div><div class="token-line"><span class="token plain">36dce35d56e8   xiaopeng163/net-box:latest   &quot;ping 8.8.8.8&quot;   19 minutes ago   Up 19 minutes             client.1.sg9b3dqrgru4f14k2tpxzg2ei</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker container exec -it 36dc sh</span></div><div class="token-line"><span class="token plain">/omd # curl web</span></div><div class="token-line"><span class="token plain">Hostname: 6039865a1e5d</span></div><div class="token-line"><span class="token plain">IP: 127.0.0.1</span></div><div class="token-line"><span class="token plain">IP: 10.0.1.32</span></div><div class="token-line"><span class="token plain">IP: 172.18.0.3</span></div><div class="token-line"><span class="token plain">RemoteAddr: 10.0.1.37:40972</span></div><div class="token-line"><span class="token plain">GET / HTTP/1.1</span></div><div class="token-line"><span class="token plain">Host: web</span></div><div class="token-line"><span class="token plain">User-Agent: curl/7.69.1</span></div><div class="token-line"><span class="token plain">Accept: */*</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">/omd # curl web</span></div><div class="token-line"><span class="token plain">Hostname: c3b3e99b9bb1</span></div><div class="token-line"><span class="token plain">IP: 127.0.0.1</span></div><div class="token-line"><span class="token plain">IP: 10.0.1.31</span></div><div class="token-line"><span class="token plain">IP: 172.18.0.3</span></div><div class="token-line"><span class="token plain">RemoteAddr: 10.0.1.37:40974</span></div><div class="token-line"><span class="token plain">GET / HTTP/1.1</span></div><div class="token-line"><span class="token plain">Host: web</span></div><div class="token-line"><span class="token plain">User-Agent: curl/7.69.1</span></div><div class="token-line"><span class="token plain">Accept: */*</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">/omd # curl web</span></div><div class="token-line"><span class="token plain">Hostname: 6039865a1e5d</span></div><div class="token-line"><span class="token plain">IP: 127.0.0.1</span></div><div class="token-line"><span class="token plain">IP: 10.0.1.32</span></div><div class="token-line"><span class="token plain">IP: 172.18.0.3</span></div><div class="token-line"><span class="token plain">RemoteAddr: 10.0.1.37:40976</span></div><div class="token-line"><span class="token plain">GET / HTTP/1.1</span></div><div class="token-line"><span class="token plain">Host: web</span></div><div class="token-line"><span class="token plain">User-Agent: curl/7.69.1</span></div><div class="token-line"><span class="token plain">Accept: */*</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">/omd #</span></div><div class="token-line"><span class="token plain">/omd # ping web -c 2</span></div><div class="token-line"><span class="token plain">PING web (10.0.1.30): 56 data bytes</span></div><div class="token-line"><span class="token plain">64 bytes from 10.0.1.30: seq=0 ttl=64 time=0.044 ms</span></div><div class="token-line"><span class="token plain">64 bytes from 10.0.1.30: seq=1 ttl=64 time=0.071 ms</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">--- web ping statistics ---</span></div><div class="token-line"><span class="token plain">2 packets transmitted, 2 packets received, 0% packet loss</span></div><div class="token-line"><span class="token plain">round-trip min/avg/max = 0.044/0.057/0.071 ms</span></div><div class="token-line"><span class="token plain">/omd #</span></div></pre></div><p>这个虚拟IP在一个特殊的网络命令空间里，这个空间连接在我们的mynet这个overlay的网络上</p><p>通过 docker network inspect mynet 可以看到这个命名空间，叫lb-mynet</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&quot;Containers&quot;: {</span></div><div class="token-line"><span class="token plain">&quot;36dce35d56e87d43d08c5b9a94678fe789659cb3b1a5c9ddccd7de4b26e8d588&quot;: {</span></div><div class="token-line"><span class="token plain">    &quot;Name&quot;: &quot;client.1.sg9b3dqrgru4f14k2tpxzg2ei&quot;,</span></div><div class="token-line"><span class="token plain">    &quot;EndpointID&quot;: &quot;e8972d0091afaaa091886799aca164b742ca93408377d9ee599bdf91188416c1&quot;,</span></div><div class="token-line"><span class="token plain">    &quot;MacAddress&quot;: &quot;02:42:0a:00:01:24&quot;,</span></div><div class="token-line"><span class="token plain">    &quot;IPv4Address&quot;: &quot;10.0.1.36/24&quot;,</span></div><div class="token-line"><span class="token plain">    &quot;IPv6Address&quot;: &quot;&quot;</span></div><div class="token-line"><span class="token plain">},</span></div><div class="token-line"><span class="token plain">&quot;lb-mynet&quot;: {</span></div><div class="token-line"><span class="token plain">    &quot;Name&quot;: &quot;mynet-endpoint&quot;,</span></div><div class="token-line"><span class="token plain">    &quot;EndpointID&quot;: &quot;e299d083b25a1942f6e0f7989436c3c3e8d79c7395a80dd50b7709825022bfac&quot;,</span></div><div class="token-line"><span class="token plain">    &quot;MacAddress&quot;: &quot;02:42:0a:00:01:25&quot;,</span></div><div class="token-line"><span class="token plain">    &quot;IPv4Address&quot;: &quot;10.0.1.37/24&quot;,</span></div><div class="token-line"><span class="token plain">    &quot;IPv6Address&quot;: &quot;&quot;</span></div><div class="token-line"><span class="token plain">}</span></div></pre></div><p>通过下面的命令，找到这个命名空间的名字</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ sudo ls /var/run/docker/netns/</span></div><div class="token-line"><span class="token plain">1-14fy2l7a4m  1-lpirdge00y  dfb766d83076  ingress_sbox  lb_lpirdge00</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$</span></div></pre></div><p>名字叫 <code>lb_lpirdge00</code></p><p>通过nsenter进入到这个命名空间的sh里， 可以看到刚才的VIP地址10.0.1.30</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ sudo nsenter --net=/var/run/docker/netns/lb_lpirdge00 sh</span></div><div class="token-line"><span class="token plain">#</span></div><div class="token-line"><span class="token plain"># ip a</span></div><div class="token-line"><span class="token plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span></div><div class="token-line"><span class="token plain">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></div><div class="token-line"><span class="token plain">    inet 127.0.0.1/8 scope host lo</span></div><div class="token-line"><span class="token plain">    valid_lft forever preferred_lft forever</span></div><div class="token-line"><span class="token plain">50: eth0@if51: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP group default</span></div><div class="token-line"><span class="token plain">    link/ether 02:42:0a:00:01:25 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span></div><div class="token-line"><span class="token plain">    inet 10.0.1.37/24 brd 10.0.1.255 scope global eth0</span></div><div class="token-line"><span class="token plain">    valid_lft forever preferred_lft forever</span></div><div class="token-line"><span class="token plain">    inet 10.0.1.30/32 scope global eth0</span></div><div class="token-line"><span class="token plain">    valid_lft forever preferred_lft forever</span></div><div class="token-line"><span class="token plain">    inet 10.0.1.35/32 scope global eth0</span></div><div class="token-line"><span class="token plain">    valid_lft forever preferred_lft forever</span></div><div class="token-line"><span class="token plain">#</span></div></pre></div><p>和ingress网络一样，可以查看iptables，ipvs的负载均衡， 基本就可以理解负载均衡是怎么一回事了。 Mark=0x106, 也就是262（十进制），会轮询把请求发给10.0.1.31 和 10.0.1.32</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain"># iptables -nvL -t mangle</span></div><div class="token-line"><span class="token plain">Chain PREROUTING (policy ACCEPT 128 packets, 11198 bytes)</span></div><div class="token-line"><span class="token plain">pkts bytes target     prot opt in     out     source               destination</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain INPUT (policy ACCEPT 92 packets, 6743 bytes)</span></div><div class="token-line"><span class="token plain">pkts bytes target     prot opt in     out     source               destination</span></div><div class="token-line"><span class="token plain">72  4995 MARK       all  --  *      *       0.0.0.0/0            10.0.1.30            MARK set 0x106</span></div><div class="token-line"><span class="token plain">    0     0 MARK       all  --  *      *       0.0.0.0/0            10.0.1.35            MARK set 0x107</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain FORWARD (policy ACCEPT 36 packets, 4455 bytes)</span></div><div class="token-line"><span class="token plain">pkts bytes target     prot opt in     out     source               destination</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain OUTPUT (policy ACCEPT 101 packets, 7535 bytes)</span></div><div class="token-line"><span class="token plain">pkts bytes target     prot opt in     out     source               destination</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Chain POSTROUTING (policy ACCEPT 128 packets, 11198 bytes)</span></div><div class="token-line"><span class="token plain">pkts bytes target     prot opt in     out     source               destination</span></div><div class="token-line"><span class="token plain"># ipvsadm</span></div><div class="token-line"><span class="token plain">IP Virtual Server version 1.2.1 (size=4096)</span></div><div class="token-line"><span class="token plain">Prot LocalAddress:Port Scheduler Flags</span></div><div class="token-line"><span class="token plain">-&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></div><div class="token-line"><span class="token plain">FWM  262 rr</span></div><div class="token-line"><span class="token plain">-&gt; 10.0.1.31:0                  Masq    1      0          0</span></div><div class="token-line"><span class="token plain">-&gt; 10.0.1.32:0                  Masq    1      0          0</span></div><div class="token-line"><span class="token plain">FWM  263 rr</span></div><div class="token-line"><span class="token plain">-&gt; 10.0.1.36:0                  Masq    1      0          0</span></div><div class="token-line"><span class="token plain">#</span></div></pre></div><p>这个流量会走我们的mynet这个overlay网络。</p><h2 id="87-部署多-service-应用"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#87-部署多-service-应用"><span class="icon icon-link"></span></a>8.7 部署多 service 应用</h2><p>如何像docker-compose一样部署多服务应用，这一节我们先看手动的方式</p><p>本节课所用的源码文件 <a target="_blank" rel="noopener noreferrer" href="https://github.com/xiaopeng163/flask-redis">https://github.com/xiaopeng163/flask-redis<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>创建一个mynet的overlay网络</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker network ls</span></div><div class="token-line"><span class="token plain">NETWORK ID     NAME              DRIVER    SCOPE</span></div><div class="token-line"><span class="token plain">afc8f54c1d07   bridge            bridge    local</span></div><div class="token-line"><span class="token plain">128fd1cb0fae   docker_gwbridge   bridge    local</span></div><div class="token-line"><span class="token plain">0ea68b0d28b9   host              host      local</span></div><div class="token-line"><span class="token plain">14fy2l7a4mci   ingress           overlay   swarm</span></div><div class="token-line"><span class="token plain">lpirdge00y3j   mynet             overlay   swarm</span></div><div class="token-line"><span class="token plain">a8edf1804fb6   none              null      local</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$</span></div></pre></div><p>创建一个redis的service</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker service create --network mynet --name redis redis:latest redis-server --requirepass ABC123</span></div><div class="token-line"><span class="token plain">qh3nfeth3wc7uoz9ozvzta5ea</span></div><div class="token-line"><span class="token plain">overall progress: 1 out of 1 tasks</span></div><div class="token-line"><span class="token plain">1/1: running   [==================================================&gt;]</span></div><div class="token-line"><span class="token plain">verify: Service converged</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker servce ls</span></div><div class="token-line"><span class="token plain">docker: &#x27;servce&#x27; is not a docker command.</span></div><div class="token-line"><span class="token plain">See &#x27;docker --help&#x27;</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker service ls</span></div><div class="token-line"><span class="token plain">ID             NAME      MODE         REPLICAS   IMAGE          PORTS</span></div><div class="token-line"><span class="token plain">qh3nfeth3wc7   redis     replicated   1/1        redis:latest</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker service ps redis</span></div><div class="token-line"><span class="token plain">ID             NAME      IMAGE          NODE            DESIRED STATE   CURRENT STATE            ERROR     PORTS</span></div><div class="token-line"><span class="token plain">111cpkjn4a0k   redis.1   redis:latest   swarm-worker2   Running         Running 19 seconds ago</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$</span></div></pre></div><p>创建一个flask的service</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker service create --network mynet --name flask --env REDIS_HOST=redis --env REDIS_PASS=ABC123 -p 8080</span></div><div class="token-line"><span class="token plain">:5000 xiaopeng163/flask-redis:latest</span></div><div class="token-line"><span class="token plain">y7garhvlxah592j5lmqv8a3xj</span></div><div class="token-line"><span class="token plain">overall progress: 1 out of 1 tasks</span></div><div class="token-line"><span class="token plain">1/1: running   [==================================================&gt;]</span></div><div class="token-line"><span class="token plain">verify: Service converged</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker service ls</span></div><div class="token-line"><span class="token plain">ID             NAME      MODE         REPLICAS   IMAGE                            PORTS</span></div><div class="token-line"><span class="token plain">y7garhvlxah5   flask     replicated   1/1        xiaopeng163/flask-redis:latest   *:8080-&gt;5000/tcp</span></div><div class="token-line"><span class="token plain">qh3nfeth3wc7   redis     replicated   1/1        redis:latest</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker service ps flask</span></div><div class="token-line"><span class="token plain">ID             NAME      IMAGE                            NODE            DESIRED STATE   CURRENT STATE            ERROR     PORTS</span></div><div class="token-line"><span class="token plain">quptcq7vb48w   flask.1   xiaopeng163/flask-redis:latest   swarm-worker1   Running         Running 15 seconds ago</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ curl 127.0.0.1:8080</span></div><div class="token-line"><span class="token plain">Hello Container World! I have been seen 1 times and my hostname is d4de54036614.</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ curl 127.0.0.1:8080</span></div><div class="token-line"><span class="token plain">Hello Container World! I have been seen 2 times and my hostname is d4de54036614.</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ curl 127.0.0.1:8080</span></div><div class="token-line"><span class="token plain">Hello Container World! I have been seen 3 times and my hostname is d4de54036614.</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ curl 127.0.0.1:8080</span></div><div class="token-line"><span class="token plain">Hello Container World! I have been seen 4 times and my hostname is d4de54036614.</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$</span></div></pre></div><h2 id="88-swarm-stack-部署多-service-应用"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#88-swarm-stack-部署多-service-应用"><span class="icon icon-link"></span></a>8.8 swarm stack 部署多 service 应用</h2><p>先在swarm manager节点上安装一下 docker-compose</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ sudo chmod +x /usr/local/bin/docker-compose</span></div></pre></div><p>clone我们的代码仓库</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ git clone https://github.com/xiaopeng163/flask-redis</span></div><div class="token-line"><span class="token plain">Cloning into &#x27;flask-redis&#x27;...</span></div><div class="token-line"><span class="token plain">remote: Enumerating objects: 22, done.</span></div><div class="token-line"><span class="token plain">remote: Counting objects: 100% (22/22), done.</span></div><div class="token-line"><span class="token plain">remote: Compressing objects: 100% (19/19), done.</span></div><div class="token-line"><span class="token plain">remote: Total 22 (delta 9), reused 7 (delta 2), pack-reused 0</span></div><div class="token-line"><span class="token plain">Unpacking objects: 100% (22/22), 8.60 KiB | 1.07 MiB/s, done.</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ cd flask-redis</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~/flask-redis$ ls</span></div><div class="token-line"><span class="token plain">Dockerfile  LICENSE  README.md  app.py  docker-compose.yml</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~/flask-redis$</span></div></pre></div><p>环境清理</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~/flask-redis$ docker system prune -a -f</span></div></pre></div><p>镜像构建和提交， 如果你想做这一步，可以把docker-compose.yml里的 <code>xiaopeng163/flask-redis</code> 改成你的dockerhub id</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~/flask-redis$ docker-compose build</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~/flask-redis$ docker image ls</span></div><div class="token-line"><span class="token plain">REPOSITORY                TAG          IMAGE ID       CREATED         SIZE</span></div><div class="token-line"><span class="token plain">xiaopeng163/flask-redis   latest       5efb4fcbcfc3   6 seconds ago   126MB</span></div><div class="token-line"><span class="token plain">python                    3.9.5-slim   c71955050276   3 weeks ago     115MB</span></div></pre></div><p>提交镜像到dockerhub</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~/flask-redis$ docker login</span></div><div class="token-line"><span class="token plain">Login with your Docker ID to push and pull images from Docker Hub. If you don&#x27;t have a Docker ID, head over to https://hub.docker.com to create one.</span></div><div class="token-line"><span class="token plain">Username: xiaopeng163</span></div><div class="token-line"><span class="token plain">Password:</span></div><div class="token-line"><span class="token plain">WARNING! Your password will be stored unencrypted in /home/vagrant/.docker/config.json.</span></div><div class="token-line"><span class="token plain">Configure a credential helper to remove this warning. See</span></div><div class="token-line"><span class="token plain">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Login Succeeded</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~/flask-redis$ docker-compose push</span></div><div class="token-line"><span class="token plain">WARNING: The REDIS_PASSWORD variable is not set. Defaulting to a blank string.</span></div><div class="token-line"><span class="token plain">Pushing flask (xiaopeng163/flask-redis:latest)...</span></div><div class="token-line"><span class="token plain">The push refers to repository [docker.io/xiaopeng163/flask-redis]</span></div><div class="token-line"><span class="token plain">f447d33c161b: Pushed</span></div><div class="token-line"><span class="token plain">f7395da2fd9c: Pushed</span></div><div class="token-line"><span class="token plain">5b156295b5a3: Layer already exists</span></div><div class="token-line"><span class="token plain">115e0863702d: Layer already exists</span></div><div class="token-line"><span class="token plain">e10857b94a57: Layer already exists</span></div><div class="token-line"><span class="token plain">8d418cbfaf25: Layer already exists</span></div><div class="token-line"><span class="token plain">764055ebc9a7: Layer already exists</span></div><div class="token-line"><span class="token plain">latest: digest: sha256:c909100fda2f4160b593b4e0fb692b89046cebb909ae90546627deca9827b676 size: 1788</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~/flask-redis$</span></div></pre></div><p>通过stack启动服务</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~/flask-redis$ env REDIS_PASSWORD=ABC123 docker stack deploy --compose-file docker-compose.yml flask-demo</span></div><div class="token-line"><span class="token plain">Ignoring unsupported options: build</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">Creating network flask-demo_default</span></div><div class="token-line"><span class="token plain">Creating service flask-demo_flask</span></div><div class="token-line"><span class="token plain">Creating service flask-demo_redis-server</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~/flask-redis$</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~/flask-redis$ docker stack ls</span></div><div class="token-line"><span class="token plain">NAME         SERVICES   ORCHESTRATOR</span></div><div class="token-line"><span class="token plain">flask-demo   2          Swarm</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~/flask-redis$ docker stack ps flask-demo</span></div><div class="token-line"><span class="token plain">ID             NAME                        IMAGE                            NODE            DESIRED STATE   CURRENT STATE</span></div><div class="token-line"><span class="token plain">ERROR     PORTS</span></div><div class="token-line"><span class="token plain">lzm6i9inoa8e   flask-demo_flask.1          xiaopeng163/flask-redis:latest   swarm-manager   Running         Running 23 seconds ago</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">ejojb0o5lbu0   flask-demo_redis-server.1   redis:latest                     swarm-worker2   Running         Running 21 seconds ago</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~/flask-redis$ docker stack services flask-demo</span></div><div class="token-line"><span class="token plain">ID             NAME                      MODE         REPLICAS   IMAGE                            PORTS</span></div><div class="token-line"><span class="token plain">mpx75z1rrlwn   flask-demo_flask          replicated   1/1        xiaopeng163/flask-redis:latest   *:8080-&gt;5000/tcp</span></div><div class="token-line"><span class="token plain">z85n16zsldr1   flask-demo_redis-server   replicated   1/1        redis:latest</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~/flask-redis$ docker service ls</span></div><div class="token-line"><span class="token plain">ID             NAME                      MODE         REPLICAS   IMAGE                            PORTS</span></div><div class="token-line"><span class="token plain">mpx75z1rrlwn   flask-demo_flask          replicated   1/1        xiaopeng163/flask-redis:latest   *:8080-&gt;5000/tcp</span></div><div class="token-line"><span class="token plain">z85n16zsldr1   flask-demo_redis-server   replicated   1/1        redis:latest</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~/flask-redis$ curl 127.0.0.1:8080</span></div><div class="token-line"><span class="token plain">Hello Container World! I have been seen 1 times and my hostname is 21d63a8bfb57.</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~/flask-redis$ curl 127.0.0.1:8080</span></div><div class="token-line"><span class="token plain">Hello Container World! I have been seen 2 times and my hostname is 21d63a8bfb57.</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~/flask-redis$ curl 127.0.0.1:8080</span></div><div class="token-line"><span class="token plain">Hello Container World! I have been seen 3 times and my hostname is 21d63a8bfb57.</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~/flask-redis$</span></div></pre></div><h2 id="89-在-swarm-中使用-secret"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#89-在-swarm-中使用-secret"><span class="icon icon-link"></span></a>8.9 在 swarm 中使用 secret</h2><h3 id="创建secret"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#创建secret"><span class="icon icon-link"></span></a>创建secret</h3><p>有两种方式</p><h4 id="从标准的收入读取"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#从标准的收入读取"><span class="icon icon-link"></span></a>从标准的收入读取</h4><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ echo abc123 | docker secret create mysql_pass -</span></div><div class="token-line"><span class="token plain">4nkx3vpdd41tbvl9qs24j7m6w</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker secret ls</span></div><div class="token-line"><span class="token plain">ID                          NAME         DRIVER    CREATED         UPDATED</span></div><div class="token-line"><span class="token plain">4nkx3vpdd41tbvl9qs24j7m6w   mysql_pass             8 seconds ago   8 seconds ago</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker secret inspect mysql_pass</span></div><div class="token-line"><span class="token plain">[</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">        &quot;ID&quot;: &quot;4nkx3vpdd41tbvl9qs24j7m6w&quot;,</span></div><div class="token-line"><span class="token plain">        &quot;Version&quot;: {</span></div><div class="token-line"><span class="token plain">            &quot;Index&quot;: 4562</span></div><div class="token-line"><span class="token plain">        },</span></div><div class="token-line"><span class="token plain">        &quot;CreatedAt&quot;: &quot;2021-07-25T22:36:51.544523646Z&quot;,</span></div><div class="token-line"><span class="token plain">        &quot;UpdatedAt&quot;: &quot;2021-07-25T22:36:51.544523646Z&quot;,</span></div><div class="token-line"><span class="token plain">        &quot;Spec&quot;: {</span></div><div class="token-line"><span class="token plain">            &quot;Name&quot;: &quot;mysql_pass&quot;,</span></div><div class="token-line"><span class="token plain">            &quot;Labels&quot;: {}</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">]</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker secret rm mysql_pass</span></div><div class="token-line"><span class="token plain">mysql_pass</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$</span></div></pre></div><h4 id="从文件读取"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#从文件读取"><span class="icon icon-link"></span></a>从文件读取</h4><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ ls</span></div><div class="token-line"><span class="token plain">mysql_pass.txt</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ more mysql_pass.txt</span></div><div class="token-line"><span class="token plain">abc123</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker secret create mysql_pass mysql_pass.txt</span></div><div class="token-line"><span class="token plain">elsodoordd7zzpgsdlwgynq3f</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker secret inspect mysql_pass</span></div><div class="token-line"><span class="token plain">[</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">        &quot;ID&quot;: &quot;elsodoordd7zzpgsdlwgynq3f&quot;,</span></div><div class="token-line"><span class="token plain">        &quot;Version&quot;: {</span></div><div class="token-line"><span class="token plain">            &quot;Index&quot;: 4564</span></div><div class="token-line"><span class="token plain">        },</span></div><div class="token-line"><span class="token plain">        &quot;CreatedAt&quot;: &quot;2021-07-25T22:38:14.143954043Z&quot;,</span></div><div class="token-line"><span class="token plain">        &quot;UpdatedAt&quot;: &quot;2021-07-25T22:38:14.143954043Z&quot;,</span></div><div class="token-line"><span class="token plain">        &quot;Spec&quot;: {</span></div><div class="token-line"><span class="token plain">            &quot;Name&quot;: &quot;mysql_pass&quot;,</span></div><div class="token-line"><span class="token plain">            &quot;Labels&quot;: {}</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">]</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$</span></div></pre></div><h3 id="secret-的使用"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#secret-的使用"><span class="icon icon-link"></span></a>secret 的使用</h3><p>参考 <a target="_blank" rel="noopener noreferrer" href="https://hub.docker.com/_/mysql">https://hub.docker.com/_/mysql<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker service create --name mysql-demo --secret mysql_pass --env MYSQL_ROOT_PASSWORD_FILE=/run/secrets/mysql_pass mysql:5.7</span></div><div class="token-line"><span class="token plain">wb4z2ximgqaefephu9f4109c7</span></div><div class="token-line"><span class="token plain">overall progress: 1 out of 1 tasks</span></div><div class="token-line"><span class="token plain">1/1: running   [==================================================&gt;]</span></div><div class="token-line"><span class="token plain">verify: Service converged</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker service ls</span></div><div class="token-line"><span class="token plain">ID             NAME         MODE         REPLICAS   IMAGE       PORTS</span></div><div class="token-line"><span class="token plain">wb4z2ximgqae   mysql-demo   replicated   1/1        mysql:5.7</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ docker service ps mysql-demo</span></div><div class="token-line"><span class="token plain">ID             NAME           IMAGE       NODE            DESIRED STATE   CURRENT STATE            ERROR     PORTS</span></div><div class="token-line"><span class="token plain">909429p4uovy   mysql-demo.1   mysql:5.7   swarm-worker2   Running         Running 32 seconds ago</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$</span></div></pre></div><h2 id="810-swarm-使用-local-volume"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#810-swarm-使用-local-volume"><span class="icon icon-link"></span></a>8.10 swarm 使用 local volume</h2><p>本节源码，两个文件</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">docker-compose.yml</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">version: &quot;3.8&quot;</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">services:</span></div><div class="token-line"><span class="token plain">  db:</span></div><div class="token-line"><span class="token plain">    image: mysql:5.7</span></div><div class="token-line"><span class="token plain">    environment:</span></div><div class="token-line"><span class="token plain">      - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/mysql_pass</span></div><div class="token-line"><span class="token plain">    secrets:</span></div><div class="token-line"><span class="token plain">      - mysql_pass</span></div><div class="token-line"><span class="token plain">    volumes:</span></div><div class="token-line"><span class="token plain">      - data:/var/lib/mysql</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">volumes:</span></div><div class="token-line"><span class="token plain">  data:</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">secrets:</span></div><div class="token-line"><span class="token plain">  mysql_pass:</span></div><div class="token-line"><span class="token plain">    file: mysql_pass.txt</span></div></pre></div><p><code>mysql_pass.txt</code></p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$ more mysql_pass.txt</span></div><div class="token-line"><span class="token plain">abc123</span></div><div class="token-line"><span class="token plain">vagrant@swarm-manager:~$</span></div></pre></div><h1 id="9-docker-vs-podman"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#9-docker-vs-podman"><span class="icon icon-link"></span></a>9 Docker vs Podman</h1><h2 id="91-podman-介绍"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#91-podman-介绍"><span class="icon icon-link"></span></a>9.1 Podman 介绍</h2><h3 id="what-is-podman"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#what-is-podman"><span class="icon icon-link"></span></a>What is Podman?</h3><p><code>Podman</code> 是一个基于 <code>Linux</code> 系统的 <code>daemon-less</code> 的容器引擎。 可以用来开发，管理和运行 <code>OCI</code> 标准的容器. podman可以运行在root或者非root用户模式。</p><p>Podman 是 Red Hat 在2018年推出的，源代码开放。</p><p>官方网站 <a target="_blank" rel="noopener noreferrer" href="https://podman.io/">https://podman.io/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>OCI <a target="_blank" rel="noopener noreferrer" href="https://opencontainers.org/">https://opencontainers.org/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h2 id="92-和-docker-的区别"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#92-和-docker-的区别"><span class="icon icon-link"></span></a>9.2 和 docker 的区别</h2><ul><li>最主要的区别是podman是Daemonless的，而Docker在执行任务的时候，必须依赖于后台的docker daemon</li><li>podman不需要使用root用户或者root权限，所以更安全。</li><li>podman可以创建pod，pod的概念和Kubernetes 里定义的pod类似</li><li>podman运行把镜像和容器存储在不同的地方，但是docker必须存储在docker engineer所在的本地</li><li>podman是传统的fork-exec 模式，而docker是 client-server 架构</li></ul><p>Docker架构</p><p><img src="http://wuxiao-tech-doc.oss-cn-hangzhou.aliyuncs.com/2021-12-26-064321.png" alt="podman-vs-docker-1"/></p><p>Podman架构</p><p><img src="http://wuxiao-tech-doc.oss-cn-hangzhou.aliyuncs.com/2021-12-26-064440.png" alt="podman-vs-docker-2"/></p><h2 id="92-podman-安装"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#92-podman-安装"><span class="icon icon-link"></span></a>9.2 Podman 安装</h2><p>文档</p><p><a target="_blank" rel="noopener noreferrer" href="https://podman.io/getting-started/installation">https://podman.io/getting-started/installation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h2 id="93-podman-创建-pod"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#93-podman-创建-pod"><span class="icon icon-link"></span></a>9.3 Podman 创建 Pod</h2><h2 id="94-docker-的非-root-模式"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#94-docker-的非-root-模式"><span class="icon icon-link"></span></a>9.4 Docker 的非 root 模式</h2><p>文档 <a target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/engine/security/rootless/">https://docs.docker.com/engine/security/rootless/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>rootless在使用之前需要</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable">DOCKER_HOST</span><span class="token operator">=</span><span class="token plain">unix:///run/user/1000/docker.sock</span></div></pre></div><h1 id="10-docker的多架构支持"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#10-docker的多架构支持"><span class="icon icon-link"></span></a>10 Docker的多架构支持</h1><h2 id="101-docker的多架构支持"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#101-docker的多架构支持"><span class="icon icon-link"></span></a>10.1 Docker的多架构支持</h2><p><img src="http://wuxiao-tech-doc.oss-cn-hangzhou.aliyuncs.com/2021-12-26-072238.png" alt="docker-arch-intro"/></p><p>镜像</p><p><img src="http://wuxiao-tech-doc.oss-cn-hangzhou.aliyuncs.com/2021-12-26-072317.png" alt="image-arch"/></p><h2 id="102-使用-buildx-构建多架构镜像"><a aria-hidden="true" tabindex="-1" href="/simple-course/devops/02#102-使用-buildx-构建多架构镜像"><span class="icon icon-link"></span></a>10.2 使用 buildx 构建多架构镜像</h2><p>Windows和Mac的桌面版Docker自带buildx命令，但是Linux环境下的Docker需要自行安装buildx （<a target="_blank" rel="noopener noreferrer" href="https://github.com/docker/buildx%EF%BC%89">https://github.com/docker/buildx）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p><a target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/buildx/working-with-buildx/">https://docs.docker.com/buildx/working-with-buildx/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>本节课使用的源码 <a target="_blank" rel="noopener noreferrer" href="https://github.com/xiaopeng163/flask-redis">https://github.com/xiaopeng163/flask-redis<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>登录dockerhub</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">docker login</span></div></pre></div><p>进入源码目录（Dockerfile所在目录）</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">git clone https://github.com/xiaopeng163/flask-redis</span></div><div class="token-line"><span class="token plain">cd flask-redis</span></div></pre></div><p>构建</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">PS C:\Users\Peng Xiao\flask-redis&gt; docker login</span></div><div class="token-line"><span class="token plain">Authenticating with existing credentials...</span></div><div class="token-line"><span class="token plain">Login Succeeded</span></div><div class="token-line"><span class="token plain">PS C:\Users\Peng Xiao\flask-redis&gt; docker buildx build --push --platform linux/arm/v7,linux/arm64/v8,linux/amd64 -t xiaopeng163/flask-redis:latest .</span></div><div class="token-line"><span class="token plain">[+] Building 0.0s (0/0)</span></div><div class="token-line"><span class="token plain">error: multiple platforms feature is currently not supported for docker driver. Please switch to a different driver (eg. &quot;docker buildx create --use&quot;)</span></div><div class="token-line"><span class="token plain">PS C:\Users\Peng Xiao\flask-redis&gt;</span></div><div class="token-line"><span class="token plain">PS C:\Users\Peng Xiao\flask-redis&gt; docker buildx ls</span></div><div class="token-line"><span class="token plain">NAME/NODE       DRIVER/ENDPOINT STATUS  PLATFORMS</span></div><div class="token-line"><span class="token plain">desktop-linux   docker</span></div><div class="token-line"><span class="token plain">desktop-linux desktop-linux   running linux/amd64, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/386, linux/arm/v7, linux/arm/v6</span></div><div class="token-line"><span class="token plain">default *       docker</span></div><div class="token-line"><span class="token plain">default       default         running linux/amd64, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/386, linux/arm/v7, linux/arm/v6</span></div><div class="token-line"><span class="token plain">PS C:\Users\Peng Xiao\flask-redis&gt; docker buildx create --name mybuilder --use</span></div><div class="token-line"><span class="token plain">mybuilder</span></div><div class="token-line"><span class="token plain">PS C:\Users\Peng Xiao\flask-redis&gt; docker buildx ls</span></div><div class="token-line"><span class="token plain">NAME/NODE       DRIVER/ENDPOINT                STATUS   PLATFORMS</span></div><div class="token-line"><span class="token plain">mybuilder *     docker-container</span></div><div class="token-line"><span class="token plain">mybuilder0    npipe:////./pipe/docker_engine inactive</span></div><div class="token-line"><span class="token plain">desktop-linux   docker</span></div><div class="token-line"><span class="token plain">desktop-linux desktop-linux                  running  linux/amd64, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/386, linux/arm/v7, linux/arm/v6</span></div><div class="token-line"><span class="token plain">default         docker</span></div><div class="token-line"><span class="token plain">default       default                        running  linux/amd64, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/386, linux/arm/v7, linux/arm/v6</span></div><div class="token-line"><span class="token plain">PS C:\Users\Peng Xiao\flask-redis&gt; docker buildx build --push --platform linux/arm/v7,linux/arm64/v8,linux/amd64 -t xiaopeng163/flask-redis:latest .</span></div></pre></div></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/weisuoke/awesome-fe/edit/master/docs/simple-course/devops/02.Docker入门.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last update: ">5/21/2023 15:56:49</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/umi.js"></script>
    <script src="/docs__simple-course__devops__02.Docker入门.md.js"></script>
  </body>
</html>
